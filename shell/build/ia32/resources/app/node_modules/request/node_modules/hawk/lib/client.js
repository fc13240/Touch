var Url=require("url"),Hoek=require("hoek"),Cryptiles=require("cryptiles"),Crypto=require("./crypto"),Utils=require("./utils"),internals={};exports.header=function(t,e,r){var a={field:"",artifacts:{}};if(!t||"string"!=typeof t&&"object"!=typeof t||!e||"string"!=typeof e||!r||"object"!=typeof r)return a.err="Invalid argument type",a;var o=r.timestamp||Utils.nowSecs(r.localtimeOffsetMsec),i=r.credentials;if(!(i&&i.id&&i.key&&i.algorithm))return a.err="Invalid credential object",a;if(-1===Crypto.algorithms.indexOf(i.algorithm))return a.err="Unknown algorithm",a;"string"==typeof t&&(t=Url.parse(t));var n={ts:o,nonce:r.nonce||Cryptiles.randomString(6),method:e,resource:t.pathname+(t.search||""),host:t.hostname,port:t.port||("http:"===t.protocol?80:443),hash:r.hash,ext:r.ext,app:r.app,dlg:r.dlg};a.artifacts=n,n.hash||!r.payload&&""!==r.payload||(n.hash=Crypto.calculatePayloadHash(r.payload,i.algorithm,r.contentType));var s=Crypto.calculateMac("header",i,n),l=null!==n.ext&&void 0!==n.ext&&""!==n.ext,c='Hawk id="'+i.id+'", ts="'+n.ts+'", nonce="'+n.nonce+(n.hash?'", hash="'+n.hash:"")+(l?'", ext="'+Hoek.escapeHeaderAttribute(n.ext):"")+'", mac="'+s+'"';return n.app&&(c+=', app="'+n.app+(n.dlg?'", dlg="'+n.dlg:"")+'"'),a.field=c,a},exports.authenticate=function(t,e,r,a){if(r=Hoek.clone(r),a=a||{},t.headers["www-authenticate"]){var o=Utils.parseAuthorizationHeader(t.headers["www-authenticate"],["ts","tsm","error"]);if(o instanceof Error)return!1;if(o.ts){var i=Crypto.calculateTsMac(o.ts,e);if(i!==o.tsm)return!1}}if(!t.headers["server-authorization"]&&!a.required)return!0;var n=Utils.parseAuthorizationHeader(t.headers["server-authorization"],["mac","ext","hash"]);if(n instanceof Error)return!1;r.ext=n.ext,r.hash=n.hash;var s=Crypto.calculateMac("response",e,r);if(s!==n.mac)return!1;if(!a.payload&&""!==a.payload)return!0;if(!n.hash)return!1;var l=Crypto.calculatePayloadHash(a.payload,e.algorithm,t.headers["content-type"]);return l===n.hash},exports.getBewit=function(t,e){if(!t||"string"!=typeof t&&"object"!=typeof t||!e||"object"!=typeof e||!e.ttlSec)return"";e.ext=null===e.ext||void 0===e.ext?"":e.ext;var r=Utils.now(e.localtimeOffsetMsec),a=e.credentials;if(!(a&&a.id&&a.key&&a.algorithm))return"";if(-1===Crypto.algorithms.indexOf(a.algorithm))return"";"string"==typeof t&&(t=Url.parse(t));var o=Math.floor(r/1e3)+e.ttlSec,i=Crypto.calculateMac("bewit",a,{ts:o,nonce:"",method:"GET",resource:t.pathname+(t.search||""),host:t.hostname,port:t.port||("http:"===t.protocol?80:443),ext:e.ext}),n=a.id+"\\"+o+"\\"+i+"\\"+e.ext;return Hoek.base64urlEncode(n)},exports.message=function(t,e,r,a){if(!t||"string"!=typeof t||!e||"number"!=typeof e||null===r||void 0===r||"string"!=typeof r||!a||"object"!=typeof a)return null;var o=a.timestamp||Utils.nowSecs(a.localtimeOffsetMsec),i=a.credentials;if(!(i&&i.id&&i.key&&i.algorithm))return null;if(-1===Crypto.algorithms.indexOf(i.algorithm))return null;var n={ts:o,nonce:a.nonce||Cryptiles.randomString(6),host:t,port:e,hash:Crypto.calculatePayloadHash(r,i.algorithm)},s={id:i.id,ts:n.ts,nonce:n.nonce,hash:n.hash,mac:Crypto.calculateMac("message",i,n)};return s};