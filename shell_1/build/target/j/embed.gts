W.define("prototypes",[],function(){Array.prototype.getNextItem=function(t,e){var n=this.indexOf(t);return e&&n<this.length-1?n++:!e&&n>0&&n--,this[n]},Array.prototype.cycleItems=function(t,e){var n=this.indexOf(t)+(e?1:-1);return n===this.length?n=0:0>n&&(n=this.length-1),this[n]},Date.prototype.add=function(t,e){var n=new Date(this.getTime());return n.setTime(this.getTime()+("days"===e?24:1)*t*60*60*1e3),n},Date.prototype.toUTCPath=function(){return this.toISOString().replace(/^(\d+)-(\d+)-(\d+)T(\d+):.*$/,"$1/$2/$3/$4")},String.prototype.trunc=function(t){return this.length>t?this.substr(0,t-1)+"&hellip;":this},Date.prototype.midnight=function(){return this.setHours(0),this.setMinutes(0),this.setSeconds(0),this.setMilliseconds(0),this},Number.prototype.pad=function(t){for(var e=String(this);e.length<(t||2);)e="0"+e;return e},Number.prototype.format=function(t){return this.toFixed(t||0).replace(/(\d)(?=(\d{3})+\.?)/g,"$1 ")},String.prototype.firstCapital=function(){return this.charAt(0).toUpperCase()+this.slice(1).toLowerCase()},Number.prototype.bound=function(t,e){return Math.max(Math.min(this,e),t)},Math.deg2rad=function(t){return t/180*Math.PI},String.prototype.template=function(t){return this.replace(/\{(.+?)\}/g,function(e,n){return t[n]||""})},String.prototype.template2=function(t){return this.replace(/\{\{(.+?)\}\}/g,function(e,n){return t[n]||""})}}),W.define("http",["lruCache"],function(lruCache){var httpCache=new lruCache(50),http={};return http.get=function(url,options){var wasCancelled=!1,data,headers={},options=options||{},match,rqst,returnObject,cacheHit,cache,promise;return cache="undefined"==typeof options.cache||"boolean"==typeof options.cache&&options.cache?httpCache:"object"==typeof options.cache?options.cache:null,url=encodeURI(url),cache&&(cacheHit=cache.get(url))?Promise.resolve(cacheHit):(rqst=new XMLHttpRequest,rqst.open("get",url,!0),options.responseType&&(rqst.responseType=options.responseType),promise=new Promise(function(resolve,reject){rqst.onreadystatechange=function(){if(4===rqst.readyState)if(options.parseHeaders&&rqst.getAllResponseHeaders().split(/\n/).forEach(function(t){(match=t.match(/(.*:?)\: (.*)/))&&(headers[match[1].toLowerCase()]=match[2])}),rqst.status>=200&&rqst.status<300||304===rqst.status){if(data=rqst.responseText,data&&/json/.test(rqst.getResponseHeader("Content-Type")))try{data=JSON.parse(data)}catch(e){try{eval("data = "+data)}catch(e){}}returnObject={data:data,headers:headers,status:rqst.status},cache&&cache.put(url,returnObject),resolve(returnObject)}else wasCancelled?reject("cancelled"):options.substituteData?resolve({data:options.substituteData,headers:headers,status:rqst.status}):reject(rqst.status)}}),promise.cancel=function(){wasCancelled=!0,rqst.abort()},rqst.send(null),promise)},http}),W.define("storage",["rootScope","http","log"],function(t,e,n){var i=!0,a={};try{window.localStorage.test=2}catch(o){i=!1,n.event("localStorage not supported")}return{put:function(t,e){try{i?window.localStorage.setItem(t,JSON.stringify(e)):a[t]=e}catch(o){n.event("Error writing to localStorage:"+o)}},get:function(t){try{return i?JSON.parse(window.localStorage.getItem(t)):a[t]}catch(e){}},getFile:function(n,i){var a=this,o=this.get(n);return o&&o.version===t.version&&(!i||o.data&&o.data[i])?Promise.resolve(o.data):new Promise(function(i,o){var s="/v"+t.version+"/"+n,s="./"+n;e.get(s).then(function(e){e.version=t.version,a.put(n,e),i(e.data)},function(t){o(t)})})}}}),W.define("broadcast",["Evented"],function(t){return t.extend({})}),W.define("lruCache",[],function(){function t(t){this.size=0,this.limit=t,this._keymap={}}return t.prototype.put=function(t,e){var n={key:t,value:e};return this._keymap[t]=n,this.tail?(this.tail.newer=n,n.older=this.tail):this.head=n,this.tail=n,this.size===this.limit?this.shift():void this.size++},t.prototype.shift=function(){var t=this.head;return t&&(this.head.newer?(this.head=this.head.newer,this.head.older=void 0):this.head=void 0,t.newer=t.older=void 0,delete this._keymap[t.key]),t},t.prototype.get=function(t,e){var n=this._keymap[t];return void 0!==n?n===this.tail?e?n:n.value:(n.newer&&(n===this.head&&(this.head=n.newer),n.newer.older=n.older),n.older&&(n.older.newer=n.newer),n.newer=void 0,n.older=this.tail,this.tail&&(this.tail.newer=n),this.tail=n,e?n:n.value):void 0},t}),W.define("object",[],function(){var t={};return t.clone=function(e,n){var i;if(null===e||"object"!=typeof e)i=e;else if(e instanceof Date)i=new Date,i.setTime(e.getTime());else if(e instanceof Array){i=[];for(var a=0,o=e.length;o>a;a++)i[a]=t.clone(e[a])}else if(e instanceof Object){i={};for(var s in e)e.hasOwnProperty(s)&&(!n||n.indexOf(s)>-1)&&(i[s]=t.clone(e[s]))}else console.warn("Unable to copy obj! Its type isn't supported.");return i},t.signature=function(t){var e="";if(t instanceof Array)for(var n=0,i=t.length;i>n;n++)e+=t[n]&&t[n].toString();else if(t instanceof Object)for(var a in t)t.hasOwnProperty(a)&&(e+=t[a]&&t[a].toString());return e},t.extend=function(t){var e,n,i,a,o=Object.create(t);for(n=1,i=arguments.length;i>n;n++){a=arguments[n];for(e in a)o[e]=a[e]}return"function"==typeof o._init&&o._init(),o},t.include=function(t,e){for(var n in e)t[n]=e[n];return t},t.compare=function(t,e,n){return n.filter(function(n){return t[n]!==e[n]})},t}),W.define("Class",[],function(){var t={};return t.extend=function(){var t,e,n,i,a=Object.create(this);for(e=0,n=arguments.length;n>e;e++){i=arguments[e];for(t in i)a[t]=i[t]}return"function"==typeof a._init&&a._init(),a},t}),W.define("Evented",["Class"],function(t){return t.extend({_init:function(){this.id=0,this.cache={}},emit:function(t,e,n,i,a){var o,s,r;if(o=this.cache[t])for(s=o.length;s--;)r=o[s],r.callback.call(this,e,n,i,a),r.once&&this.off(r.id)},on:function(t,e,n){return this.cache[t]||(this.cache[t]=[]),this.cache[t].push({callback:e,id:++this.id,once:n||!1}),this.id},once:function(t,e){return this.on(t,e,!0)},off:function(t,e){var n,i;if("number"==typeof t){for(var a in this.cache)if(n=this.cache[a]){for(i=n.length;i--;)n[i].id===t&&n.splice(i,1);0===n.length&&delete this.cache[a]}}else{if((n=this.cache[t])&&(n=this.cache[t]))for(i=n.length;i--;)n[i].callback===e&&n.splice(i,1);0===n.length&&delete this.cache[t]}}})}),W.define("log",["broadcast","rootScope","object"],function(t,e,n){var i=["path","overlay","level","model"],a=n.clone(e,i),o={page:function(t){setTimeout(function(){window.ga&&ga("send","pageview",t)},100)},event:function(t){window.ga&&ga("send","event","info v"+e.version,t+" "+navigator.userAgent),console.log("Event triggered:"+t)}};return t.on("redrawFinished",function(t){if(!t.fromAnimation){var e=n.compare(t,a,i)[0],s=t[e];s&&("path"===e&&(s=s.replace(/\/\d\d$/,"")),o.page(e+"/"+s),a=n.clone(t,i))}}),t.on("mapChanged",function(t){o.page("map/"+t.source+"/"+t.zoom)}),t.on("popupOpened",function(t){o.page("picker/"+t)}),t.on("rqstOpen",function(t,e){o.page("detail"===t?e.icao?"detail/ad":"detail/spot":t)}),t.on("log",o.page),t.on("animationStarted",function(){o.page("animation/"+a.overlay)}),o}),W.define("helpers",[],function(){return{throttle:function(t,e){function n(){i=!1}var i=!1;return function(){i||(t(),i=!0,setTimeout(n,e))}},debounce:function(t,e,n){var i;return function(){var a=this,o=arguments,s=function(){i=null,n||t.apply(a,o)},r=n&&!i;clearTimeout(i),i=setTimeout(s,e),r&&t.apply(a,o)}}}}),"undefined"==typeof W&&(W={}),W.languages={en:{MON:"Monday",TUE:"Tuesday",WED:"Wednesday",THU:"Thursday",FRI:"Friday",SAT:"Saturday",SUN:"Sunday",TODAY:"Today",TOMORROW:"Tomorrow",YESTERDAY:"Yesterday",EARLIER:"Earlier",MON2:"Mon",TUE2:"Tue",WED2:"Wed",THU2:"Thu",FRI2:"Fri",SAT2:"Sat",SUN2:"Sun",TODAY2:"Today",TOMORROW2:"Tomor",MON01:"January",MON02:"February",MON03:"March",MON04:"April",MON05:"May",MON06:"June",MON07:"July",MON08:"August",MON09:"September",MON10:"October",MON11:"November",MON12:"December",WIFCST:"wind forecast",EMBED:"Embed Windyty on your page",MENU:"Menu",MENU_SETTINGS:"Settings",MENU_HELP:"Help",MENU_TOOLS:"Tools",MENU_CLOSE:"Close<br>menu",MENU_MAP:"Change background map",MENU_FB1:"Follow us on Facebook",MENU_FB2:"Share on Facebook",MENU_TW:"Share on Twitter",MENU_ABOUT:"About Windyty",MENU_FORUM:"Discussion forum",MENU_MAP2:"...in very detailed zoom levels",MENU_LOCATION:"Find my location",MENU_RETINA:"Enable retina",MENU_FULLSCREEN:"Fullscreen mode",MENU_3D:"Enable 3D mode",MENU_DISTANCE:"Distance measurement & planning",MENU_HISTORICAL:"Show historical data",MENU_LATLON:"Show lat, lon grid",MENU_W_STARTUP:"Show 7 day weather at startup",TOOLBOX_INFO:"info",TOOLBOX_ANIMATION:"animation",TOOLBOX_START:"Hide/show animated particles",MENU_F_MODEL:"Data",MENU_U_INTERVAL:"Update interval",MENU_D_UPDATED:"Updated",OVERLAY:"OVERLAY",WIND:"Wind",GUST:"Wind gusts",TEMP:"Temperature",PRESS:"Pressure",CLOUDS:"Clouds, rain",LCLOUDS:"Low clouds",RAIN:"Rain or snow",SNOW:"Snow",SHOW_GUST:"force of wind gusts",RH:"Humidity",WAVES:"Waves",WAVES2:"Waves, sea",SWELL:"Swell",WWAVES:"Wind waves",SWELLPER:"Sw. period",RACCU:"R. accumulation",RAINACCU:"RAIN ACCUMULATION",SNOWACCU:"SNOW ACCUMULATION",SNOWCOVER:"Actual Snow Cover",SST:"Surface sea temperature",SST2:"Sea temp.",SSTA:"Surface sea temperature anomaly",SSTA2:"Temp. anomaly",ACC_LAST_DAYS:"Last {{num}} days",ACC_LAST_HOURS:"Last {{num}} hours",ACC_NEXT_DAYS:"Next {{num}} days",ACC_NEXT_HOURS:"Next {{num}} hours",ALTITUDE:"ALTITUDE",SFC:"Surface",DATE_AND_TIME:"TIME",CLICK_ON_LEGEND:"Click to change metric",NEXT:"Next results...",LOW_PREDICT:"Low predictability of forecast",DAYS_AGO:"{{daysago}} days ago:",SHOW_ACTUAL:"Show actual forecast",DETAILED:"Detailed forecast for this location",PERIOD:"Period",DRAG_ME:"Drag me if you want",W_FORECAST_BY:"forecast by ",W_HOME:"set this as my start-up location",D_CLOSE:"Close<br>detail",D_SHOW_ON:"show on",D_GMAPS:"Google Maps",D_COURTESY:'More forecast products for this spot at <a href=" https://www.meteoblue.com/en/weather/latlon/call?lat={{lat}}&lon={{lon}}">Meteoblue.com</a>',D_FCST:"Forecast for this location",D_LT:"Local timezone",D_WEBCAMS:"Webcams in vicinity",D_NO_WEBCAMS:"There are no webcams around this location (or we don't know about them)",D_ACTUAL:"actual image",D_DAYLIGHT:"image during daylight",D_SHOW_ANIM:"Show 24h animation",D_EXTERNAL:"external link to lookr.com",D_DISTANCE:"distance",D_MILES:"miles",D_MORE_THAN_HOUR:"more than hour ago",D_MIN_AGO:"{{duration}} minutes ago",D_SUNRISE:"Sunrise",D_SUNSET:"sunset",D_DUSK:"dusk",D_SUN_NEVER_SET:"Sun never set",D_POLAR_NIGHT:"Polar night",D_LT2:"local time",D_FAVORITES:"Add to Favorites",D_FAVORITES2:"Remove from Favorites",D_MBLUE:"Meteogram",D_AIRGRAM3:"Airgram",D_WAVE_FCST:"Wind and Waves",D_SETTINGS:"settings",D_MISSING_CAM:"Add new webcam",D_SETTINGS_LEFT:"Left side",D_SETTINGS_RIGHT:"Right side",D_SETTINGS_TIME1:"Local time of your computer",D_SETTINGS_TIME2:"Local time of selected destination",D_SETTINGS_PROVIDER:"Provider",D_MISSING_CAM:"Add new webcam",E_MESSAGE:"Awesome weather forecast at",METAR_VAR:"Variable",METAR_MIN_AGO:"{DURATION}m ago",METAR_HOUR_AGO:"an hour ago",METAR_MORE_INFO:"more info",DEVELOPED:"Developed with",MESSAGE_NEMS4:"<span>Sweet!</span>Detailed 4x4km forecast model available for this area.",AMSL:"Height above main sea level"}},"object"==typeof module&&module.exports&&(module.exports=W.languages),W.supportedLanguages=["en","zh-TW","zh","ja","fr","de","pt","ko","it","ru","nl","cs","tr","pl","sv","fi","el","hu","da","ar","sk","uk","lt","sl","id","th","nb","es"],W.define("loaders",function(){}),W.define("location",["rootScope","overlays","calendar","prototypes"],function(t,e,n){t.embed=!0;var i,a=window.location.search.substring(1);if(/\S+/.test(a)){i=a.split(",");for(var o=0;o<i.length;o++){if(/^-?\d+\.\d+$/.test(i[o])&&/^-?\d+\.\d+$/.test(i[o+1])&&/^\d+$/.test(i[o+2])){var s=parseInt(i[o+2]);t.sharedCoords={lat:parseFloat(i[o]),lon:parseFloat(i[o+1])},s>100?t.sharedCoords.scale=s:t.sharedCoords.zoom=s,o+=2}var r=i[o];if(t.levels.indexOf(r)>-1&&(t.level=r),t.overlays.indexOf(r)>-1&&(t.overlay=r),t.acTimes.indexOf(r)>-1&&(t.acTime=r),/^(\d\d\d\d)-(\d\d)-(\d\d)-(\d\d)$/.test(r)&&(t.path=r.replace(/-/g,"/")),"menu"===r&&(t.menu=!0),"message"===r&&(t.message=!0),"ip"===r&&(t.sharedCoords=null),"marker"===r&&(t.marker=!0),"embedmake"===r&&(t.embedMake=!0),/metric/.test(r)){var l=r.match(/metric\.(.+)\.(.+)/);1===l[2].length&&(l[2]="\u63b3"+l[2]),e[l[1]].metric=l[2]}else if(/in:\d+/.test(r)){var l=r.match(/in:(\d+)/);t.nextHours=parseInt(l[1]);var c=n({}),d=new Date;d=d.add(t.nextHours),t.initialPath=c.time2path(d)}}}}),W.define("test",[],function(){console.log("test")});var dependencies=["prototypes","rootScope","broadcast","object","mapsCtrl","trans","broadcast","windytyUI","progressBar","calendar","http","jsonLoader","overlays","products","colors","legend","productInfo","loaders","windytyCtrl","picker","pickerGlobe"];dependencies=["windytyCtrl","test","typhoon","imgs","text"],EMBED_MODE=!0,document.addEventListener("DOMContentLoaded",W.require.bind(null,dependencies,function(){})),W.define("rootScope",[],function(){"undefined"==typeof API_MODE&&(API_MODE=!1),"undefined"==typeof EMBED_MODE&&(EMBED_MODE=!1);var t=window.navigator,e={server:"",server2:"",tileServer:"https://tiles{s}.windyty.com/tiles/",version:W.version,levels:["surface","975h","950h","925h","900h","850h","750h","700h","550h","450h","350h","300h","250h","200h","150h"],overlays:["wind","temp","pressure","clouds","rh","gust","snow","lclouds","rain","snowcover","waves","swell","wwaves","swellperiod","sst","sstanom"],acTimes:["past3d","past24h","next24h","next3d","next"],browser:L.Browser,isTouch:L.Browser.touch,isMobile:L.Browser.mobile||window.screen&&window.screen.width<801,maxZoom:EMBED_MODE||API_MODE?11:17,isRetina:L.Browser.retina,maxPixels:window.screen&&window.screen.width*window.screen.height||364e4,prefLang:t.languages?t.languages[0]:t.language||t.browserLanguage||t.systemLanguage||t.userLanguage||"en",overlay:"wind",level:"surface",acTime:"next24h",product:"gfs",model:"gfs",setLang:"en",hereMapsID:"app_id=8d70J5U3FIr56AaYUPtD&app_code=MqhlkYGq9_i_t4RIbeX3RQ"};return(API_MODE||EMBED_MODE)&&(e.server="https://www.windyty.com/",e.server2=""),e}),W.define("trans",["http","storage","broadcast","rootScope","log"],function(t,e,n,i,a){function o(t){for(var e in t)r[e]=t[e]}function s(t){var e=/(\w+)\|(\w+)\:(\w+)/;return/\|/.test(t)?t.replace(e,function(e,n,i,a){var o=r[n];return o&&a?o.replace(/\{\{[^\}]+\}\}/g,a):t}):r[t]||t}var r={},l="en",c=i.lang||i.prefLang;return r.translateDocument=function(t){["title","placeholder","t"].forEach(function(e){for(var n,i,a=t.querySelectorAll("[data-"+e+"]"),o=0,r=a.length;r>o;o++)n=a[o],i=s(n.dataset[e]),"t"===e?/</.test(i)?n.innerHTML=i:n.textContent=i:n[e]=i})},c&&W.supportedLanguages.indexOf(c)>-1?l=c:c&&(c=c.replace(/-\S+$/,""),l=W.supportedLanguages.indexOf(c)>-1?c:"en",c!==l&&a.page("langmissing/"+c)),o(W.languages.en),r.translateDocument(document.body),"en"!==l&&e.getFile("lang/lang-"+l+".json","TODAY").then(function(t){o(t),r.translateDocument(document.body),n.emit("langChanged",l),i.setLang=l}),r}),W.define("settings",["storage","broadcast","rootScope","geolocation"],function(t,e,n){var i={map:{def:"esritopo",allowed:["hereterrain","heresat","esritopo"]},retina:{def:!1,allowed:[!0,!1]},"3d":{def:!0,allowed:[!0,!1]},graticule:{def:!1,allowed:[!0,!1]},weather:{def:!0,allowed:[!0,!1]}},a=n.geoIP&&n.geoIP.country?n.geoIP.country:"other";return{defaults:/US|MY|LR/.test(a)?"imperial":"metric",set:function(n,a){var o=i[n];o&&o.allowed.indexOf(a)>-1&&(t.put("settings_"+n,a),e.emit("settingsChanged",n,a))},get:function(e){var n=i[e],a=t.get("settings_"+e);return n&&n.allowed.indexOf(a)>-1?a:n?n.def:null},getHoursFunction:function(){return/US|UK|PH|CA|AU|NZ|IN|EG|SA|CO|PK|MY/.test(a)?function(t){return(t+11)%12+1+(t>=12?" PM":" AM")}:function(t){return t+":00"}}}}),W.define("calendar",["prototypes","settings","object","log","trans"],function(t,e,n,i,a){function o(t){this.step=t.step||3,this.offset=t.offset||0,this.calendarDays=t.calendarDays||14,this.numOfDays=t.numOfDays||14,this.maxIndex=this.numOfDays/this.calendarDays,this.midnight=(new Date).midnight(),this.startOfTimeline=t.startOfTimeline||this.midnight.add(-24),this.days=[],this.dayHours={},this.sequence=0,this.numberOfHours=24*this.numOfDays,this.actualNumberOfHours=this.numberOfHours,this.endOftimeline=this.startOfTimeline.add(this.numOfDays,"days"),this.endOfcalendar=this.startOfTimeline.add(this.calendarDays,"days"),this.weekdaysUsed=this.calendarDays<8?s:r,this.type=this.endOfcalendar<this.midnight?"historical":this.startOfTimeline<this.midnight?"mixed":"forecast";for(var e,n,i,a=this.midnight.add(-12).getTime(),o=this.startOfTimeline.add(12),l=this.midnight.add(12).getTime(),c=this.midnight.add(36).getTime(),d=0;d<this.calendarDays;d++)e=o.add(d,"days"),n=e.getTime(),i=e.getDay(),this.days[d]=n===l?{display:"TODAY",displayLong:"TODAY",day:"",index:this.day2index(d),clickable:!0}:n===c?{display:"TOMORROW",displayLong:"TOMORROW",day:"",index:this.day2index(d),clickable:!0}:n===a?{display:"YESTERDAY",displayLong:"YESTERDAY",day:"",index:this.day2index(d),clickable:!0}:{display:"historical"===this.type?null:this.weekdaysUsed[i],displayLong:s[i],day:e.getDate(),index:this.day2index(d),clickable:d<this.numOfDays,month:e.getMonth()+1,year:e.getFullYear()};return t.minifest?this.createDayHoursFromMinifest(t.minifest):this.createDayHours(),this.initialPath=t.path||this.time2path(new Date),this}var s=["SUN","MON","TUE","WED","THU","FRI","SAT"],r=["SUN2","MON2","TUE2","WED2","THU2","FRI2","SAT2"],l=e.getHoursFunction();return("object"!=typeof minifest||Object.keys(minifest).length<10)&&(minifest=function(){for(var t,e={},n=(new Date).add(-18,"hours"),i=n.getDate().pad()+"XX",a=0;15>a;a++){t=n.add(a,"days").getDate().pad();for(var o=0;24>o;o+=3)(10>a||6===o||18===o)&&(e[t+o.pad()]=i,e[t+o.pad()+"t"]=i)}return e}(),i.event("Minifest missing!!!")),o.prototype.day2index=function(t){return t/this.calendarDays+.52/this.calendarDays},o.prototype.createDayHours=function(){var t,e;for(t=this.offset;t<this.numberOfHours;t++)e=this.constructPath(t),this.dayHours[e]||(this.dayHours[e]=this.produceDayHourObject(t));return this.dayHours},o.prototype.createDayHoursFromMinifest=function(t){var e,n,i;for(i=0;i<=this.numberOfHours;i++)e=this.startOfTimeline.add(i).toUTCPath(),n=e.replace(/^\d+\/\d+\/(\d+)\/(\d+)$/,"$1$2"),(t[n+"t"]||t[n])&&(this.dayHours[e]=this.produceDayHourObject(i),this.actualNumberOfHours=i);return this.maxIndex=this.actualNumberOfHours/(24*this.calendarDays),this.dayHours},o.prototype.produceDayHourObject=function(t){var e=this.days[parseInt(t/24)],n=this.startOfTimeline.add(t);return{text:e&&e.display,day:e&&e.day,month:e&&e.month,hour:l(n.getHours()),index:t/(24*this.calendarDays),sequence:this.sequence++,timestamp:n.getTime()}},o.prototype.constructPath=function(t){var e,n=this.startOfTimeline.add(t),i=n.getUTCHours(),a=i%this.step;return e=a<.3*this.step?i-a+this.offset:a>=.3*this.step?i+this.step-a+this.offset:i,n.setUTCHours(e),n.toUTCPath()},o.prototype.index2path=function(t){var e=this.dayHours;return Object.keys(e).reduce(function(n,i){return Math.abs(e[i].index-t)<Math.abs(e[n].index-t)?i:n})},o.prototype.time2index=function(t){return(t-this.startOfTimeline)/(this.endOfcalendar-this.startOfTimeline)},o.prototype.time2path=function(t){return this.index2path(this.time2index(t))},o.prototype.path2index=function(t){var e=this.dayHours[t];if(e)return e.index;var n=this.path2date(t);return this.time2index(n.getTime())},o.prototype.path2date=function(t){var e=t.split("/");return new Date(Date.UTC(e[0],e[1]-1,e[2],e[3],0,0))},o.prototype.date2path=function(t){var e=t.getFullYear(),n=t.getMonth()+1,i=t.getDate(),a=t.getHours();return[e,n.pad(2),i.pad(2),a.pad(2)].join("/")},o.prototype.path2string=function(t){var e=this.path2date(t),n=e.getDay(),i=e.getDate(),o=l(e.getHours());return a[s[n]]+" "+i+" - "+o},function(t){return new o(t)}}),W.define("overlays",["Class","storage","broadcast","settings","colors"],function(t,e,n,i,a){var o={},s=[3,3,3,3,5,5,7,8,9,10,11,12,12,12,12,12,12,12],r=[4,4,4,4,4,4,5,6,7,8,10,10,10,10,10,10,10,10],l="metric"===i.defaults?0:1;return o.trans={wind:"WIND",gust:"GUST",temp:"TEMP",pressure:"PRESS",clouds:"CLOUDS",lclouds:"LCLOUDS",rain:"RACCU",snow:"SNOW",rh:"RH",waves:"WAVES",swell:"SWELL",wwaves:"WWAVES",swellperiod:"SWELLPER",snowcover:"SNOWCOVER",sst:"SST2",sstanom:"SSTA2",ice:"ICE"},W.Overlay=t.extend({conv:{},defaults:[],separator:" ",dataLoading:-1,sea:null,_init:function(){var t=e.get("settings_"+this.ident);this.metric=t&&this.conv[t]?t:this.defaults[l],this.gradient&&this.prepareColors()},prepareColors:function(){var t,e,n=a.segmentedColorScale(this.gradient);for(this.preparedColors=[],this.colorsArray=[],this.startingValue=this.bounds[0],this.step=(this.bounds[1]-this.startingValue)/this.steps,t=0;t<this.steps;t++)e=n(this.startingValue+this.step*t),this.preparedColors[t]=e,this.colorsArray[t]=e.concat(e).concat(e).concat(e)},convertValue:function(t){var e=this.conv[this.metric];return"undefined"==typeof t?"":e.conversion(t).toFixed(e.precision)+this.separator+(e.label||this.metric)},convertNumber:function(t){var e=this.conv[this.metric];return e.conversion(t).toFixed(e.precision)},setMetric:function(t){this.conv[t]&&this.metric!==t&&(this.metric=t,e.put("settings_"+this.ident,t),n.emit("metricChanged",this.ident,t))}}),o.temp=W.Overlay.extend({ident:"temp",pois:"cities",metric:null,separator:"",defaults:["\u63b3C","\u63b3F"],conv:{"\u63b3C":{conversion:function(t){return t-273.15},precision:0},"\u63b3F":{conversion:function(t){return 9*t/5-459.67},precision:0}},products:["gfs","mbeurope"],bounds:[193,328],steps:200,blur:r,gradient:[[193,[37,4,42,120]],[206,[41,10,130,120]],[219,[81,40,40,120]],[233.15,[192,37,149,120]],[255.372,[70,215,215,120]],[273.15,[21,84,187,120]],[275.15,[24,132,14,120]],[291,[247,251,59,120]],[298,[235,167,21,120]],[311,[230,71,39,120]],[328,[88,27,67,120]]],description:["\u63b3C","\u63b3F"],lines:[[237,-35,-31],[242,-30,-22],[247,-25,-13],[252,-20,-4],[257,-15,5],[262,-10,14],[267,-5,23],[272,0,32],[277,5,41],[282,10,50],[287,15,59],[292,20,68],[297,25,77],[302,30,86],[307,35,95]]}),o.wind=W.Overlay.extend({ident:"wind",pois:"metars",defaults:["kt","kt"],conv:{kt:{conversion:function(t){return 1.943844*t},precision:0},bft:{conversion:function(t){return.3>t?0:1.5>t?1:3.3>t?2:5.5>t?3:8>t?4:10.8>t?5:13.9>t?6:17.2>t?7:20.7>t?8:24.5>t?9:28.4>t?10:32.6>t?11:12},precision:0},"m/s":{conversion:function(t){return t},precision:1},"km/h":{conversion:function(t){return 3.6*t},precision:0},mph:{conversion:function(t){return 2.236936*t},precision:0}},products:["gfs","mbeurope"],bounds:[0,100],steps:300,blur:r,gradient:[[0,[152,219,248,0]],[8.49,[50,100,255,0]],[15.79,[254,0,3,100]],[30,[209,103,211,100]],[70,[238,200,239,100]],[100,[55,255,255,100]]],description:["kt","bft","m/s","mph","km/h"],lines:[[0,0,0,0,0,0],[2,4,2,2,4,7],[4,8,3,4,9,14],[6,12,4,6,13,22],[8,16,5,8,18,29],[10,20,5,10,22,36],[12,24,6,12,27,43],[14,28,7,14,31,50],[16,32,7,16,36,58],[18,36,8,18,40,65],[20,44,9,20,45,72],[24,48,9,24,55,88],[27,52,10,27,60,96],[29,56,11,29,64,103]]}),o.gust=o.wind,o.rh=W.Overlay.extend({ident:"rh",pois:"metars",defaults:["%","%"],conv:{"%":{conversion:function(t){return t},precision:0}},products:["gfs","mbeurope"],bounds:[0,110],steps:200,blur:r,gradient:[[0,[0,0,0,80]],[50,[243,240,40,120]],[80,[252,167,53,120]],[85,[235,117,85,120]],[90,[214,86,108,120]],[93,[179,44,141,120]],[95,[129,3,167,120]],[98,[89,2,165,120]],[100,[19,7,137,120]]],description:["%"],lines:[[75,75],[80,80],[85,85],[90,90],[95,95],[100,100]]}),o.pressure=W.Overlay.extend({ident:"pressure",pois:"pressure",defaults:["hPa","inHg"],conv:{hPa:{conversion:function(t){return t/100},precision:0},mmHg:{conversion:function(t){return t/133.322387415},precision:0},inHg:{conversion:function(t){return t/3386.389},precision:2}},products:["gfs"],bounds:[92e3,108e3],steps:200,blur:r,gradient:[[99e3,[37,4,42,120]],[99500,[41,10,130,120]],[1e5,[81,40,40,120]],[100300,[192,37,149,120]],[100600,[70,215,215,120]],[100900,[21,84,187,120]],[101500,[24,132,14,120]],[101900,[247,251,59,120]],[102200,[235,167,21,120]],[102500,[230,71,39,120]],[103e3,[88,27,67,120]]],description:["hPa","inHg"],lines:[[99500,995,29.38],[99800,998,29.47],[100100,1001,29.56],[100400,1004,29.64],[100700,1007,29.73],[101e3,1010,29.82],[101300,1013,29.91],[101600,1016,30],[101900,1019,30.09],[102200,1022,30.17],[102500,1025,30.27],[102800,1028,30.36]]}),o.clouds=W.Overlay.extend({ident:"clouds",pois:"metars",defaults:["mm/h","in/h"],conv:{"in/h":{conversion:function(t){return(t-200)/60*.039},label:"in/h",precision:2},"mm/h":{conversion:function(t){return(t-200)/60},label:"mm/h",precision:1}},products:["gfs","mbeurope"],bounds:[0,2e3],steps:1e3,blur:s,gradient:[[0,[0,0,0,80]],[10,[0,0,0,80]],[30,[127,127,127,80]],[100,[255,255,255,90]],[180,[255,255,255,90]],[200,[230,240,255,90]],[240,[0,108,192,90]],[270,[0,188,0,90]],[300,[156,220,0,90]],[350,[224,220,0,90]],[400,[252,132,0,90]],[500,[252,0,0,90]],[700,[160,0,0,90]],[2e3,[160,0,0,90]]],description:["mm/h","in/h"],lines:[[230,.5,".02"],[260,1,".04"],[290,1.5,".06"],[320,2,".08"],[380,3,".12"],[440,4,".16"],[500,5,".2"],[620,7,".3"],[800,10,".4"]]}),o.snow=W.Overlay.extend({ident:"snow",pois:"empty",defaults:["cm","in"],conv:{"in":{conversion:function(t){return.039*t},precision:1},cm:{conversion:function(t){return t/10},precision:1}},products:["accumulations"],bounds:[0,8e3],steps:8e3,blur:r,gradient:[[0,[0,0,0,80]],[40,[0,0,0,80]],[100,[107,63,180,90]],[200,[27,160,223,100]],[300,[0,225,158,120]],[500,[165,242,76,120]],[800,[231,178,18,120]],[1500,[255,112,67,120]],[3e3,[238,61,150,120]],[8e3,[116,58,174,120]]],description:["cm","in"],lines:[[80,8,3.1],[100,10,3.9],[200,20,8],[300,30,11],[500,50,20],[1e3,"1m","3ft"],[2e3,"2m","6ft"],[3e3,"3m","9ft"]]}),o.rain=o.snow.extend({ident:"rain",pois:"empty",defaults:["mm","in"],conv:{"in":{conversion:function(t){return.039*t},precision:1},mm:{conversion:function(t){return t},precision:1}},products:["accumulations"],bounds:[0,8e3],steps:8e3,blur:r,gradient:[[0,[0,0,0,80]],[1,[0,0,0,80]],[5,[107,63,180,90]],[10,[27,160,223,100]],[30,[0,225,158,120]],[40,[165,242,76,120]],[80,[231,178,18,120]],[120,[255,112,67,120]],[500,[238,61,150,120]],[8e3,[116,58,174,120]]],description:["mm","in"],lines:[[5,5,".2"],[10,10,".4"],[20,20,".8"],[30,30,"1.2"],[40,40,1.5],[100,100,3.9],[1e3,"1m","3ft"],[3e3,"3m","9ft"]]}),o.snowcover=o.snow.extend({products:["snowcover"],bounds:[0,3],steps:30,blur:r,gradient:[[0,[0,0,0,100]],[1,[0,212,255,100]],[3,[0,212,255,100]]],description:null,lines:null}),o.lclouds=o.clouds.extend({pois:"metars",products:["gfs"],bounds:[0,200],steps:50,blur:s,gradient:[[0,[0,0,0,80]],[10,[0,0,0,80]],[30,[255,255,255,20]],[100,[255,255,255,90]]],lines:null,description:null}),o.waves=W.Overlay.extend({ident:"waves",pois:"empty",defaults:["m","ft"],conv:{m:{conversion:function(t){return t},precision:1},ft:{conversion:function(t){return 3.28*t},precision:0}},products:["waves"],bounds:[0,30],steps:400,dataLoading:5,sea:!0,blur:r,gradient:[[0,[200,200,200,100]],[1,[0,194,243,100]],[2,[0,89,166,100]],[3,[13,100,255,100]],[4,[247,74,255,100]],[5,[188,0,184,100]],[6,[255,4,83,100]],[7,[255,98,69,100]],[10,[255,255,255,100]],[50,[188,141,190,100]]],description:["m","ft"],lines:[[.5,.5,1.6],[1,1,3.3],[1.5,1.5,5],[2,2,6.6],[3,3,10],[4,4,13],[5,5,16],[6,6,20],[7,7,23],[8,8,26],[9,9,30]]}),o.swell=o.waves,o.wwaves=o.waves,o.swellperiod=W.Overlay.extend({ident:"swellperiod",pois:"empty",defaults:["sec.","sec."],conv:{"sec.":{conversion:function(t){return t},precision:1}},products:["waves"],bounds:[0,30],steps:400,dataLoading:5,sea:!0,blur:r,gradient:[[0,[37,4,42,120]],[2,[41,10,130,120]],[4,[81,40,40,120]],[6,[192,37,149,120]],[8,[70,215,215,120]],[10,[21,84,187,120]],[12,[24,132,14,120]],[14,[247,251,59,120]],[16,[235,167,21,120]],[18,[230,71,39,120]],[29,[88,27,67,120]]],description:["sec."],lines:[[2,2],[4,4],[6,6],[8,8],[12,12],[14,14],[16,16],[18,18],[20,20]]}),o.sst=W.Overlay.extend({ident:"sst",pois:"empty",metric:null,separator:"",defaults:["\u63b3C","\u63b3F"],conv:{"\u63b3C":{conversion:function(t){return t},precision:1},"\u63b3F":{conversion:function(t){return 1.8*t+32},precision:1}},dataLoading:4,sea:!0,products:["sst"],bounds:[-2,40],steps:1e3,blur:r,gradient:[[-2,[37,4,42,120]],[0,[41,10,130,120]],[1,[81,40,40,120]],[2,[192,37,149,120]],[5,[70,215,215,120]],[9,[21,84,187,120]],[16,[24,132,14,120]],[19,[247,251,59,120]],[22,[235,167,21,120]],[25,[230,71,39,120]],[28,[192,37,149,120]],[31,[41,10,130,120]],[40,[255,255,255,120]]],description:["\u63b3C","\u63b3F"],lines:[[0,0,32],[2,2,35],[4,4,39],[6,6,42],[8,8,46],[10,10,50],[12,12,53],[14,14,57],[16,16,60],[18,18,64],[20,20,68],[22,22,71],[24,24,75],[26,26,78],[28,28,82]]}),o.sstanom=W.Overlay.extend({ident:"sstanom",pois:"empty",metric:null,separator:"",defaults:["\u63b3C"],conv:{"\u63b3C":{conversion:function(t){return t},precision:2}},products:["sst"],bounds:[-10,10],steps:200,blur:r,dataLoading:4,sea:!0,gradient:[[-10,[255,255,255,120]],[-3,[9,31,246,120]],[-1,[9,221,246,120]],[0,[130,130,130,120]],[1,[246,238,9,120]],[2,[246,9,9,120]],[2.5,[246,9,244,120],[10,[255,255,255,120]]]],description:["\u63b3C"],lines:[[-3,-3],[-2,-2],[-1,-1],[0,0],[1,1],[2,2],[3,3]]}),o}),W.define("colors",[],function(){function t(t){function e(t,e){var n=t[0],i=t[1],a=t[2],o=t[3],s=e[0]-n,r=e[1]-i,l=e[2]-a,c=e[3]-o;return function(t){return[Math.floor(n+t*s),Math.floor(i+t*r),Math.floor(a+t*l),Math.floor(o+t*c)]}}function n(t,e,n){return(Math.max(e,Math.min(t,n))-e)/(n-e)}for(var i=[],a=[],o=[],s=0;s<t.length-1;s++)i.push(t[s+1][0]),a.push(e(t[s][1],t[s+1][1])),o.push([t[s][0],t[s+1][0]]);return function(t){var e;for(e=0;e<i.length-1&&!(t<=i[e]);e++);var s=o[e];return a[e](n(t,s[0],s[1]))}}return{segmentedColorScale:t}}),W.define("loader",["http","dataStore","object","jsonLoader","imgLoader"],function(t,e,n,i,a){function o(t){var n,o,s=[],r=/\.jpg|\.png/.test(t.fullPath)?a:i,l=e.get(),c=r.getRequiredTiles(t.map,t.tileZoom);for(n=0;n<c.tiles.length;n++)s.push(r.loadTile(l,c,t,n));return o=new Promise(function(e,n){Promise.all(s).then(function(n){e(r.composeObject(l,n,t,c))})["catch"](function(t){n(t)})}),o.cancel=function(){for(n=0;n<s.length;n++)"function"==typeof s[n].cancel&&s[n].cancel()},o}function s(t,e,n){return t.self.checkTiles(t,e,n)}return{load:o,checkTiles:s}}),W.define("jsonLoader",["http","lruCache","object"],function(t,e,n){var i=n.extend({},{tilesCache:new e(30),emptyGrid:null,tilePrefix:"t",tileParams:[{size:360,width:1,tileSize:360,resolution:1},{size:30,width:12,tileSize:120,resolution:.25},{size:15,width:24,tileSize:120,resolution:.125},{size:7.5,width:48,tileSize:120,resolution:.0625},{size:3.75,width:96,tileSize:120,resolution:.03125},{size:1.875,width:192,tileSize:120,resolution:.015625},{},{},{size:60,width:6,tileSize:120,resolution:.5}],_init:function(){for(var t=[],e=0;14400>e;e++)t[e]=null;this.emptyGrid=[{data:t},{data:t}]},getRequiredTiles:function(t,e){if(0==e)return{left:0,right:0,top:0,bottom:0,width:1,height:1,tileZoom:0,tileSize:360,size:360,tiles:[{x:0,y:0}],paths:[""],wrapped:!0,resolution:1,self:this};var n,i,a,o,s=[],r=[],l=this.tilePrefix+e,c=this.tileParams[e],d=Math.floor(t.west/c.size),h=Math.floor(t.east/c.size),u=Math.floor((90-t.north)/c.size),p=Math.floor((90-t.south)/c.size);for(d=0>d?c.width+d:d,h=0>h?c.width+h:h,d>h&&(h+=c.width),n=u,o=0;p>=n;n++,o++)for(i=d,a=0;h>=i;i++,a++)s.push({y:o,x:a}),r.push(l+"/"+n+"/"+(i>c.width-1?i-c.width:i)+"/");return{left:d,right:h,top:u,bottom:p,width:h-d+1,height:p-u+1,tileZoom:e,tileSize:c.tileSize,size:c.size,tiles:s,paths:r,wrapped:!1,resolution:c.resolution,self:this}},checkTiles:function(t,e,n){var i,a=t.paths,o=this.getRequiredTiles(e,n).paths;for(i=0;i<o.length;i++)if(-1===a.indexOf(o[i]))return!1;return!0},composeObject:function(t,e,i,a){var o={tiles:a,tileZoom:i.tileZoom,overlay:i.gridName,product:i.product,level:i.level,lastModified:e[0].lastModified,data:t,destWidth:a.tileSize*a.width+1};
if(0===i.tileZoom)n.include(o,e[0]);else{var s=(1+a.right)*a.size-a.resolution;n.include(o,{lo1:a.left*a.size,lo2:s>360?s-360:s,la2:90-a.top*a.size,la1:90-(1+a.bottom)*a.size-a.resolution,dx:a.resolution,dy:a.resolution})}return o},loadTile:function(e,n,i,a){var o,s,r,l,c=this,d=n.tiles[a],h=i.fullPath.replace(/<tiles>/,n.paths[a]),u={cache:this.tilesCache,parseHeaders:0===a};return n.tileZoom&&(u.substituteData=this.emptyTable),s=new Promise(function(s){o=t.get(h,u).then(function(t){if(r=c.injectData(t.data,e,i,d.x,d.y,n),0===a)try{l=new Date(t.headers["last-modified"]),r.lastModified=l.getTime()}catch(o){}s(r)})}),s.cancel=function(){"function"==typeof o.cancel&&o.cancel()},s},injectData:function(t,e,n,i,a,o){var s,r,l,c,d,h,u,p,m=t[0].data||t[0],f=t[1]&&(t[1].data||t[1]),g=t[2]&&(t[2].data||t[2]),v=0,y=0,w=n.gridName;for(0===o.tileZoom?(l=t[0].header,c=l.nx,d=l.ny,h=c+1):(c=d=o.tileSize,h=c*o.width+1),s=0;d>s;s++){for(v=3*((d*a+s)*h+c*i),u=v,r=0;c>r;r++){switch(w){case"gust":e[v]=m[y]/10;break;case"wind":e[v]=m[y]/10,e[v+1]=f[y]/10;break;case"waves":case"swell":case"wwaves":case"swellperiod":case"wwavesperiod":p=.0174*g[y],e[v]=-f[y]*Math.sin(p),e[v+1]=-f[y]*Math.cos(p),e[v+2]=m[y];break;default:e[v]=m[y]}y++,v+=3}o.wrapped?(e[v]=e[u],e[v+1]=e[u+1],e[v+2]=e[u+2]):(e[v]=e[v-3],e[v+1]=e[v-2],e[v+2]=e[v-1])}return l||{}}});return i}),W.define("imgLoader",["object","jsonLoader"],function(t,e){var n=t.extend(e,{canvas:document.getElementById("jpg_decoder"),context:document.getElementById("jpg_decoder").getContext("2d"),tilePrefix:"j",tileParams:[{size:360,width:1,tileSize:360,resolution:1},{size:60,width:6,tileSize:240,resolution:.25},{size:30,width:12,tileSize:240,resolution:.125},{size:15,width:24,tileSize:240,resolution:.0625},{size:7.5,width:48,tileSize:240,resolution:.03125},{size:3.75,width:96,tileSize:240,resolution:.015625},{},{},{size:90,width:4,tileSize:180,resolution:.5}],_init:function(){},loadTile:function(t,e,n,i){var a,o=this,s=!1,r=e.tiles[i],l=n.fullPath.replace(/<tiles>/,e.paths[i]);return a=new Promise(function(i){var a,c,d,h;a=new Image,a.crossOrigin="Anonymous",a.onload=function(){s||(o.canvas.width=a.width,o.canvas.height=a.height,o.context.drawImage(a,0,0,a.width,a.height),h=o.context.getImageData(0,0,a.width,a.height),c=o.decodeHeader(h.data,a.width),d=o.injectData(h.data,t,n,r.x,r.y,e,c,a.width,a.height-8),d.lastModified=parseInt(c[6]),i(d))},a.onerror=function(){i({})},a.src=l,(a.complete||void 0===a.complete)&&(a.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a.src=l)}),a.cancel=function(){s=!0},a},decodeHeader:function(t,e){for(var n,i,a,o,s,r=new ArrayBuffer(28),l=new Uint8Array(r),c=new Float32Array(r),s=16*e+8,o=0;28>o;o++)n=t[s],i=t[s+1],a=t[s+2],n=Math.round(n/64),i=Math.round(i/16),a=Math.round(a/64),l[o]=(n<<6)+(i<<2)+a,s+=16;return c},injectData:function(t,e,n,i,a,o,s,r,l){var c,a,d,h,u,p,m,f,g,v,y,w,b,x,M,S=0,T=0,C=0;for(n.gridName,0===o.tileZoom?(p=r,m=l,d=p+1):(p=m=o.tileSize,d=p*o.width+1),c=0;3>c;c++)if(h=s[2*c],u=s[2*c+1],h||u){switch(c){case 0:v=h,y=(u-h)/255;break;case 1:w=h,b=(u-h)/255;break;case 2:x=h,M=(u-h)/255}S=c}for(n.dataLoading>-1&&(S=n.dataLoading),C=32*r,c=0;m>c;c++){switch(T=3*((m*a+c)*d+p*i),f=T,S){case 4:for(g=0;p>g;g++)e[T]=0===t[C+3]?0/0:t[C]*y+v,C+=4,T+=3;break;case 5:for(g=0;p>g;g++)0===t[C+3]?(e[T]=0/0,e[T+1]=0,e[T+2]=0):(e[T]=t[C]*y+v,e[T+1]=t[C+1]*b+w,e[T+2]=t[C+2]*M+x),C+=4,T+=3;break;case 1:for(g=0;p>g;g++)e[T]=t[C]*y+v,e[T+1]=t[C+1]*b+w,C+=4,T+=3;break;case 0:for(g=0;p>g;g++)e[T]=t[C]*y+v,C+=4,T+=3}o.wrapped?(e[T]=e[f],e[T+1]=e[f+1],e[T+2]=e[f+2]):(e[T]=e[T-3],e[T+1]=e[T-2],e[T+2]=e[T-1])}return 0===o.tileZoom?{nx:r,ny:l,dx:1,dy:1,la1:90,la2:90-l,lo1:0,lo2:359}:{}}});return n}),W.define("products",["rootScope","loader","interpolation","interFunctions","http","overlays","broadcast","object","calendar","particles","log"],function(t,e,n,i,a,o,s,r,l,c,d){var h,u={},p=(new Date).toISOString().replace(/^\d+-(\d+)-(\d+)T.*$/,"$1$2");return u.getProductString=function(t,e){var n=o[t].products;return n.indexOf(e)>-1?e:n[0]},W.Product=W.Class.extend({interpolate:function(){return i.interpolateAll},refTime:function(t){var e=t.path.replace(/^\d+\/\d+\/(\d+)\/(\d+)$/,"$1$2"),n=this.minifest[e+"t"]||this.minifest[e];return n?"?"+n:""},load:function(n){var i,a,s=[];n.server=this.server||t.server,n.tileZoom=this.getTileZoom(n),n.dataLoading=o[n.overlay].dataLoading;for(var l in this.pathGenerators)a=this.pathGenerators[l],i="function"==typeof a?a(n):a,i&&(n.fullPath=i.template(n)+this.refTime(n),n.gridName="overlay"===l?n.overlay:l,s.push(e.load(r.clone(n))));return s},display:function(t,e,i){n.interpolate({map:e.map,grid:t[0],overlay:t[1],mapDirty:e.mapDirty,colors:o[e.overlay],disableOverlay:e.map.zoom>=this.disableOverlayZoom,interpolate:this.interpolate(e),particles:this.particles[e.map.source],blurAmount:o[e.overlay].blur[e.map.zoom],product:e.product},function(){o[e.overlay].sea?document.body.classList.add("sea"):document.body.classList.remove("sea"),i()})},checkCoverage:function(t,e){var n=null;return t?(this.betterFcst&&"out-of-bounds"!==u[this.betterFcst].checkCoverage(t,e)&&(n=this.betterFcst),n!==h&&(h=n,s.emit("betterFcst",n)),this.checkData(t[0],e)):"no-data"},getTileZoom:function(t){return t.historical?0:this.zoom2zoom[t.map.zoom]},checkData:function(t,n){return t.tileZoom===this.getTileZoom(n)&&e.checkTiles(t.tiles,n.map,t.tileZoom)?"ok":"no-data"}}),u.gfs=W.Product.extend({minifest:minifest,zoom2zoom:[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],animation:!0,calendar:l({minifest:this.minifest}),model:"GFS 12x12km",provider:"NOAA",interval:"6h",particles:c.wind,disableOverlayZoom:12,pathGenerators:{wind:"{server}gfs/{path}/<tiles>wind-{level}.jpg",overlay:function(t){return"wind"===t.overlay?null:"{server}gfs/{path}/<tiles>{overlay}-surface"+("pressure"===t.overlay?".png":".jpg")}},betterFcst:"mbeurope",productReady:!0}),u.mbeurope=W.Product.extend({minifest:null,zoom2zoom:[1,1,1,1,1,1,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4],calendar:null,model:"NEMS 4x4km",provider:"Meteoblue.com",interval:"12h",animation:!0,particles:c.mbeurope,disableOverlayZoom:12,betterFcst:null,productReady:!1,pathGenerators:{wind:"{server}mbeurope/{path}/<tiles>wind-{level}.jpg",overlay:function(t){return"wind"===t.overlay?null:"{server}mbeurope/{path}/<tiles>{overlay}-surface.jpg"}},refTime:function(t){var e=this.minifest[t.path.replace(/^\d+\/\d+\/(\d+)\/(\d+)$/,"$1$2")];return e?"?"+e:""},init:function(e){var n=this;a.get(t.server+"mbeurope/minifest.json?timestamp="+Date.now()).then(function(t){n.minifest=t.data,n.calendar=l({numOfDays:5,minifest:n.minifest})})["catch"](function(){n.minifest=u.gfs.minifest,n.calendar=l({numOfDays:4}),d.event("Error: failed to load NEMS4 minifest")}).then(function(){n.productReady=!0,e()})},checkCoverage:function(t,e){return e.map.west>-19&&e.map.east<33&&e.map.north<57&&e.map.south>33?/surface|975h|950h|925h|900h|850h|750h/.test(e.level)?this.checkData(t[0],e):"not-supported-data":"out-of-bounds"}}),u.accumulations=u.gfs.extend({interval:"12h",animation:!1,pathGenerators:{overlay:"{server}accumulations/<tiles>{overlay}-{acTime}.jpg"},betterFcst:null,productReady:!0,calendar:null,particles:{},refTime:function(){return"?"+p},interpolate:function(){return i.interpolateOverlay}}),u.snowcover=u.accumulations.extend({zoom2zoom:[0,0,0,0,0,0,3,3,3,3,3,5,5,5,5,5,5,5,5,5,5],model:"NSIDC 1x1km",provider:"NSIDC (nsidc.org)",interval:"24h",disableOverlayZoom:15,pathGenerators:{overlay:"{server}snowcover/latest/<tiles>snowcover.png"},checkCoverage:function(t,e){return this.zoom2zoom[e.map.zoom]>0&&e.map.south<-29?"out-of-bounds":this.checkData(t[0],e)}}),u.waves=W.Product.extend({zoom2zoom:[0,0,0,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],minifest:minifest,model:"Wavewatch 3",provider:"NOAA",interval:"6h",disableOverlayZoom:12,animation:!0,productReady:!0,calendar:l({numOfDays:7}),pathGenerators:{overlay:function(t){return"{server}waves/{path}/<tiles>"+t.overlay.replace(/period/,"")+"-surface.png"}},betterFcst:null,particles:c.waves,interpolate:function(t){return 8===t.tileZoom?/period/.test(t.overlay)?i.interpolateAll:i.interpolateWaves:/period/.test(t.overlay)?i.interpolateAll:i.interpolateWaves2}}),u.sst=u.accumulations.extend({zoom2zoom:[0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],model:"NESDIS",provider:"NOAA",interval:"24h",disableOverlayZoom:15,animation:!1,particles:{},pathGenerators:{overlay:"{server}sst/latest/<tiles>{overlay}.png"},interpolate:function(){return i.interpolateSea}}),u}),W.define("dataStore",[],function(){function t(){return i++,i>=a.length&&(i=0),a[i]}for(var e=10,n=1036800,i=-1,a=[],o=0;e>o;o++)a[o]=new Float32Array(n);return{get:t}}),W.define("task",["interpolation","broadcast","products","rootScope","object","Class"],function(t,e,n,i,a,o){function s(t){"cancelled"!==t&&console.warn("task cancelled was called")}return W.Task=o.extend({params:null,product:null,mapDirty:!1,_init:function(){this.status="init",this.data=null,this.loadingTasks=[],this.antiCycleCounter=0},setStatus:function(t){this.status=t},load:function(t){var e=this;return this.loadingTasks=this.product.load(this.params),this.setStatus("loading"),Promise.all(this.loadingTasks).then(function(n){e.product.transform&&e.product.transform(n),e.setStatus("loaded"),e.loadingTasks=[],e.data=n,e.display(t)},s),this},cancel:function(){"loading"===this.status?this.loadingTasks.map(function(t){"function"==typeof t.cancel&&t.cancel()}):"interpolation"===this.status&&t.cancel()},display:function(t){var o="ok",s=this;switch(this.mapDirty&&(this.params.map=a.clone(i.map),this.params.mapDirty=!0,o=this.product.checkCoverage(this.data,this.params)),o){case"ok":this.setStatus("interpolation"),this.product.display(this.data,this.params,function(){s.params.lastModified=s.data[0].lastModified,s.setStatus("finished"),s.antiCycleCounter=0,e.emit("redrawFinished",s.params,s.mapDirty),s.mapDirty=!1,s.params.mapDirty=!1,"function"==typeof t&&t()});break;case"no-data":this.antiCycleCounter++>10?console.error("displayAnimation was cycled"):this.load();break;case"out-of-bounds":case"out-of-timeline":case"not-supported-data":this.params.model=this.params.product="gfs",this.product=n.gfs,e.emit("modelChanged","gfs"),this.load()}}}),function(t){return W.Task.extend(t)}}),W.define("geolocation",["rootScope","http","broadcast","storage"],function(t,e,n,i){function a(){return navigator.geolocation?new Promise(function(e){navigator.geolocation.getCurrentPosition(function(t){e({lat:t.coords.latitude,lon:t.coords.longitude})},function(){e(t.geoIP)})}):getIPlocation()}function o(n,a,o){var s;if(a.fromStartup&&(s=i.get("initReverseName"))&&n.lat==s.lat&&s.lon==s.lon)return o(s),Promise.resolve();var r=e.get(t.server2+"node/reverse/"+n.lat+"/"+n.lon+"?lang="+t.prefLang);return r.then(function(t){var e=t.data&&t.data.address||{};n.name="village"===a.detailLevel?e.hamlet||e.suburb||e.quarter||e.village||e.town||e.city:e.town||e.village||e.city||e.hamlet||e.suburb||e.quarter,n.region=e.county||e.district||e.state||"",n.country=e.country||"",n.name||(n.name=a.mustBeDefined?n.region:parseFloat(n.lat).toFixed(2)+", "+parseFloat(n.lon).toFixed(2)),a.fromStartup&&i.put("initReverseName",n),o(n)}),r}n.on("locationRqstd",function(){a().then(function(t){t.zoom=9,n.emit("mapsCenter",t),n.emit("mapsPopupRequested",t.lat,t.lon)})});var s=document.querySelector('meta[name="geoip"]');if(s&&s.content){var r=s.content.split(",");t.hash=parseInt(r[0].replace(/\./g,"")).toString(20),r[1]&&r[2]&&(t.geoIP={lat:parseFloat(r[1]),lon:parseFloat(r[2]),country:r[3],zoom:6},t.geoIP.name=r[4]||t.geoIP.lat.toFixed(3)+", "+t.geoIP.lon.toFixed(3))}return{getGPSlocation:a,getReverseName:o}}),W.define("blurWorker",["log"],function(t){function e(){function t(t){l=new Uint16Array(t),i=new Uint16Array(t),a=new Uint16Array(t)}function e(t){c=new Uint32Array(t),o=new Uint32Array(t)}function n(n,d,h,u,p,m,f,g){g=g||3,g|=0;var v=m*f;v>l.length&&t(v),v=Math.max(m,f),v>c.length&&e(v);var y,w,b,x,M,S,T,C,D,O,_,M,E,S,T,C,A,E=0,I=0,L=0,N=m-1,k=f-1,W=g+1,R=s[g],z=r[g],P=(1e7*R>>>z)/1e7,U=c,F=o,j=l,B=i,H=a,G=n.data;for(O=0;m>O;O++)U[O]=((S=O+W)<N?S:N)<<2,F[O]=(S=O-g)>0?S<<2:0;for(x=0;f>x;x++){for(y=G[L]*W,w=G[L+1]*W,b=G[L+2]*W,M=1;g>=M;M++)S=L+((M>N?N:M)<<2),y+=G[S],w+=G[S+1],b+=G[S+2];for(E=0;m>E;E++)j[I]=y,B[I]=w,H[I]=b,T=L+U[E],C=L+F[E],y+=G[T]-G[C],w+=G[T+1]-G[C+1],b+=G[T+2]-G[C+2],I++;L+=m<<2}for(_=0;f>_;_++)U[_]=((S=_+W)<k?S:k)*m,F[_]=(S=_-g)>0?S*m:0;for(E=0;m>E;E++){for(D=E,y=j[D]*W,w=B[D]*W,b=H[D]*W,M=1;g>=M;M++)D+=M>k?0:m,y+=j[D],w+=B[D],b+=H[D];for(I=E<<2,A=m<<2,x=0;f>x;x++)G[I]=y*P,G[I+1]=w*P,G[I+2]=b*P,T=E+U[x],C=E+F[x],y+=j[T]-j[C],w+=B[T]-B[C],b+=H[T]-H[C],I+=A}return n}var i,a,o,s=[1,57,41,21,203,34,97,73,227,91,149,62,105,45,39,137,241,107,3,173,39,71,65,238,219,101,187,87,81,151,141,133],r=[0,9,10,10,14,12,14,14,16,15,16,15,16,15,15,17,18,17,12,18,16,17,17,19,19,18,19,18,18,19,19,19,20,19,20,20,20,20,20,20],l=[],c=[];self.onmessage=function(t){postMessage(n(t.data.imageData,t.data.x0,t.data.y0,t.data.xMax,t.data.yMax,t.data.width,t.data.height,t.data.radius))}}var n,i,a=null,o=window.URL||window.webkitURL;if(!window.Worker)return t.event("Web Worker not supported"),null;try{i="("+e.toString()+")()";try{n=new Blob([i],{type:"application/javascript"})}catch(s){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,n=new BlobBuilder,n.append(i),n=blob.getBlob(),t.event("Using old version of BlobBuilder, just for info")}try{a=new Worker(o.createObjectURL(n))}catch(s){return t.event("Unable to createObjectURL "+s),null}}catch(s){return t.event("Failed to stringyfy blurFunction "+s),null}return a}),W.define("particles",["rootScope","Class"],function(t,e){var n={surface:1,"975h":1,"950h":1,"925h":.98,"900h":.9,"850h":.8,"750h":.75,"700h":.7,"550h":.65,"450h":.6,"350h":.55,"300h":.5,"250h":.45,"200h":.4,"150h":.35};W.Particles={globe:e.extend({level2reduce:n,getVelocity:function(t){return 1/(this.velocity.a*t.map.scale+this.velocity.b)*this.level2reduce[t.grid.level]},getAmount:function(t){return this.multiplier.a*Math.pow(t.map.scale,2)+this.multiplier.b},getLineWidth:function(e){var n=t.isMobile?.4:0;return scale=e.map.scale,scale>300?1+n:scale>200?.8+n:.6+n},getStyles:function(){var t=.8;return["rgba(255,255,255,"+Math.max(0,t-.6)+")","rgba(255,255,255,"+Math.max(0,t-.4)+")","rgba(255,255,255,"+Math.max(0,t-.2)+")","rgba(255,255,255,"+t+")"]},getMaxAge:function(){return 100},getBlendingAlpha:function(t){var e=t.map.scale;return 500>e?.96:600>e?.94:.92}}),maps:e.extend({stylesBlue:["rgba(200,0,150,1)","rgba(200,0,150,1)","rgba(200,0,150,1)","rgba(200,0,150,1)"],level2reduce:n,getVelocity:function(t){return this.level2reduce[t.grid.level]/(this.velocity.constant*Math.pow(this.velocity.pow,t.map.zoom-this.velocity.zoom))},getAmount:function(t){return multiplier=1/(this.multiplier.constant*Math.pow(this.multiplier.pow,t.map.zoom-this.multiplier.zoom)),Math.min(15e3,Math.round(t.map.width*t.map.height*multiplier))},getLineWidth:function(t){return this.lineWidth[t.map.zoom]},getStyles:function(t){return t.map.zoom>=12?this.stylesBlue:this.styles},getMaxAge:function(){return 100},getBlendingAlpha:function(){return.9}})};var i={wind:{},waves:{},mbeurope:{}};return i.wind.maps=W.Particles.maps.extend({animation:"wind",styles:["rgba(200,200,200,1)","rgba(215,215,215,1)","rgba(235,235,235,1)","rgba(255,255,255,1)"],lineWidth:[.6,.6,.6,1,1.2,1.6,1.8,2,2.2,2.4,2.4,2.4,2.4,2.6,2.8,3,3,3,3,3,3,3,3,3],multiplier:{constant:50,pow:1.6,zoom:2},velocity:{constant:70,pow:1.6,zoom:3}}),i.wind.globe=W.Particles.globe.extend({animation:"wind",multiplier:{a:.028,b:700},velocity:{a:.166666,b:20}}),i.waves.maps=W.Particles.maps.extend({animation:"waves",styles:["rgba(100,100,100,0.1)","rgba(150,150,150,0.15)","rgba(200,200,200,0.2)","rgba(255,255,255,0.3)"],lineWidth:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],multiplier:{constant:50,pow:1.3,zoom:2},velocity:{constant:150,pow:1.6,zoom:2}}),i.waves.globe=W.Particles.globe.extend({animation:"waves",getStyles:function(){return["rgba(100,100,100,0.1)","rgba(150,150,150,0.15)","rgba(200,200,200,0.2)","rgba(255,255,255,0.3)"]},getBlendingAlpha:function(){return.9},multiplier:{a:.08,b:1e3},velocity:{a:1,b:0}}),i.mbeurope.maps=i.wind.maps.extend({lineWidth:[1,1,1,1,1.4,1.6,1.8,2,2.2,2.4,2.4,2.4,2.4,2.6,2.8,3,3,3,3,3,3,3,3,3],multiplier:{constant:50,pow:1.5,zoom:2},velocity:{constant:70,pow:1.7,zoom:3}}),i}),W.define("interpolation",["rootScope","interFunctions","animation","mapsCtrl","blurWorker","object","broadcast","globe","maps"],function(t,e,n,i,a,o,s,r,l){"use strict";function c(){return M&&x}function d(t){return t-t%4}function h(t,n){if(!M||!x)return null;var i,a=M.dx,o=M.dy,s=Math.max(M.la1,M.la2),r=M.lo1,l=[];return i=e.interpolatePoint(t,n,s,r,a,o,M.destWidth),x(l,M.data,S&&S.data,i[0],i[1],i[2],i[3],i[4],i[5]),{wind:Math.sqrt(l[0]*l[0]+l[1]*l[1]),angle:10*Math.floor(18+18*Math.atan2(l[0],l[1])/Math.PI),overlayName:S&&S.overlay||M.overlay,overlayValue:l[2]}}function u(t,s){function c(n){var i,a,o,s,l,c,d=R,u=v,p=w,m=g,f=ae,b=R,x=ce,M=y,S=e.distort,T=Z,C=r.isVisible.bind(r),D=n/J,O=D*Math.ceil(U/4),E=3*O,I=6*O,L=4*O,W=[130,130,130,120,130,130,130,120,130,130,130,120,130,130,130,120],P=t.interpolate;if(h)for(E+=_/J*3,i=_;A>=i;i+=J,E+=3,I+=6,L+=4)if(C(i,n)){if(se){if(c=T.invert([i,n]),a=c[0],o=c[1],isNaN(o)||!isFinite(o))continue;V(o,a,i,n,p,L),q(o,a,I)}P(f,N,k,u[I],u[I+1],u[I+2],u[I+3],u[I+4],u[I+5]),S(f,d,p[L],p[L+1],p[L+2],p[L+3]),l=f[2],m[E]=f[0],m[E+1]=f[1],m[E+2]=l,s=Y[Math.floor((l-$)/X)]||W,x(Math.max(0,i-2),Math.max(0,n-2),s)}else m[E]=0,m[E+1]=0,m[E+2]=-1;else for(o=K*(2*Math.atan(Math.exp((ie-n)/ee))-Q),d=se?M[D]=(1-.01*Math.abs(o))*b:M[D],i=0;U>=i;i+=J,E+=3,I+=6,L+=4)se&&(a=z+i/U*te,V(o,a,i,n,p,L),q(o,a,I)),P(f,N,k,u[I],u[I+1],u[I+2],u[I+3],u[I+4],u[I+5]),S(f,d,p[L],p[L+1],p[L+2],p[L+3]),l=f[2],m[E]=f[0],m[E+1]=f[1],m[E+2]=l,s=Y[Math.floor((l-$)/X)]||W,x(i,n,s)}window.clearTimeout(T),D=!1;var h="globe"===t.map.source,u=i.getCanvas(),p=u.overlayCanvas,f=[p[0].getContext("2d"),p[1].getContext("2d")],O=u.actualCanvas,_=d(t.map.x),E=d(t.map.y),A=t.map.xMax,I=t.map.yMax,L=t.grid,N=L.data,k=t.overlay&&t.overlay.data,W=t.map,R=t.particles?t.particles.getVelocity(t):0,z=(W.westRad,W.west),P=W.height,U=W.width,F=Math.abs(L.dx),j=Math.abs(L.dy),B=L.destWidth,H=Math.max(L.la1,L.la2),G=L.lo1,Z=h?r.projection:null,q=e.interpolationFunction(H,G,F,j,B,v),V=e.distortionFunction(Z,U,P,W.northRad,W.southRad,W.eastRad,W.westRad),Y=t.colors.colorsArray,$=t.colors.startingValue,X=t.colors.step,J=4,K=180/Math.PI,Q=Math.PI/2,te=W.east-W.west,ee=U/te*360/(2*Math.PI),ne=ee/2*Math.log((1+Math.sin(W.southRad))/(1-Math.sin(W.southRad))),ie=P+ne,ae=new Float32Array(5),oe=o.signature([t.product,W.lat,W.lon,W.zoom,W.width,W.height,F,j,B,H,G]),se=!!t.mapDirty||oe!==b;(h||!t.mapDirty)&&(O=O?0:1),t.disableOverlay?(f[0].clearRect(0,0,U,P),f[1].clearRect(0,0,U,P)):h&&f[O].clearRect(0,0,U,P);var re=f[O].getImageData(0,0,U,P),le=re.data,ce=t.disableOverlay?function(){}:e.colorizeFunction(le,U,P),de=se?300:50,he=0|E;!function ue(){for(var e=Date.now();I>he;)if(c(he),he+=J,C++,C>20&&(C=0,Date.now()-e>de))return void(T=setTimeout(ue,50));x=t.interpolate,M=t.grid,S=t.overlay,b=oe,u.actualCanvas=O,a&&!t.disableOverlay&&(a.postMessage({imageData:re,width:U,height:P,radius:t.blur}),a.onmessage=function(t){D||f[O].putImageData(t.data,0,0)}),!h&&t.mapDirty&&l.resetCanvas(),t.disableOverlay||f[O].putImageData(re,0,0),(h||!t.mapDirty)&&(p[O].style.opacity=1,p[O?0:1].style.opacity=0),h&&t.mapDirty&&(u.particleCanvas.style.opacity=1),(se||t.particles&&t.particles.name!==m)&&(n.stop(),t.particles?(u.particleCanvas.style.opacity=1,n.run(g,t,u.particleCanvas),m=t.particles.name):(u.particleCanvas.style.opacity=0,m=null)),s()}()}function p(){window.clearTimeout(T),D=!0}var m,f=parseInt(t.maxPixels/16)+4500,g=new Float32Array(3*f),v=new Float32Array(6*f),y=new Float32Array(screen.height||700),w=new Float32Array(4*f),b="",x=null,M=null,S=null,T=null,C=0,D=!1;return{hasGrid:c,interpolateValues:h,interpolate:u,cancel:p}}),W.define("interFunctions",[],function(){function t(t,e){var n=t-e*Math.floor(t/e);return n===e?0:n}function e(t,e,n,i,a,o,s,r,l){var c,d;c=e[i]*o+e[i+3]*s+e[a]*r+e[a+3]*l,d=e[i+1]*o+e[i+4]*s+e[a+1]*r+e[a+4]*l,t[0]=c,t[1]=d,t[2]=n?n[i]*o+n[i+3]*s+n[a]*r+n[a+3]*l:Math.sqrt(c*c+d*d)}function n(t,e,n,i,a,o,s,r,l){t[2]=e[i]*o+e[i+3]*s+e[a]*r+e[a+3]*l}function i(t,e,n,i,a,o,s,r,l){isNaN(e[i])||isNaN(e[i+3])||isNaN(e[a])||isNaN(e[a+3])?t[0]=t[1]=t[2]=0/0:(t[0]=e[i]*o+e[i+3]*s+e[a]*r+e[a+3]*l,t[1]=e[i+1]*o+e[i+4]*s+e[a+1]*r+e[a+4]*l,t[2]=e[i+2]*o+e[i+5]*s+e[a+2]*r+e[a+5]*l)}function a(t,e,n,i,a,o,s,r,l){t[0]=e[i]*o+e[i+3]*s+e[a]*r+e[a+3]*l,t[1]=e[i+1]*o+e[i+4]*s+e[a+1]*r+e[a+4]*l,t[2]=e[i+2]*o+e[i+5]*s+e[a+2]*r+e[a+5]*l}function o(t,e,n,i,a,o,s,r,l){var c=e[i],d=e[i+3],h=e[a],u=e[a+3];t[2]=isNaN(c)||isNaN(d)||isNaN(h)||isNaN(u)?0/0:c*o+d*s+h*r+u*l}function s(e,n,i,a,o,s){return function(r,l,c){var d=t(l-n,360)/i,h=(e-r)/a,u=Math.floor(d),p=Math.floor(h),m=d-u,f=h-p,g=1-m,v=1-f;s[c]=3*(p*o+u),s[c+1]=3*((p+1)*o+u),s[c+2]=g*v,s[c+3]=m*v,s[c+4]=g*f,s[c+5]=m*f}}function r(e,n,i,a,o,s,r){var l=t(n-a,360)/o,c=(i-e)/s,d=Math.floor(l),h=Math.floor(c),u=l-d,p=c-h,m=1-u,f=1-p,g=m*f,v=u*f,y=m*p,w=u*p;return[3*(h*r+d),3*((h+1)*r+d),g,v,y,w]}function l(t,e,n,i,a,o,s){function r(t){return Math.log(Math.tan(t/2+l))}var l=Math.PI/4,c=r(a),d=r(i),h=e/(o-s),u=n/(d-c),p=t?function(e,n){return t([n,e])}:function(t,e){var n=(Math.deg2rad(e)-s)*h,i=(d-r(Math.deg2rad(t)))*u;return[n,i]};return function(t,e,n,i,a,o){var s=0>e?36e-6:-36e-6,r=0>t?36e-6:-36e-6,l=p(t,e+s),c=p(t+r,e),d=Math.cos(t/720*Math.PI);a[o]=(l[0]-n)/s/d,a[o+1]=(l[1]-i)/s/d,a[o+2]=(c[0]-n)/r,a[o+3]=(c[1]-i)/r}}function c(t,e,n,i,a,o){var s=t[0]*e,r=t[1]*e;return t[0]=n*s+i*r,t[1]=a*s+o*r,t}function d(t,e,n){var i=n-4|0,a=e-4|0;return t.set?function(o,s,r){var l=o-a;if(l>0&&(r=r.slice(0,4*(4-l))),s>=i)for(;n>s;s++)t.set(r,4*(s*e+o));else t.set(r,4*(s*e+o)),t.set(r,4*((s+1)*e+o)),t.set(r,4*((s+2)*e+o)),t.set(r,4*((s+3)*e+o))}:function(n,i,a){var o,s,r,l,c=a[0],d=a[1],h=a[2],u=a[3];s=4;do{r=4,l=n;do o=4*(i*e+l),t[o]=c,t[o+1]=d,t[o+2]=h,t[o+3]=u,l++;while(r--);i++}while(s--)}}return{floorMod:t,interpolateOverlay:n,interpolateAll:e,interpolateWaves:i,interpolateWaves2:a,interpolateSea:o,interpolationFunction:s,interpolatePoint:r,distortionFunction:l,distort:c,colorizeFunction:d}}),W.define("animation",["broadcast","object","globe"],function(t,e,n){function i(){window.clearTimeout(f)}function a(t,e,n,i){var a=u;a[n]=t,a[n+1]=e,a[n+2]=0,a[n+3]=0,a[n+4]=Math.floor(Math.random()*i),a[n+5]=0}function o(t,e,i,o){var s=n.dummy([150*Math.random()-75,150*Math.random()-75]),r=s[0],l=s[1];return r>=0&&l>=0&&t>=r&&e>=l?void a(r,l,i,o):!0}function s(t,e,n,i){for(;o(t,e,n,i););}function r(t,e,i,o){var s=n.dummy([150*Math.random()-75,150*Math.random()-75]);a(s[0],s[1],i,o)}function l(t,e,n,i){a(Math.random()*t,Math.random()*e,n,i)}function c(t,n,i){function a(t){return 12>t?0:25>t?1:37>t?2:62>t?3:75>t?2:85>t?1:0}function c(t){return Math.min(3,Math.floor(t/40))}function g(){var t=w.map.scale,e=w.map.width/2,n=w.map.height/2;return function(i,a,o){var s=(Math.pow(e-a,2)+Math.pow(n-o,2))/Math.pow(t,2),r=Math.min(3,Math.floor(i/3));return s>.75?r-1:s>.85?r-2:r}}function y(){var e,n,i,o,s,r,l,c,d,m,f,g,v=Math.ceil(O/4),y=h,w=u,b=p,x=6*A,M=t,S=O,C=_,D=N;if(L)for(i=0;x>i;i+=6)w[i+4]>I&&E(O,_,i,I),e=w[i],n=w[i+1],g=3*(Math.round(n/4)*v+Math.round(e/4)),T&&-1===M[g+2]||e>S||n>C||0>e||0>n?(w[i+4]=I+1,b[i+5]=10):(s=M[g],r=M[g+1],l=e+s,c=n+r,w[i]=l,w[i+1]=c,w[i+4]++,d=Math.sqrt(s*s+r*r)/2.5,m=s/d,f=r/d,b[i]=e-f,b[i+1]=n+m,b[i+2]=e+f,b[i+3]=n-m,b[i+5]=a(w[i+4]));else for(i=0;x>i;i+=6)w[i+4]>I&&E(O,_,i,I),e=w[i],n=w[i+1],g=3*(Math.round(n/4)*v+Math.round(e/4)),T&&-1===M[g+2]||e>S||n>C||0>e||0>n?(w[i+4]=I+1,w[i+5]=10):(w[i+2]=e+M[g],w[i+3]=n+M[g+1],w[i+4]++,w[i+5]=k(M[g+2],e,n));if(y.globalCompositeOperation="destination-in",y.fillRect(0,0,O,_),y.globalCompositeOperation="source-over",L)for(i=0;4>i;i++){for(y.beginPath(),y.strokeStyle=D[i],o=0;x>o;o+=6)b[o+5]===i&&(y.moveTo(b[o],b[o+1]),y.lineTo(b[o+2],b[o+3]));y.stroke()}else for(i=0;4>i;i++){for(y.beginPath(),y.strokeStyle=D[i],o=0;x>o;o+=6)w[o+5]===i&&(y.moveTo(w[o],w[o+1]),y.lineTo(w[o+2],w[o+3]),w[o]=w[o+2],w[o+1]=w[o+3]);y.stroke()}}var w;window.clearTimeout(f),i&&(d=i,h=i.getContext("2d")),h.clearRect(0,0,d.width,d.height),t?(w=e.clone(n,["map"]),w.particles=n.particles,m.rows=t,m.params=w):(t=m.rows,w=m.params);var b=w.particles;if(!v){var x,M,S,T="globe"===w.map.source,C=w.map.x,D=w.map.y,O=w.map.width,_=w.map.height,E=(w.map.xMax-C,w.map.yMax-D,T?o:l),A=b.getAmount.call(b,w),I=b.getMaxAge(),L="waves"===b.animation,N=b.getStyles.call(b,w);for(x=0,M=0;A>x;x++)E(O,_,M,I)||(M+=6);S=M/6,T&&(A=0|S,E=A>S?s:r),h.lineWidth=b.getLineWidth.call(b,w),h.fillStyle="rgba(0, 0, 0,"+b.getBlendingAlpha.call(b,w)+")";var k=T?g():c;!function W(){f=setTimeout(function(){y(),W()},40)}()}}var d,h,u=new Float32Array(9e4),p=new Float32Array(9e4),m={},f=null,g=null,v=!1;return t.on("particlesAnimation",function(t){"off"===t?(d.style.opacity=0,v=!0,g=setTimeout(i,1500)):(v=!1,clearTimeout(g),c(),d.style.opacity=1)}),n.on("movestart",i),{run:c,stop:i}}),W.define("windytyUI",["rootScope","broadcast","trans","progressBar","UIhelpers","products","Class","Evented","calendar"],function(t,e,n,i,a,o,s,r,l){function c(n){var i=n.keyCode;if(!u.hasCalendar()||37!==i&&39!==i)38===i||40===i?u.set("overlay",h.getNextItem(u.overlay,40===i),"key"):33!==i&&34!==i||"wind"!==u.overlay?(9===i||70===i)&&e.emit("focusRqstd"):u.set("level",t.levels.getNextItem(u.level,33===i),"key");else{var a=u.productObj.calendar.dayHours,o=Object.keys(a),s=Math.min(Math.max(o.indexOf(u.path)+(37===i?-1:1),0),o.length-1);u.set("path",o[s],"key")}n.preventDefault()}var d=document.getElementById("windyty-ui"),h=["wind","temp","clouds","waves","snow","pressure"];t.initialPath=t.initialPath||o.gfs.calendar.initialPath,d.onchange=function(t){var e=t.target.name,n=t.target.value;u.set(e,n,t),t.preventDefault()},d.onclick=function(t){var n=t.target,i=n.dataset.name,a=n.dataset.value;if(i){switch(i){case"initCalendar":g.reinit();break;case"overlayGroup":m.toggleGroup(n,a);break;case"barIndex":g.setIndex(a),u.set("path",g.index2path(a));break;case"play":e.emit("playPauseClicked");break;case"snowcover":u.set("overlay","snowcover",t);break;case"particles":n.classList.toggle("off"),e.emit("particlesAnimation",n.className);break;case"model":case"acTime":case"overlay":"snowcover"===u.overlay&&u.set("overlay","snow",t),u.set(i,a,t)}t.preventDefault()}};var u=r.extend({overlay:null,level:t.level,acTime:t.acTime,model:t.model,path:t.path||t.initialPath,product:null,productObj:null,historical:!1,hasCalendar:function(){return!!this.productObj.calendar},hasHistory:function(){return"gfs"===product},init:function(){var n=this;this.set("overlay",t.overlay),e.on("indexChanged",function(t){n.set("path",g.index2path(t))}),e.on("modelChanged",function(t){n.set("model",t)}),e.on("historicalPath",function(t){n.hasHistory||(n.set("overlay","wind","key",!0),n.set("model","gfs","key",!0)),n.set("path",t)}),this.emit("init",this.productObj)},set:function(t,e,n,i){if(this[t]!=e){if(this[t]=e,this.emit(t,e,n),"overlay"!==t&&"model"!==t)return void this.emitOut(t,i);var a=o.getProductString(u.overlay,this.model===p.betterFcst?this.model:null);a!==this.product?(this.product=a,this.productObj=o[a],this._initProduct(a,function(){this.emit("product",a,this.productObj),this.productObj.calendar&&g.getIndex()>this.productObj.calendar.maxIndex&&(g.setIndex(this.productObj.calendar.maxIndex),this.path=g.index2path(this.productObj.calendar.maxIndex),this.emit("path",this.path)),this.emitOut("overlay+product",i)}.bind(this))):this.emitOut("overlay",i)}},emitOut:function(t,n){n||e.emit("paramsChanged",this,t)},_initProduct:function(t,e){var n=o[t];n.productReady?e():n.init(e)},toDefaults:function(){this.set("path",t.initialPath,"key",!0),this.set("level","surface","key",!0),this.set("acTime","next24h","key",!0),this.set("model","gfs","key",!0),this.set("overlay","wind","key")},disableKeyboard:function(){document.body.addEventListener("keydown",c)},enableKeyboard:function(){document.body.removeEventListener("keydown",c)}}),p=a.divs.extend({form:d,divsId:"model",betterFcst:"",mbeuropeMessage:!0,onchange:function(t){this.setDivs(t)},onProductChange:function(t){document.getElementById("mb-info").className=t},toggleBetterFcst:function(t){if(this.mbeuropeMessage&&"mbeurope"===t){var e=document.getElementById("message-nems");this.mbeuropeMessage=!1,e.className="show",setTimeout(function(){e.className=""},1e4)}this.betterFcst=t,document.getElementById("settings").className=t||""},_init:function(){e.on("betterFcst",this.toggleBetterFcst.bind(this)),u.on("model",this.onchange.bind(this)),u.on("product",this.onProductChange.bind(this)),this.set(u.model)}}),m=(a.select.extend(a.divs,{form:d,selectId:"#acc-select",divsId:"acTime",onchange:function(t,e){this.setDivs(t),!e||"key"!==e&&"acc-select"===e.target.id||this.setSelect(t)},onProductChange:function(t){this.setDivs("snowcover"===t?-1:u.acTime)},_init:function(){u.on("acTime",this.onchange.bind(this)),u.on("product",this.onProductChange.bind(this)),this.set(u.acTime)},set:function(t){this.setSelect(t),this.setDivs(t)}}),a.divs.extend({form:d,divsId:"overlay",onchange:function(t){/sst|sstanom/.test(t)&&this.set(t)},_init:function(){u.on("overlay",this.onchange.bind(this))}}),a.select.extend({form:d,selectId:"#level-select",onchange:function(t,e){"key"===e&&this.set(t)},_init:function(){u.on("level",this.onchange.bind(this)),this.set(u.level)}}),a.select.extend({form:d,selectId:"#overlay-select",groups:{1:["gust"],2:["rh","lclouds","rain"],3:["sst","sstanom","wwaves","swell","swellperiod"]},onchange:function(t,e){"snowcover"!==t&&e&&("key"===e?(u.loaderOffset=44,this.setRadios(t),this.setSelect(t)):"overlay-select"===e.target.id?(u.loaderOffset=0,this.setRadios(t)):(u.loaderOffset=e.target.offsetTop||44,this.setSelect(t)))},toggleGroup:function(t,e){var n="up"===t.className;n?this.groups[e].indexOf(u.overlay)<0&&this.closeGroup(e):this.openGroup(e)},openGroup:function(t){document.getElementById("overlayGroupSpan"+t).className="up",document.getElementById("overlayGroup"+t).classList.add("show")},closeGroup:function(t){document.getElementById("overlayGroupSpan"+t).className="",document.getElementById("overlayGroup"+t).classList.remove("show")},setRadios:function(t){var e=d.querySelector('input[type="radio"][value="'+t+'"]');if(e){for(var n in this.groups)this.groups[n].indexOf(t)>-1?this.openGroup(n):this.closeGroup(n);e.checked=!0}},_init:function(){u.on("overlay",this.onchange.bind(this)),this.set(t.overlay)},set:function(t){"snowcover"===t&&(t="snow"),this.setSelect(t),this.setRadios(t)}})),f=s.extend({element:document.getElementById("bottom"),onchange:function(t){switch(t){case"rain":case"snow":case"snowcover":this.element.className="shy UIaccumulations "+t;break;case"sst":case"sstanom":this.element.className="shy UIsst "+t;break;default:this.element.className="shy UIcalendar "+t}},_init:function(){u.on("overlay",this.onchange.bind(this)),this.set(u.overlay)},set:function(t){this.onchange(t)}}),g=(f.extend({element:document.getElementById("snowcover-btn"),onchange:function(t){"snowcover"===t?this.element.classList.add("selected"):this.element.classList.remove("selected")},_init:function(){u.on("product",this.onchange.bind(this)),this.set(u.product)}}),a.select.extend(i,{form:d,selectId:"select.calendar-select",textArea:d.querySelector("#datetime .text"),calendar:o.gfs.calendar,pbwElement:document.getElementById("progress-bar-wrapper"),index2path:function(t){return this.calendar.index2path(t)},onchange:function(t,e){"key"===e?(this.setIndex(this.calendar.path2index(t)),this.setSelect(t),this.textArea.innerHTML=this.calendar.path2string(t)):e&&"calendar-select"===e.target.className?this.setIndex(this.calendar.path2index(t)):this.setSelect(t)
},onProductChange:function(t,e){var n=e.calendar;n&&this.calendar!==n&&(this.calendar=n,this.set(u.path))},oninit:function(t){this.calendar=t.calendar||this.calendar,this.textArea.innerHTML=this.calendar.path2string(u.path),e.on("langChanged",function(){this.textArea.innerHTML=this.calendar.path2string(u.path)}.bind(this));var n=this.calendar.path2index(u.path);0>n?this.setHistorical(u.path):(this.set(u.path),this.setIndex(n)),u.on("path",this.onchange.bind(this)),u.on("product",this.onProductChange.bind(this)),e.on("langChanged",function(){this.set(u.path)}.bind(this))},reinit:function(){this.calendar=o.gfs.calendar,this.set(t.initialPath),u.historical=!1,u.set("path",t.initialPath,"key"),document.body.classList.remove("historical")},_init:function(){u.once("init",this.oninit.bind(this)),e.on("historicalPath",this.setHistorical.bind(this)),e.on("earlierPath",this.setEarlier.bind(this))},setEarlier:function(){var t=this.calendar.startOfTimeline.add(-4,"days").midnight();t>new Date(2015,0,1)&&e.emit("historicalPath",this.calendar.date2path(t))},setHistorical:function(t){this.calendar=l({numOfDays:10,calendarDays:10,startOfTimeline:this.calendar.path2date(t).add(-5,"days").midnight()}),document.body.classList.add("historical"),u.historical=!0,this.set(t),this.setIndex(this.calendar.path2index(t))},set:function(t){function e(t){return t.display?n[t.display]+" "+t.day:t.day+"."+t.month+"."+t.year}function i(t){return t.text?n[t.text]+" "+t.day+" - "+t.hour:t.day+"."+t.month+" - "+t.hour}var a,o,s="",r="",l=this.calendar.days,c=l.length,h=100/c,u=this.calendar.dayHours;for(o=0;c>o;o++)a=l[o],s+=(a.clickable?'<div data-name="barIndex" data-value="'+a.index+'" class="clickable"':"<div")+' style="width:'+h+'%;">'+e(a)+"</div>";document.getElementById("calendar").innerHTML=s;for(o in u)a=u[o],r+='<option value="'+o+'"'+(o===t?' selected="true" ':"")+">"+i(a)+"</option>";d.querySelector(".calendar-select").innerHTML=r,this.init(c,this.calendar)}}));return u.init(),u.disableKeyboard(),u}),W.define("progressBar",["broadcast","settings","helpers","trans"],function(t,e,n,i){function a(){return u}var o,s,r,l,c,d=0,h=30,u=.1,p=document.getElementById("progress-bar"),m=document.getElementById("progress"),f=e.getHoursFunction();t.once("blur",function(){setTimeout(function(){document.getElementById("progress-bar-wrapper").className=""},1e4)});var g=W.Class.extend({div:document.getElementById("timecode"),text:document.getElementById("timecode-box"),progressLine:document.getElementById("progress-line"),dragging:!1,left:null,calendar:null,calendarDays:0,w:50,update:function(t,e){return this.left=e||Math.max(0,Math.min(c,t.clientX-o)),this.progressLine.style.width=this.div.style.left=this.left+"px",this.text.textContent=this.createText(),this.left},createText:function(){if(this.left<h)return i.EARLIER;var t="",e=this.left-h;if(this.calendar){var n=this.calendar[Math.floor(this.calendarDays*e/d)];if(!n)return;t=n.display?i[n.displayLong]+(n.day&&" "+n.day)+" - ":n.day+"."+n.month+": "}return t+=f(parseInt(e/d*r)%24)},bcast:function(){u=(this.left-h)/d,0>u?t.emit("earlierPath"):t.emit("indexChanged",u)},addAnimation:function(){this.div.style.transition=this.progressLine.style.transition="all ease-in-out 250ms"},removeAnimation:function(){window.setTimeout(function(){this.div.style.transition=this.progressLine.style.transition=null}.bind(this),300)},dragBox:function(t){this.update(t)},touchBox:function(t){this.update(t.touches&&1===t.touches.length?t.touches[0]:t),t.preventDefault()},endDrag:function(){this.dragging=!1,this.bcast();var t=this.text.getClientRects()[0];t&&(this.w=t.width),window.removeEventListener("mousemove",this.dragBoxFun),window.removeEventListener("mouseup",this.endDragFun)},endTouch:function(){this.dragging=!1,this.bcast(),window.removeEventListener("touchmove",this.touchBoxFun),window.removeEventListener("touchend",this.endTouchFun)},startDrag:function(){this.dragging=!0,window.addEventListener("mousemove",this.dragBoxFun),window.addEventListener("mouseup",this.endDragFun)},startTouch:function(){this.dragging=!0,window.addEventListener("touchmove",this.touchBoxFun),window.addEventListener("touchend",this.endTouchFun)},click:function(t){this.dragging||(this.addAnimation(),this.update(t),this.bcast(),this.removeAnimation())},setIndex:function(t,e){e||this.addAnimation(),u=t,this.update(null,t*d+h)+"px",e||this.removeAnimation()},init:function(t,e){e&&(this.type=e.type,this.calendar=e.days,this.calendarDays=this.calendar.length),s=t||14,r=24*s,l=e&&e.maxIndex||1,this.resize()},resize:function(){this.recalculate(),c=l*d+h,m.style.width=c+"px",this.setIndex(u)},recalculate:function(){var t=p.getClientRects()[0];t&&(o=t.left,d=t.width)},_init:function(){this.dragBoxFun=this.dragBox.bind(this),this.endDragFun=this.endDrag.bind(this),this.touchBoxFun=this.touchBox.bind(this),this.endTouchFun=this.endTouch.bind(this),this.div.addEventListener("mousedown",this.startDrag.bind(this)),this.div.addEventListener("touchstart",this.startTouch.bind(this)),m.addEventListener("click",this.click.bind(this)),window.addEventListener("resize",n.debounce(this.resize.bind(this),100))}});return g.extend({div:document.getElementById("ghost-timecode"),text:document.getElementById("ghost-box"),calendar:null,left:0,update:function(t){this.left=Math.max(0,Math.min(c,t.clientX-o)),this.div.style.left=this.left+"px",this.div.style["margin-top"]=g.left-this.left<30&&this.left-g.left<g.w?"-25px":"-10px",this.text.textContent=this.createText()},_init:function(){var t=this;m.addEventListener("mouseenter",function(){g.dragging||(t.div.style.opacity=1)}),m.addEventListener("mousemove",function(e){g.dragging?t.div.style.opacity=0:t.update(e)}),m.addEventListener("mouseleave",function(){t.div.style.opacity=0})}}),{setIndex:g.setIndex.bind(g),getIndex:a,init:g.init.bind(g)}}),W.define("legend",["overlays","broadcast"],function(){}),W.define("productInfo",["broadcast","products","trans"],function(t,e,n){function i(){o.className="show"}function a(){o.className=""}var o=document.getElementById("productinfo"),s=document.getElementById("model-info");t.on("redrawFinished",function(t){var i,a,s=e[t.product],r=new Date(t.lastModified),l=Math.floor((Date.now()-r.getTime())/6e4);a=60>l?l+"m ago":Math.floor(l/60)+"h ago",i="<span>"+n.MENU_F_MODEL+"</span>: "+s.model+" <br /><span>"+n.MENU_U_INTERVAL+"</span>: "+s.interval+" <br /><span>"+n.MENU_D_UPDATED+"</span>: "+a+"<br />",o.innerHTML=i}),s.onmouseenter=i,s.onmouseleave=a}),W.define("UIhelpers",["Class"],function(t){var e={};return e.setSelect=function(t,e,n){var i=t.querySelector(e),a=t.querySelector(e+' > option[value="'+n+'"]');i&&a?i.selectedIndex=a.index||0:console.warn("Failed to set value for",e,n)},e.setDivs=function(t,e,n){var i,a=t.querySelector('div[data-name="'+e+'"][data-value="'+n+'"]')||t.querySelector('div[data-name="'+e+'"]'),o=a.dataset.value,s=a.parentNode.children;for(i=0;i<s.length;i++)-1===n?s[i].classList.remove("selected"):o===s[i].dataset.value?s[i].classList.add("selected"):s[i].classList.remove("selected")},e.select=t.extend({setSelect:function(t){e.setSelect(this.form,this.selectId,t)},set:function(t){this.setSelect(t)}}),e.divs=t.extend({setDivs:function(t){e.setDivs(this.form,this.divsId,t)},set:function(t){this.setDivs(t)}}),e}),W.define("windytyCtrl",["task","windytyUI","broadcast","rootScope","object","products","progressBar","log"],function(t,e,n,i,a,o,s,r){function l(){d?(d.mapDirty=!0,"interpolation"===d.status&&(d.cancel(),d.display())):h?(h.cancel(),h.mapDirty=!0,h.display()):c(e)}function c(e){d&&d.cancel(),h&&h.cancel(),d=t({mapDirty:!1,params:a.clone(e,["path","acTime","level","overlay","product","model","historical"]),product:o[e.product]}),d.params.map=a.clone(i.map),u.isRunning&&(d.params.fromAnimation=!0),d.load(function(){h=d,d=null,u.isRunning&&(u.semaphore=!1)})}var d=null,h=null,u={isRunning:!1,semaphore:!1,timer:null,button:document.getElementById("playpause"),buttonMobile:document.getElementById("playpause-mobile"),pbWrapper:document.getElementById("progress-bar-wrapper"),start:function(){return h&&h.product?(this.isRunning=!0,this.button.className="pause",this.buttonMobile.className="pause",this.pbWrapper.className="onanimation",this.run(),void n.emit("animationStarted")):void r.event("tried to run animation on void finisheTask")},stop:function(){this.semaphore=!1,this.isRunning=!1,this.button.className="play",this.buttonMobile.className="play",this.pbWrapper.className="",clearTimeout(this.timer),n.emit("animationStopped")},toggle:function(){this.isRunning?this.stop():this.start()},run:function(){var t=h.product,e=s.getIndex();return!t.animation||e>=t.calendar.maxIndex?void this.stop():(this.semaphore||(e+=25e-5,s.setIndex(e,!0),n.emit("indexChanged",e)),void(this.timer=setTimeout(this.run.bind(this),50)))}};n.on("paramsChanged",c),n.on("mapChanged",l),n.on("playPauseClicked",u.toggle.bind(u)),document.getElementById("title").onclick=function(){n.emit("closePopup"),n.emit("closeAll"),i.geoIP&&n.emit("mapsCenter",i.geoIP),e.toDefaults()}}),L.CanvasOverlay=L.Class.extend({canvas:function(){return[this._canvas1,this._canvas2,this._canvas3]},redraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},reset:function(){this._reset()},onAdd:function(t){this._map=t,this._canvas1=L.DomUtil.create("canvas","leaflet-canvas1"),this._canvas2=L.DomUtil.create("canvas","leaflet-canvas2"),this._canvas3=L.DomUtil.create("canvas","leaflet-canvas3");var e=this._map.getSize();this._canvas1.width=this._canvas2.width=this._canvas3.width=e.x,this._canvas1.height=this._canvas2.height=this._canvas3.height=e.y;var n=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas1,"leaflet-zoom-"+(n?"animated":"hide")),L.DomUtil.addClass(this._canvas2,"leaflet-zoom-"+(n?"animated":"hide")),L.DomUtil.addClass(this._canvas3,"leaflet-zoom-"+(n?"animated":"hide")),t._panes.overlayPane.appendChild(this._canvas1),t._panes.overlayPane.appendChild(this._canvas2),t._panes.overlayPane.appendChild(this._canvas3),t.on("moveend",this._redraw,this),t.on("resize",this._resize,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset(),this._redraw()},addTo:function(t){return t.addLayer(this),this},_resize:function(t){this._canvas1.width=this._canvas2.width=this._canvas3.width=t.newSize.x,this._canvas1.height=this._canvas2.height=this._canvas3.height=t.newSize.y},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas1,t),L.DomUtil.setPosition(this._canvas2,t),L.DomUtil.setPosition(this._canvas3,t)},_redraw:function(){var t=this._map.getSize(),e=this._map.getBounds();180*t.x/(20037508.34*(e.getEast()-e.getWest())),this._map.getZoom(),this._frame=null},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),n=this._map._getCenterOffset(t.center)._multiplyBy(-e).subtract(this._map._getMapPanePos());this._canvas1.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(n)+" scale("+e+")",this._canvas2.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(n)+" scale("+e+")",this._canvas3.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(n)+" scale("+e+")"}}),L.canvasOverlay=function(){return new L.CanvasOverlay},W.define("mapsCtrl",["rootScope","storage","settings","storage","broadcast","http","globe","maps","object","log","location","geolocation"],function(t,e,n,e,i,a,o,s,r,l){function c(t){g=n.get("3d"),m=g?t.zoom>=5?s:o:s,d(m,t)}function d(t,e){var n={lat:parseFloat(e.lat).bound(-80,80),lon:parseFloat(e.lon),zoom:e.zoom,scale:e.scale,panto:e.panto,animation:!1};t.init(n).then(function(e){m=t,t===s?(f.style.opacity=0,f.style["pointer-events"]="none",setTimeout(function(){f.style.display="none"},1e3)):(f.style.display="block",f.style["pointer-events"]="auto",f.style.opacity=1),i.emit("projectionChanged",m.ident),u(e)})["catch"](function(){t===o&&(l.event("Failed to install globe"),g=!1,d(s,e))})}function h(t){"globe"===t.source&&t.scale>720?(t.zoom=5,d(s,t)):"maps"===t.source&&t.zoom<5&&g?(t.scale=700,d(o,t)):u(t)}function u(e){t.map.zoom!==e.zoom&&(document.body.classList.remove("zoom"+t.map.zoom),document.body.classList.add("zoom"+e.zoom)),t.map=r.clone(e,["source","lat","lon","south","north","east","west","width","height","x","y","xMax","yMax","zoom","scale"]),r.include(t.map,{southRad:Math.deg2rad(e.south),northRad:Math.deg2rad(e.north),eastRad:Math.deg2rad(e.east),westRad:Math.deg2rad(e.west)}),i.emit("mapChanged",t.map)}function p(t){m!==s?d(s,t):s.center(t)}var m=null,f=document.getElementById("globe_container");t.useRetina=t.isRetina&&n.get("retina");var g;t.map={};var v;if((v=e.get("homeLocation"))&&n.get("weather"))c(v);else if(t.sharedCoords)c(t.sharedCoords);else if(t.geoIP)c(t.geoIP);else{var y=(new Date).getTimezoneOffset()/4;c({lat:0,lon:0>y?-y:-180+y,zoom:4}),l.event("GeoIP missing !!!")}return o.on("globeMoveend",h),s.on("mapsMoveend",h),i.on("settingsChanged",function(e){"3d"===e&&c(t.map)}),i.on("popupRequested",function(t,e){i.emit((m===o?"globe":"maps")+"PopupRequested",t,e)}),i.on("mapsCenter",p),{getCanvas:function(){return m.canvases},center:p,ensureLeaflet:function(){if(g=!1,m===o){var t=o.info();t.zoom=5,d(s,t)}},stopEnsureLeaflet:function(){c(m.info())}}}),W.define("maps",["rootScope","settings","object","broadcast"],function(t,e,n,i){var a={hereterrain:"https://{s}.aerial.maps.cit.api.here.com/maptile/2.1/maptile/newest/terrain.day/{z}/{x}/{y}/256/png8?"+t.hereMapsID,heresat:"https://{s}.aerial.maps.cit.api.here.com/maptile/2.1/maptile/newest/satellite.day/{z}/{x}/{y}/256/png8?"+t.hereMapsID,esritopo:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"},a={hereterrain:"https://{s}.aerial.maps.cit.api.here.com/maptile/2.1/maptile/newest/terrain.day/{z}/{x}/{y}/256/png8?app_id=2yTlzUbMV1TBRGbV4gku&app_code=TZTnvk1XubIKNT35MCbYgQ",heresat:"https://{s}.aerial.maps.cit.api.here.com/maptile/2.1/maptile/newest/satellite.day/{z}/{x}/{y}/256/png8?app_id=2yTlzUbMV1TBRGbV4gku&app_code=TZTnvk1XubIKNT35MCbYgQ",esritopo:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"};L.Map.addInitHook(function(){function t(t){function a(){i.fire("singleclick",L.Util.extend(t,{type:"singleclick"}))}e(),n=setTimeout(a,500)}function e(){n&&(clearTimeout(n),n=null)}var n,i=this;i.on&&(i.on("click",t),i.on("dblclick",function(){setTimeout(e,0)}))});var o=L.map("map_container",{zoomControl:!1,keyboard:!1,worldCopyJump:!0});return L.control.zoom({position:"topright"}).addTo(o),n.include(o,{ident:"maps",isInit:!1,minZoom:4,graticule:[],myMarkers:{webcam:L.icon({iconUrl:"img/marker-webcam.png",shadowUrl:"img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[15,41],iconSize:[26,36],iconAnchor:[13,36]}),icon:L.divIcon({className:"icon-dot",html:'<div class="pulsating-icon"></div>',iconSize:[10,10],iconAnchor:[5,5]})},init:function(n){return this.isInit?this.center(n):(this.center(n),this.initTiles(),this.initCanvas(),this.drawGraticule(),this.on("moveend",this.moveEnd.bind(this)),this.on("resize",this.resizeEnd.bind(this)),this.on("contextmenu",function(){o.zoomOut()}),i.on("settingsChanged",function(n){switch(n){case"map":o.initTiles();break;case"retina":t.useRetina=t.isRetina&&e.get("retina"),o.initTiles(),o.rescaleCanvas();break;case"graticule":o.drawGraticule()}}),this.isInit=!0,Promise.resolve(this.info()))},drawGraticule:function(){if(e.get("graticule")){for(var t={stroke:!0,color:"#a0a0a0",opacity:.8,weight:.8,clickable:!1},n=-80;81>n;n+=10)o.graticule.push(L.polyline([[n,-180],[n,180]],t).addTo(o));for(var i=-180;181>i;i+=10)o.graticule.push(L.polyline([[-90,i],[90,i]],t).addTo(o))}else for(var a=0;a<o.graticule.length;a++)o.removeLayer(o.graticule[a])},initCanvas:function(){var t=L.canvasOverlay().addTo(o),e=t.canvas();this.canvases={particleCanvas:e[0],overlayCanvas:[e[1],e[2]],actualCanvas:0},this.resetCanvas=t.reset.bind(t),e[2].style.opacity=0,this.rescaleCanvas()},initTiles:function(){var n=a[e.get("map")];L.TileLayer.multi({11:{url:t.tileServer+(t.useRetina?"rtnv3":"v5")+"/{z}/{x}/{y}.jpg",subdomains:"1234"},17:{url:n,subdomains:"1234"},11:{url:"http://api.tiles.mapbox.com/v4/ludawei.mn69agep/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibHVkYXdlaSIsImEiOiJldzV1SVIwIn0.-gaUYss5MkQMyem_IOskdA&v=1.1",subdomains:"1234"}},{detectRetina:t.useRetina,minZoom:3,maxZoom:t.maxZoom}).addTo(o)},center:function(t){var e="undefined"==typeof t.zoom?null:t.zoom.bound(o.minZoom,20),n=!!t.animation;if(t.panto){var i=o.getSize().x;o.panTo([t.lat,t.lon],{animate:!1}),e&&o.setZoom(e,{animate:!1}),o.panBy([(i-t.panto)/2-i/2,0],{animate:!1})}else o.setView([t.lat,t.lon],e,{animate:n});return Promise.resolve(o.info())},moveEnd:function(){this.fire("mapsMoveend",this.info())},resizeEnd:function(){o.rescaleCanvas(),this.fire("mapsMoveend",this.info())},rescaleCanvas:function(){var e=o.canvases.particleCanvas,n=t.useRetina?window.devicePixelRatio||1:1,i=o.getSize(),a=i.x,s=i.y;e.width=a*n,e.height=s*n,e.style.width=a+"px",e.style.height=s+"px",e.getContext("2d").scale(n,n)},info:function(){var t=o.getCenter(),e=o.getBounds(),n=o.getSize();return{source:"maps",lat:t.lat,lon:t.wrap().lng,south:e._southWest.lat,north:e._northEast.lat,east:e._northEast.lng,west:e._southWest.lng,width:n.x,height:n.y,x:0,y:0,xMax:n.x,yMax:n.y,zoom:o.getZoom()}}}),o}),W.define("globe",["rootScope","http","settings","broadcast","storage","helpers","globeCtrl"],function(t,e,n,i,a,o,s){var r=W.Evented.extend({ident:"globe",isInit:!1,minZoom:150,maxZoom:800,drawStamp:0,getZoom:function(){return Math.round(.008*(this.projection.scale()-200)).bound(0,4)},setScale:function(t){this.projection.scale(t),this.dummy.scale(t),this.zoom.scale(t),this.scale=t},initCanvas:function(){var e,n,i=[],a=window.devicePixelRatio||1;for(n=0;5>n;n++)e=document.getElementById("globeCanvas"+n),a>1&&(0===n||4===n)&&t.useRetina?(e.width=this.w*a,e.height=this.h*a,e.style.width=this.w+"px",e.style.height=this.h+"px",e.getContext("2d").scale(a,a)):(e.width=this.w,e.height=this.h),i[n]=e;this.canvas=i[4],this.context=this.canvas.getContext("2d"),this.mask=i[3],this.maskCtx=this.mask.getContext("2d"),this.canvases={particleCanvas:i[0],overlayCanvas:[i[1],i[2]],actualCanvas:0},this.canvases.overlayCanvas[1].style.opacity=0},initZoom:function(){var e=document.getElementById("map_container");this.w=e.offsetWidth,this.h=e.offsetHeight,this.xCenter=this.w/2,this.yCenter=this.h/2;var n=Math.min(this.w,this.h);this.startingZoom=((t.isMobile?.98:.97)*n/2).bound(this.minZoom,700)},initMap:function(t){this.graticule=d3.geo.graticule(),this.grid=this.graticule(),this.projection=d3.geo.orthographic().scale(this.startingZoom).rotate([-t.lon,-t.lat,0]).translate([this.xCenter,this.yCenter]).clipAngle(90),this.path=d3.geo.path().projection(this.projection).context(this.context),this.dummy=d3.geo.orthographic().scale(this.startingZoom).translate([this.xCenter,this.yCenter]).clipAngle(90),this.precision=this.projection.precision(),this.scale=this.projection.scale()},center:function(t){return this.projection.rotate([-t.lon,-t.lat,0]),t.scale&&this.setScale(t.scale),this.draw(),this.drawMask(),Promise.resolve(this.info())},isVisible:function(t,e){return Math.pow(this.xCenter-t,2)+Math.pow(this.yCenter-e,2)<Math.pow(this.scale,2)},info:function(){var t=this.path.bounds({type:"Sphere"}),e=this.projection.rotate();return{source:"globe",lat:-e[1],lon:-e[0],south:-90,north:90,east:360,west:0,x:Math.max(Math.floor(t[0][0],0),0),y:Math.max(Math.floor(t[0][1],0),0),xMax:Math.min(Math.ceil(t[1][0],this.w),this.w-1),yMax:Math.min(Math.ceil(t[1][1],this.h),this.h-1),width:this.w,height:this.h,zoom:this.getZoom(),scale:this.projection.scale()}},init:function(e){var r=this;return this.isInit?this.center(e):new Promise(function(l,c){r.initZoom(),r.initCanvas(),r.initMap(e),r.globeController=s.call(r),a.getFile("world.json","objects").then(r.initData.bind(r)).then(r.center.bind(r,e)).then(function(){setTimeout(r.loadDetailed.bind(r),100),l(r.info())})["catch"](c),window.addEventListener("resize",o.debounce(r.resize.bind(r),200)),window.addEventListener("orientationchange",r.resize.bind(r)),i.on("settingsChanged",function(e){"retina"===e&&(t.useRetina=t.isRetina&&n.get("retina"),r.resize())}),i.on("redrawFinished",function(t){"globe"===t.map.source&&r.scale>400&&r.draw.call(r,!1,!0)}),r.isInit=!0})},loadDetailed:function(){var t=this;a.getFile("worldDetailed.json","objects").then(function(e){t.landDetailed=topojson.feature(e,e.objects.land)})},resize:function(){this.initZoom(),this.initCanvas(),this.projection.translate([this.xCenter,this.yCenter]),this.dummy.translate([this.xCenter,this.yCenter]),this.draw(),this.drawMask(),this.emit("globeMoveend",this.info())},initData:function(t){this.land=topojson.feature(t,t.objects.land),this.borders=topojson.mesh(t,t.objects.countries,function(t,e){return t.id!==e.id}),this.lakes=topojson.feature(t,t.objects.ne_110m_lakes)},drawMask:function(t){var e=this.maskCtx.createRadialGradient(this.xCenter,this.yCenter,.69*this.scale,this.xCenter,this.yCenter,this.scale-2);t?e.addColorStop(.99,"rgba(40,40,40,0)"):(e.addColorStop(0,"rgba(40,40,40,0)"),e.addColorStop(.7,"rgba(40,40,40,0.15)"),e.addColorStop(.8,"rgba(40,40,40,0.2)"),e.addColorStop(.98,"rgba(40,40,40,0.5)"),e.addColorStop(.99,"rgba(40,40,40,0.7)")),e.addColorStop(1,"rgba(40,40,40,1)"),this.maskCtx.clearRect(0,0,this.w,this.h),this.maskCtx.fillStyle=e,this.maskCtx.fillRect(0,0,this.w,this.h)},draw:function(t){t&&Date.now()-this.drawStamp<30||(t||this.projection.precision(this.precision),this.context.clearRect(0,0,this.w,this.h),this.context.beginPath(),this.path(this.land),this.context.fillStyle="#858585",this.context.fill(),this.context.strokeStyle="#e0e0e0",this.context.lineWidth=1,this.context.stroke(),t||(this.context.beginPath(),this.path(this.borders),this.context.strokeStyle="#484848",this.context.lineWidth=.7,this.context.stroke(),this.context.beginPath(),this.path(this.lakes),this.context.fillStyle="#454545",this.context.fill()),this.context.beginPath(),this.path(this.grid),this.context.lineWidth=.5,this.context.strokeStyle="#a0a0a0",this.context.stroke(),this.drawStamp=Date.now())}});return r}),W.define("globeCtrl",["rootScope","broadcast","helpers","object"],function(){return function(){}}),W.define("picker",["broadcast","maps","interpolation","trans","overlays","rootScope"],function(){}),W.define("pickerGlobe",["broadcast","interpolation","globe","picker"],function(){});