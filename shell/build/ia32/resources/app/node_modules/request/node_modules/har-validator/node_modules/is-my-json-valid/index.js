var genobj=require("generate-object-property"),genfun=require("generate-function"),jsonpointer=require("jsonpointer"),xtend=require("xtend"),formats=require("./formats"),get=function(e,r,t){var n=function(e){return e&&e.id===t?e:"object"==typeof e&&e?Object.keys(e).reduce(function(r,t){return r||n(e[t])},null):null},i=n(e);if(i)return i;t=t.replace(/^#/,""),t=t.replace(/\/$/,"");try{return jsonpointer.get(e,decodeURI(t))}catch(s){var o,a=t.indexOf("#");if(0!==a)if(-1===a)o=r[t];else{var f=t.slice(0,a);o=r[f];var u=t.slice(a).replace(/^#/,"");try{return jsonpointer.get(o,u)}catch(s){}}else o=r[t];return o||null}},formatName=function(e){e=JSON.stringify(e);for(var r=/\[([^\[\]"]+)\]/;r.test(e);)e=e.replace(r,'."+$1+"');return e},types={};types.any=function(){return"true"},types.null=function(e){return e+" === null"},types.boolean=function(e){return"typeof "+e+' === "boolean"'},types.array=function(e){return"Array.isArray("+e+")"},types.object=function(e){return"typeof "+e+' === "object" && '+e+" && !Array.isArray("+e+")"},types.number=function(e){return"typeof "+e+' === "number"'},types.integer=function(e){return"typeof "+e+' === "number" && (Math.floor('+e+") === "+e+" || "+e+" > 9007199254740992 || "+e+" < -9007199254740992)"},types.string=function(e){return"typeof "+e+' === "string"'};var unique=function(e){for(var r=[],t=0;t<e.length;t++)r.push("object"==typeof e[t]?JSON.stringify(e[t]):e[t]);for(var t=1;t<r.length;t++)if(r.indexOf(r[t])!==t)return!1;return!0},isMultipleOf=function(e,r){var t,n=(0|r)!==r?Math.pow(10,r.toString().split(".").pop().length):1;if(n>1){var i=(0|e)!==e?Math.pow(10,e.toString().split(".").pop().length):1;t=i>n?!0:Math.round(n*e)%(n*r)}else t=e%r;return!t},toType=function(e){return e.type},compile=function(e,r,t,n,i){var s=i?xtend(formats,i.formats):formats,o={unique:unique,formats:s,isMultipleOf:isMultipleOf},a=i?!!i.verbose:!1,f=i&&void 0!==i.greedy?i.greedy:!1,u={},l=function(e){return e+(u[e]=(u[e]||0)+1)},c={},m=function(e){if(c[e])return c[e];var r=l("pattern");return o[r]=new RegExp(e),c[e]=r,r},p=["i","j","k","l","m","n","o","p","q","r","s","t","u","v","x","y","z"],y=function(){var e=p.shift();return p.push(e+e[0]),e},d=function(e,n,u,c){var p=n.properties,v=n.type,h=!1;Array.isArray(n.items)&&(p={},n.items.forEach(function(e,r){p[r]=e}),v="array",h=!0);var b=0,j=function(r,t,n){g("errors++"),u===!0&&(g("if (validate.errors === null) validate.errors = []"),a?g("validate.errors.push({field:%s,message:%s,value:%s,type:%s})",formatName(t||e),JSON.stringify(r),n||e,JSON.stringify(v)):g("validate.errors.push({field:%s,message:%s})",formatName(t||e),JSON.stringify(r)))};n.required===!0?(b++,g("if (%s === undefined) {",e),j("is required"),g("} else {")):(b++,g("if (%s !== undefined) {",e));var O=[].concat(v).map(function(r){return types[r||"any"](e)}).join(" || ")||"true";if("true"!==O&&(b++,g("if (!(%s)) {",O),j("is the wrong type"),g("} else {")),h)if(n.additionalItems===!1)g("if (%s.length > %d) {",e,n.items.length),j("has additional items"),g("}");else if(n.additionalItems){var x=y();g("for (var %s = %d; %s < %s.length; %s++) {",x,n.items.length,x,e,x),d(e+"["+x+"]",n.additionalItems,u,c),g("}")}if(n.format&&s[n.format]){"string"!==v&&formats[n.format]&&g("if (%s) {",types.string(e));var q=l("format");o[q]=s[n.format],"function"==typeof o[q]?g("if (!%s(%s)) {",q,e):g("if (!%s.test(%s)) {",q,e),j("must be "+n.format+" format"),g("}"),"string"!==v&&formats[n.format]&&g("}")}if(Array.isArray(n.required)){var N=function(r){var t=genobj(e,r);g("if (%s === undefined) {",t),j("is required",t),g("missing++"),g("}")};g("if ((%s)) {","object"!==v?types.object(e):"true"),g("var missing = 0"),n.required.map(N),g("}"),f||(g("if (missing === 0) {"),b++)}if(n.uniqueItems&&("array"!==v&&g("if (%s) {",types.array(e)),g("if (!(unique(%s))) {",e),j("must be unique"),g("}"),"array"!==v&&g("}")),n.enum){var S=n.enum.some(function(e){return"object"==typeof e}),A=S?function(r){return"JSON.stringify("+e+") !== JSON.stringify("+JSON.stringify(r)+")"}:function(r){return e+" !== "+JSON.stringify(r)};g("if (%s) {",n.enum.map(A).join(" && ")||"false"),j("must be an enum value"),g("}")}if(n.dependencies&&("object"!==v&&g("if (%s) {",types.object(e)),Object.keys(n.dependencies).forEach(function(r){var t=n.dependencies[r];"string"==typeof t&&(t=[t]);var i=function(r){return genobj(e,r)+" !== undefined"};Array.isArray(t)&&(g("if (%s !== undefined && !(%s)) {",genobj(e,r),t.map(i).join(" && ")||"true"),j("dependencies not set"),g("}")),"object"==typeof t&&(g("if (%s !== undefined) {",genobj(e,r)),d(e,t,u,c),g("}"))}),"object"!==v&&g("}")),n.additionalProperties||n.additionalProperties===!1){"object"!==v&&g("if (%s) {",types.object(e));var x=y(),P=l("keys"),k=function(e){return P+"["+x+"] !== "+JSON.stringify(e)},J=function(e){return"!"+m(e)+".test("+P+"["+x+"])"},w=Object.keys(p||{}).map(k).concat(Object.keys(n.patternProperties||{}).map(J)).join(" && ")||"true";g("var %s = Object.keys(%s)",P,e)("for (var %s = 0; %s < %s.length; %s++) {",x,x,P,x)("if (%s) {",w),n.additionalProperties===!1?(c&&g("delete %s",e+"["+P+"["+x+"]]"),j("has additional properties",null,JSON.stringify(e+".")+" + "+P+"["+x+"]")):d(e+"["+P+"["+x+"]]",n.additionalProperties,u,c),g("}")("}"),"object"!==v&&g("}")}if(n.$ref){var M=get(t,i&&i.schemas||{},n.$ref);if(M){var E=r[n.$ref];E||(r[n.$ref]=function(e){return E(e)},E=compile(M,r,t,!1,i));var q=l("ref");o[q]=E,g("if (!(%s(%s))) {",q,e),j("referenced schema does not match"),g("}")}}if(n.not){var I=l("prev");g("var %s = errors",I),d(e,n.not,!1,c),g("if (%s === errors) {",I),j("negative schema matches"),g("} else {")("errors = %s",I)("}")}if(n.items&&!h){"array"!==v&&g("if (%s) {",types.array(e));var x=y();g("for (var %s = 0; %s < %s.length; %s++) {",x,x,e,x),d(e+"["+x+"]",n.items,u,c),g("}"),"array"!==v&&g("}")}if(n.patternProperties){"object"!==v&&g("if (%s) {",types.object(e));var P=l("keys"),x=y();g("var %s = Object.keys(%s)",P,e)("for (var %s = 0; %s < %s.length; %s++) {",x,x,P,x),Object.keys(n.patternProperties).forEach(function(r){var t=m(r);g("if (%s.test(%s)) {",t,P+"["+x+"]"),d(e+"["+P+"["+x+"]]",n.patternProperties[r],u,c),g("}")}),g("}"),"object"!==v&&g("}")}if(n.pattern){var $=m(n.pattern);"string"!==v&&g("if (%s) {",types.string(e)),g("if (!(%s.test(%s))) {",$,e),j("pattern mismatch"),g("}"),"string"!==v&&g("}")}if(n.allOf&&n.allOf.forEach(function(r){d(e,r,u,c)}),n.anyOf&&n.anyOf.length){var I=l("prev");n.anyOf.forEach(function(r,t){0===t?g("var %s = errors",I):g("if (errors !== %s) {",I)("errors = %s",I),d(e,r,!1,!1)}),n.anyOf.forEach(function(e,r){r&&g("}")}),g("if (%s !== errors) {",I),j("no schemas match"),g("}")}if(n.oneOf&&n.oneOf.length){var I=l("prev"),L=l("passes");g("var %s = errors",I)("var %s = 0",L),n.oneOf.forEach(function(r){d(e,r,!1,!1),g("if (%s === errors) {",I)("%s++",L)("} else {")("errors = %s",I)("}")}),g("if (%s !== 1) {",L),j("no (or more than one) schemas match"),g("}")}for(void 0!==n.multipleOf&&("number"!==v&&"integer"!==v&&g("if (%s) {",types.number(e)),g("if (!isMultipleOf(%s, %d)) {",e,n.multipleOf),j("has a remainder"),g("}"),"number"!==v&&"integer"!==v&&g("}")),void 0!==n.maxProperties&&("object"!==v&&g("if (%s) {",types.object(e)),g("if (Object.keys(%s).length > %d) {",e,n.maxProperties),j("has more properties than allowed"),g("}"),"object"!==v&&g("}")),void 0!==n.minProperties&&("object"!==v&&g("if (%s) {",types.object(e)),g("if (Object.keys(%s).length < %d) {",e,n.minProperties),j("has less properties than allowed"),g("}"),"object"!==v&&g("}")),void 0!==n.maxItems&&("array"!==v&&g("if (%s) {",types.array(e)),g("if (%s.length > %d) {",e,n.maxItems),j("has more items than allowed"),g("}"),"array"!==v&&g("}")),void 0!==n.minItems&&("array"!==v&&g("if (%s) {",types.array(e)),g("if (%s.length < %d) {",e,n.minItems),j("has less items than allowed"),g("}"),"array"!==v&&g("}")),void 0!==n.maxLength&&("string"!==v&&g("if (%s) {",types.string(e)),g("if (%s.length > %d) {",e,n.maxLength),j("has longer length than allowed"),g("}"),"string"!==v&&g("}")),void 0!==n.minLength&&("string"!==v&&g("if (%s) {",types.string(e)),g("if (%s.length < %d) {",e,n.minLength),j("has less length than allowed"),g("}"),"string"!==v&&g("}")),void 0!==n.minimum&&(g("if (%s %s %d) {",e,n.exclusiveMinimum?"<=":"<",n.minimum),j("is less than minimum"),g("}")),void 0!==n.maximum&&(g("if (%s %s %d) {",e,n.exclusiveMaximum?">=":">",n.maximum),j("is more than maximum"),g("}")),p&&Object.keys(p).forEach(function(r){Array.isArray(v)&&-1!==v.indexOf("null")&&g("if (%s !== null) {",e),d(genobj(e,r),p[r],u,c),Array.isArray(v)&&-1!==v.indexOf("null")&&g("}")});b--;)g("}")},g=genfun("function validate(data) {")("validate.errors = null")("var errors = 0");return d("data",e,n,i&&i.filter),g("return errors === 0")("}"),g=g.toFunction(o),g.errors=null,Object.defineProperty&&Object.defineProperty(g,"error",{get:function(){return g.errors?g.errors.map(function(e){return e.field+" "+e.message}).join("\n"):""}}),g.toJSON=function(){return e},g};module.exports=function(e,r){return"string"==typeof e&&(e=JSON.parse(e)),compile(e,{},e,!0,r)},module.exports.filter=function(e,r){var t=module.exports(e,xtend(r,{filter:!0}));return function(e){return t(e),e}};