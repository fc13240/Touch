var Url=require("url"),Code=require("code"),Hawk=require("../lib"),Hoek=require("hoek"),Lab=require("lab"),internals={},lab=exports.lab=Lab.script(),describe=lab.experiment,it=lab.test,expect=Code.expect;describe("Server",function(){var e=function(e,t){var a={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"};return t(null,a)};describe("authenticate()",function(){it("parses a valid authentication header (sha1)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})}),it("parses a valid authentication header (sha256)",function(t){var a={method:"GET",url:"/resource/1?b=1&a=2",host:"example.com",port:8e3,authorization:'Hawk id="dh37fgj492je", ts="1353832234", nonce="j4h3g2", mac="m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=", ext="some-app-data"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353832234e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})}),it("parses a valid authentication header (host override)",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{host:"example1.com:8080",authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'}};Hawk.server.authenticate(a,e,{host:"example.com",localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})}),it("parses a valid authentication header (host port override)",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{host:"example1.com:80",authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'}};Hawk.server.authenticate(a,e,{host:"example.com",port:8080,localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})}),it("parses a valid authentication header (POST with payload)",function(t){var a={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123456", ts="1357926341", nonce="1AwuJD", hash="qAiXIVv+yjDATneWxZP2YCTa9aHRgQdnH9b3Wc+o3dg=", ext="some-app-data", mac="UeYcj5UoTVaAWXNvJfLVia7kU3VabxCqrccXP8sUGC4="'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1357926341e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})}),it("errors on missing hash",function(t){var a={method:"GET",url:"/resource/1?b=1&a=2",host:"example.com",port:8e3,authorization:'Hawk id="dh37fgj492je", ts="1353832234", nonce="j4h3g2", mac="m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=", ext="some-app-data"'};Hawk.server.authenticate(a,e,{payload:"body",localtimeOffsetMsec:1353832234e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Missing required payload hash"),t()})}),it("errors on a stale timestamp",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123456", ts="1362337299", nonce="UzmxSs", ext="some-app-data", mac="wnNUxchvvryMH2RxckTdZ/gY3ijzvccx4keVvELC61w="'};Hawk.server.authenticate(a,e,{},function(e,a,o){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Stale timestamp");var s=e.output.headers["WWW-Authenticate"],n=s.match(/^Hawk ts\=\"(\d+)\"\, tsm\=\"([^\"]+)\"\, error=\"Stale timestamp\"$/),r=Hawk.utils.now();expect(1e3*parseInt(n[1],10)).to.be.within(r-1e3,r+1e3);var i={headers:{"www-authenticate":s}};expect(Hawk.client.authenticate(i,a,o)).to.equal(!0),t()})}),it("errors on a replay",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="bXx7a7p1h9QYQNZ8x7QhvDQym8ACgab4m3lVSFn4DBw=", ext="hello"'},o={},s={localtimeOffsetMsec:1353788437e3-Hawk.utils.now(),nonceFunc:function(e,t,a,s){return o[e+t]?s(new Error):(o[e+t]=!0,s())}};Hawk.server.authenticate(a,e,s,function(o,n){expect(o).to.not.exist(),expect(n.user).to.equal("steve"),Hawk.server.authenticate(a,e,s,function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid nonce"),t()})})}),it("does not error on nonce collision if keys differ",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="bXx7a7p1h9QYQNZ8x7QhvDQym8ACgab4m3lVSFn4DBw=", ext="hello"'},a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="456", ts="1353788437", nonce="k3j4h2", mac="LXfmTnRzrLd9TD7yfH+4se46Bx6AHyhpM94hLCiNia4=", ext="hello"'},o=function(e,t){var a={123:{id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"},456:{id:e,key:"xrunpaw3489ruxnpa98w4rxnwerxhqb98rpaxn39848",algorithm:"1"===e?"sha1":"sha256",user:"bob"}};return t(null,a[e])},s={},n={localtimeOffsetMsec:1353788437e3-Hawk.utils.now(),nonceFunc:function(e,t,a,o){return s[e+t]?o(new Error):(s[e+t]=!0,o())}};Hawk.server.authenticate(t,o,n,function(t,s){expect(t).to.not.exist(),expect(s.user).to.equal("steve"),Hawk.server.authenticate(a,o,n,function(t,a){expect(t).to.not.exist(),expect(a.user).to.equal("bob"),e()})})}),it("errors on an invalid authentication header: wrong scheme",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.not.exist(),t()})}),it("errors on an invalid authentication header: no scheme",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"!@#"};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid header syntax"),t()})}),it("errors on an missing authorization header",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};Hawk.server.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.isMissing).to.equal(!0),t()})}),it("errors on an missing host header",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid Host header"),t()})}),it("errors on an missing authorization attribute (id)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Missing attributes"),t()})}),it("errors on an missing authorization attribute (ts)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Missing attributes"),t()})}),it("errors on an missing authorization attribute (nonce)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Missing attributes"),t()})}),it("errors on an missing authorization attribute (mac)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Missing attributes"),t()})}),it("errors on an unknown authorization attribute",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", x="3", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Unknown attribute: x"),t()})}),it("errors on an bad authorization header format",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123\\", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Bad header format"),t()})}),it("errors on an bad authorization attribute value",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="	", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Bad attribute value: id"),t()})}),it("errors on an empty authorization attribute value",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Bad attribute value: id"),t()})}),it("errors on duplicated authorization attribute key",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", id="456", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Duplicate attribute: id"),t()})}),it("errors on an invalid authorization header format",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"Hawk"};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid header syntax"),t()})}),it("errors on an bad host header (missing host)",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{host:":8080",authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid Host header"),t()})}),it("errors on an bad host header (pad port)",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{host:"example.com:something",authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid Host header"),t()})}),it("errors on credentialsFunc error",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){return t(new Error("Unknown user"))};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist(),expect(t.message).to.equal("Unknown user"),e()})}),it("errors on credentialsFunc error (with credentials)",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){return t(new Error("Unknown user"),{some:"value"})};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t,a){expect(t).to.exist(),expect(t.message).to.equal("Unknown user"),expect(a.some).to.equal("value"),e()})}),it("errors on missing credentials",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){return t(null,null)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist(),expect(t.output.payload.message).to.equal("Unknown credentials"),e()})}),it("errors on invalid credentials (id)",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){var a={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",user:"steve"};return t(null,a)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist(),expect(t.message).to.equal("Invalid credentials"),expect(t.output.payload.message).to.equal("An internal server error occurred"),e()})}),it("errors on invalid credentials (key)",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){var a={id:"23434d3q4d5345d",user:"steve"};return t(null,a)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist(),expect(t.message).to.equal("Invalid credentials"),expect(t.output.payload.message).to.equal("An internal server error occurred"),e()})}),it("errors on unknown credentials algorithm",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){var a={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"hmac-sha-0",user:"steve"};return t(null,a)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist(),expect(t.message).to.equal("Unknown algorithm"),expect(t.output.payload.message).to.equal("An internal server error occurred"),e()})}),it("errors on unknown bad mac",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcU4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){var a={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};return t(null,a)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist(),expect(t.output.payload.message).to.equal("Bad mac"),e()})})}),describe("header()",function(){it("generates header",function(e){var t={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},a={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1398546787",nonce:"xUwusx",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",mac:"dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=",id:"123456"},o=Hawk.server.header(t,a,{payload:"some reply",contentType:"text/plain",ext:"response-specific"});expect(o).to.equal('Hawk mac="n14wVJK4cOxAytPUMc5bPezQzuJGl5n7MYXhFQgEKsE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'),e()}),it("generates header (empty payload)",function(e){var t={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},a={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1398546787",nonce:"xUwusx",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",mac:"dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=",id:"123456"},o=Hawk.server.header(t,a,{payload:"",contentType:"text/plain",ext:"response-specific"});expect(o).to.equal('Hawk mac="i8/kUBDx0QF+PpCtW860kkV/fa9dbwEoe/FpGUXowf0=", hash="q/t+NNAkQZNlq/aAD6PlexImwQTxwgT2MahfTa9XRLA=", ext="response-specific"'),e()}),it("generates header (pre calculated hash)",function(e){var t={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},a={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1398546787",nonce:"xUwusx",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",mac:"dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=",id:"123456"},o={payload:"some reply",contentType:"text/plain",ext:"response-specific"};o.hash=Hawk.crypto.calculatePayloadHash(o.payload,t.algorithm,o.contentType);var s=Hawk.server.header(t,a,o);expect(s).to.equal('Hawk mac="n14wVJK4cOxAytPUMc5bPezQzuJGl5n7MYXhFQgEKsE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'),e()}),it("generates header (null ext)",function(e){var t={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},a={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1398546787",nonce:"xUwusx",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",mac:"dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=",id:"123456"},o=Hawk.server.header(t,a,{payload:"some reply",contentType:"text/plain",ext:null});expect(o).to.equal('Hawk mac="6PrybJTJs20jsgBw5eilXpcytD8kUbaIKNYXL+6g0ns=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM="'),e()}),it("errors on missing artifacts",function(e){var t={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},a=Hawk.server.header(t,null,{payload:"some reply",contentType:"text/plain",ext:"response-specific"});expect(a).to.equal(""),e()}),it("errors on invalid artifacts",function(e){var t={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},a=Hawk.server.header(t,5,{payload:"some reply",contentType:"text/plain",ext:"response-specific"});expect(a).to.equal(""),e()}),it("errors on missing credentials",function(e){var t={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1398546787",nonce:"xUwusx",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",mac:"dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=",id:"123456"},a=Hawk.server.header(null,t,{payload:"some reply",contentType:"text/plain",ext:"response-specific"});expect(a).to.equal(""),e()}),it("errors on invalid credentials (key)",function(e){var t={id:"123456",algorithm:"sha256",user:"steve"},a={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1398546787",nonce:"xUwusx",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",mac:"dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=",id:"123456"},o=Hawk.server.header(t,a,{payload:"some reply",contentType:"text/plain",ext:"response-specific"});expect(o).to.equal(""),e()}),it("errors on invalid algorithm",function(e){var t={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"x",user:"steve"},a={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1398546787",nonce:"xUwusx",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",mac:"dvIvMThwi28J61Jc3P0ryAhuKpanU63GXdx6hkmQkJA=",id:"123456"},o=Hawk.server.header(t,a,{payload:"some reply",contentType:"text/plain",ext:"response-specific"});expect(o).to.equal(""),e()})}),describe("authenticateBewit()",function(){it("errors on uri too long",function(t){for(var a="/",o=0;5e3>o;++o)a+="x";var s={method:"GET",url:a,host:"example.com",port:8080,authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'};Hawk.server.authenticateBewit(s,e,{},function(e){expect(e).to.exist(),expect(e.output.statusCode).to.equal(400),expect(e.message).to.equal("Resource path exceeds max length"),t()})})}),describe("authenticateMessage()",function(){it("errors on invalid authorization (ts)",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});delete s.ts,Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid authorization"),t()})})}),it("errors on invalid authorization (nonce)",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});delete s.nonce,Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid authorization"),t()})})}),it("errors on invalid authorization (hash)",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});delete s.hash,Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid authorization"),t()})})}),it("errors with credentials",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});Hawk.server.authenticateMessage("example.com",8080,"some message",o,function(e,t){t(new Error("something"),{some:"value"})},{},function(e,a){expect(e).to.exist(),expect(e.message).to.equal("something"),expect(a.some).to.equal("value"),t()})})}),it("errors on nonce collision",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{nonceFunc:function(e,t,a,o){o(!0)}},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid nonce"),t()})})}),it("should generate an authorization then successfully parse it",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(s).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})})}),it("should fail authorization on mismatching host",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(s).to.exist(),Hawk.server.authenticateMessage("example1.com",8080,"some message",s,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Bad mac"),t()})})}),it("should fail authorization on stale timestamp",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(s).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{localtimeOffsetMsec:1e5},function(e){expect(e).to.exist(),expect(e.message).to.equal("Stale timestamp"),t()})})}),it("overrides timestampSkewSec",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o,localtimeOffsetMsec:1e5});expect(s).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{timestampSkewSec:500},function(e){expect(e).to.not.exist(),t()})})}),it("should fail authorization on invalid authorization",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(s).to.exist(),delete s.id,Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid authorization"),t()})})}),it("should fail authorization on bad hash",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(s).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message1",s,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Bad message hash"),t()})})}),it("should fail authorization on nonce error",function(t){e("123456",function(a,o){var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(s).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",s,e,{nonceFunc:function(e,t,a,o){o(new Error("kaboom"))}},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid nonce"),t()})})}),it("should fail authorization on credentials error",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});expect(o).to.exist();var s=function(e,t){t(new Error("kablooey"))};Hawk.server.authenticateMessage("example.com",8080,"some message",o,s,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("kablooey"),t()})})}),it("should fail authorization on missing credentials",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});expect(o).to.exist();var s=function(e,t){t()};Hawk.server.authenticateMessage("example.com",8080,"some message",o,s,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Unknown credentials"),t()})})}),it("should fail authorization on invalid credentials",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});expect(o).to.exist();var s=function(e,t){t(null,{})};Hawk.server.authenticateMessage("example.com",8080,"some message",o,s,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid credentials"),t()})})}),it("should fail authorization on invalid credentials algorithm",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});expect(o).to.exist();var s=function(e,t){t(null,{key:"123",algorithm:"456"})};Hawk.server.authenticateMessage("example.com",8080,"some message",o,s,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Unknown algorithm"),t()})})}),it("should fail on missing host",function(t){e("123456",function(e,a){var o=Hawk.client.message(null,8080,"some message",{credentials:a});expect(o).to.not.exist(),t()})}),it("should fail on missing credentials",function(e){var t=Hawk.client.message("example.com",8080,"some message",{});expect(t).to.not.exist(),e()}),it("should fail on invalid algorithm",function(t){e("123456",function(e,a){var o=Hoek.clone(a);o.algorithm="blah";var s=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(s).to.not.exist(),t()})})}),describe("authenticatePayloadHash()",function(){it("checks payload hash",function(e){expect(Hawk.server.authenticatePayloadHash("abcdefg",{hash:"abcdefg"})).to.equal(!0),expect(Hawk.server.authenticatePayloadHash("1234567",{hash:"abcdefg"})).to.equal(!1),e()})})});