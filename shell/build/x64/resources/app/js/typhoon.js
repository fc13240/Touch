$(function(){function e(e){if("string"==typeof e){var t=/^[^(]+\(+([^)]+)\)+/.exec(e);if(t){var n=t[1];try{return $.parseJSON(n)}catch(a){}}}}function t(t,n){function a(e){n&&(e=e.filter(function(e){return p||e.is_active?e:void 0}),p&&(e=e.slice(-6))),t(e)}var i=u[v];i?a(i):Util.req.text(v,function(t,n){n=e(n);var i=[];n&&(i=n.typhoonList);var o=[];$.each(i,function(e,t){o.push({is_active:"stop"!=t[7],index:t[3],code:t[0],cnName:t[2],enName:t[1],nameDesc:t[6]})});var r={};$.each(o,function(e,t){var n=t.index,a=r[n];a?a.push(t):r[n]=[t]});var l=[];for(var s in r){var c=r[s];if(c.length>1){c.sort(function(e,t){return e.index-t.index});var h=!1,d=[];$.each(c,function(e,t){t.is_active&&(h=!0),d.push(t.code)}),c[0].is_active=h,c[0].code_list=d,l.push(c[0])}else l.push(c[0])}l.sort(function(e,t){return e.index-t.index}),u[v]=l,a(l)})}function n(t,n){var a="typhoon_"+t,i=u[a];if(i)n(i);else{var o=[];try{t=t.split(",")}catch(r){t=[t]}$.each(t,function(e,t){o.push(Util.req.text(d+"view_"+t))}),$.when.apply($,o).done(function(){function i(e,t){e=parseFloat(e),t=parseFloat(t),l>e&&(l=e),min_lat>t&&(min_lat=t),e>s&&(s=e),t>max_lat&&(max_lat=t)}for(var r=[],l=min_lat=Number.MAX_VALUE,s=max_lat=-Number.MAX_VALUE,c=0,h=1==o.length?[arguments]:arguments,d=h.length;d>c;c++){var v=h[c][0],p=e(v);if(p){var f=p.typhoon;if(f){var m=f[8];$.each(m,function(e,t){var n=new Date(t[2]);n.setHours(n.getHours()+8);var a={time:n,lat:t[5],lng:t[4],level:t[3],wind:t[7],yq:t[6],move_speed:t[9],move_dir:t[8]},o=t[10],l=o[0];l&&(a.r7_en=l[1],a.r7_es=l[2],a.r7_ws=l[3],a.r7_wn=l[4]);var s=o[1];s&&(a.r10_en=s[1],a.r10_es=s[2],a.r10_ws=s[3],a.r10_wn=s[4]);var c=o[2];c&&(a.r12_en=c[1],a.r12_es=c[2],a.r12_ws=c[3],a.r12_wn=c[4]),i(a.lng,a.lat);var h=[],d=t[11];d&&(d=d.BABJ)&&$.each(d,function(e,t){h.push({aging:t[0],lat:t[3],lng:t[2],level:t[7],wind:t[5],qy:t[4]})}),a.forecast=h,r.push(a)})}}}var g=r[r.length-1];$.each(g.forecast,function(e,t){i(t.lng,t.lat)}),u["bound_"+t]=[[max_lat,l],[min_lat,s]],u[a]=r,n(r)})}}function a(e,t){var n=q.getZoom(),a=S[n];if(a){var i=a/67,o=t["r"+e+"_en"]/i,r=t["r"+e+"_es"]/i,l=t["r"+e+"_ws"]/i,s=t["r"+e+"_wn"]/i;if(!(o&&r&&l&&s))return"";var c=Math.abs(o-s),h=Math.abs(r-l),d=Math.abs(s-l),v=Math.abs(o-r),u=2,p='<div class="wind_radiu level'+e+'"><div class="radiu radiu_en" style="width:'+o+"px;height:"+o+'px;"></div><div class="radiu radiu_es" style="width:'+r+"px;height:"+r+'px;"></div><div class="radiu radiu_wn" style="width:'+s+"px;height:"+s+'px;"></div><div class="radiu radiu_ws" style="width:'+l+"px;height:"+l+'px;"></div><div class="line line_up" style="height:'+(c+u)+"px;margin-top:"+-Math.max(o,s)+'px"></div><div class="line line_down" style="height:'+(h+u)+"px;margin-top:"+(Math.max(r,l)-h-u)+'px"></div><div class="line line_left" style="width:'+(d+u)+"px;margin-right:"+(Math.max(s,l)-d-u)+'px"></div><div class="line line_right" style="width:'+(v+u)+"px;margin-left:"+(Math.max(o,r)-v-u)+'px"></div></div>'}return p}function i(e,t){t=t||"";for(var n=e.level,i=1,o=1,r=k.length;r>=o;o++)if(k[o-1].code==n){i=o;break}var l="wind_level wl_"+i,s=L.divIcon({className:l,html:t,iconSize:L.point(20,20)}),c=L.marker([e.lat,e.lng],{icon:s}).addTo(q).on("click",function(){if(m){var n=m.options.icon.options;n.html=t,m.setIcon(L.divIcon(n)),m.setZIndexOffset(99999)}if(m=c,!e.aging){var n=c.options.icon.options;n.html=t+a(7,e)+a(10,e)+a(12,e);var i=L.divIcon(n);c.setIcon(i),c.setZIndexOffset(-99999)}});return c}function o(e){return'<div class="popup"><span></span>'+e+"</div>"}function r(e){n(e,function(t){function n(e){e&&s.push(e)}function a(){var l=x&&0==h?y:t[h-1],s=t[h];if(s){var c={color:"white",weight:2,opacity:1};x&&(c.dashArray=[10,8]);var d=L.latLng(l.lat,l.lng),u=L.latLng(s.lat,s.lng),p=L.polyline([d,u],c).addTo(q);if(n(p),n(i(s)),!x){_.setLatLng(u);var f=_.options.icon.options;f.html='<div class="rotate"></div>'+o(s.time.format((r.cnName||r.enName)+"(MM\u6708dd\u65e5hh\u65f6)")),_.setIcon(L.divIcon(f)),y=u}var m=!1;v>h?(h++,m=!0):(t=s.forecast,t&&(h=0,v=t.length-1,x=!0,m=!0)),m&&(I[e]=setTimeout(a,g))}}var r=u[e],l=u["bound_"+e];q.fitBounds(l);var s=N[e]||(N[e]=[]),h=0,d=t.length,v=d-1,p=t[h++],f=d,m=t[v].forecast;m&&(f+=m.length);var g=Math.min(T,Math.ceil(A/f)),_=L.marker([p.lat,p.lng],{icon:L.divIcon({className:"typhoon_icon",html:'<div class="rotate"></div>',iconSize:[30,30]})});_.__items=t,_.__typhoon_info=r,_.on("click",function(){var e=_.__typhoon_info;c(_.__items,e.cnName+"(\u7b2c"+e.index+"\u53f7\u53f0\u98ce"+e.enName+")")}).addTo(q),n(_),n(i(p,o(r.cnName||r.enName)));var y,x=!1;I[e]=setTimeout(a,g)})}function l(e){var t=N[e];t&&(clearTimeout(I[e]),$.each(t,function(e,t){q.removeLayer(t)}))}function s(){var e="";_.find(".btn_typhoon.on").each(function(){var t=$(this).data("code"),n=u[t];e+="<li>"+n.cnName+"(\u7b2c"+n.index+"\u53f7\u53f0\u98ce"+n.enName+")</li>"}),e?y.show():y.hide(),y.html(e)}function c(e,t){if(ecObj){g&&g.dispose();var n=[],a=[],i=e.length-1,o=[];$.each(e,function(e,t){var r=t.time.format("MM\u6708dd\u65e5hh\u65f6");o.push(r),n.push(0===e||e===i?r:" "),a.push(t.wind)});var r=n.length-1,l=(n[r],a[a.length-1]),s=e[e.length-1],c=s.forecast;if(c){var h=s.time,i=c.length-1;$.each(c,function(e,t){var r=new Date(h.getTime());r.setHours(r.getHours()+t.aging);var l=r.format("MM\u6708dd\u65e5hh\u65f6");o.push(l),n.push(i===e?l:"  "),a.push(t.wind)})}for(var d=(Math.min.apply(Math,a),Math.max.apply(Math,a)),v=[],u=0,p=0,f=k.length;f>p;p++){var m=k[p],_=m.val,y=(_[1]||d)-_[0];u+=y,v.push({d:y,c:m.color})}for(var L=[],M=0,p=0,f=v.length;f>p;p++){var m=v[p];M+=m.d/u,L.push([M,m.c])}w.show().css({left:"100%"}).animate({left:"15%"},{easing:"swing"}),x.text(t),g=ecObj.init(b.get(0));var S=10,N=Math.max(55,d),I=5,T=N%I;T>0&&(N=N-T+I),g.setOption({color:["white"],grid:{borderColor:"rgba(0, 0, 0, 0)"},tooltip:{trigger:"axis",formatter:function(e){var t=e[0];return o[t.dataIndex]+"<br/>"+t.seriesName+":"+t.value+"m/s"}},legend:{show:!1,data:[""]},calculable:!0,xAxis:{show:1,boundaryGap:!1,data:n,axisLabel:{textStyle:{color:"white",fontSize:16}},splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.3)"}},axisLine:{show:!1}},yAxis:{show:1,min:S,max:N,splitNumber:Math.floor((N-S)/5),axisLabel:{textStyle:{color:"white",fontSize:16}},splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.3)"}},axisLine:{show:!1}},series:[{name:"\u98ce\u901f",type:"line",smooth:1,symbolSize:2,clickable:!1,draggable:!1,itemStyle:{normal:{areaStyle:{type:"default",color:function(){var e=require_web("zrender/tool/color");return e.getLinearGradient(0,b.height(),0,0,L)}()},lineStyle:{color:"rgba(0, 0, 0, 0)"}}},data:a,markLine:{itemStyle:{normal:{lineStyle:{type:"solid",color:"#1d6fb8"}}},data:[[{xAxis:r,yAxis:0},{xAxis:r,yAxis:l-1}]]}}]})}}function h(e){var t="";$.each(e,function(e,n){u[n.code_list||n.code]=n,t+='<div class="box btn_typhoon" data-code="'+(n.code_list||n.code)+'">'+(n.cnName||n.enName)+"</div>"}),_.html(t)}Date.prototype.format=function(e,t){e||(e="yyyy-MM-dd hh:mm:ss");var n={"M{2}":this.getMonth()+1,"d{2}":this.getDate(),"h{2}":this.getHours(),"m{2}":this.getMinutes(),"q{2}":Math.floor((this.getMonth()+3)/3)};t||(n["s{2}"]=this.getSeconds(),n["S{2}"]=this.getMilliseconds()),/(y{4}|y{2})/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in n)new RegExp("("+a+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?n[a]:("00"+n[a]).substr((""+n[a]).length)));return e};var d="http://typhoon.nmc.cn/weatherservice/typhoon/jsons/",v=d+"list_default",u={},p=!1;try{p=!!require("./conf").debug}catch(f){console.log(f)}var m,g,_,y,x,w,b,M,S={19:.02,18:.05,17:.1,16:.2,15:.5,14:1,13:2,12:4,11:10,10:20,9:25,8:50,7:100,6:200,5:500,4:1e3,3:2e3},N={},I={},T=200,A=5e3,k=[{val:[10.8,17.1],code:"TD",name:"\u70ed\u5e26\u4f4e\u538b",color:"rgba(110,196,186, 0.8)"},{val:[17.2,24.4],code:"TS",name:"\u70ed\u5e26\u98ce\u66b4",color:"rgba(239,234,58, 0.8)"},{val:[24.5,32.6],code:"STS",name:"\u5f3a\u70ed\u5e26\u98ce\u66b4",color:"rgba(239,124,27, 0.8)"},{val:[32.7,41.4],code:"TY",name:"\u53f0\u98ce",color:"rgba(231,31,30, 0.8)"},{val:[41.5,50.9],code:"STY",name:"\u5f3a\u53f0\u98ce",color:"rgba(230,38,135, 0.8)"},{val:[51],code:"SuperTY",name:"\u8d85\u5f3a\u53f0\u98ce",color:"rgba(126,64,149, 0.8)"}];$(function(){M=$("#wrap_typhoon"),w=$(".wrap_typhoon_chart"),b=$("#typhoon_chart"),x=w.find(".typhoon_name"),_=$(".btn_typhoon_list").delegate(".btn_typhoon","click",function(t){t.stopPropagation();var n=$(this),a=n.data("code");n.hasClass("on")?(n.removeClass("on"),l(a)):(n.addClass("on"),r(a)),s(),e.click()}),y=$(".typhoon_list").html("");var e=$("#btn_close_typhoon_chart").click(function(){$(this).parent().hide()});require_web.config({paths:{echarts:"./js/"}}),require_web(["echarts","echarts/chart/line"],function(e){ecObj=e});var t=function(e){e.preventDefault?e.preventDefault():window.event.returnValue=!1};w.bind("touchmove",t)});var q;W.require.bind(null,["maps"],function(e){q=e,q.on("zoomstart",function(){if(m){var e=m.options.icon.options;e.html="",m.setIcon(L.divIcon(e))}})})();var z=function(){var e;return{show:function(){var t=[[34.005024,126.993568],[21.971252,126.993568],[17.96586,118.995521],[10.97105,118.995521],[4.48627,113.018959],[-.035506,104.998939]],n=[[-.035506,104.998939],[-.035506,119.962318],[14.96886,131.981361],[33.959474,131.981361]],a=L.polyline(t,{color:"#FF0",weight:1,opacity:1,id:"gl_24"}),i=L.polyline(n,{color:"#FF0",weight:1,opacity:1,dashArray:"5 5",id:"gl_48"}),o=L.divIcon({className:"guardLine_24",html:"24\u5c0f\u65f6\u8b66\u6212\u7ebf",iconSize:L.point(20,20)}),r=L.marker([34.005024,126.993568],{icon:o}),l=L.divIcon({className:"guardLine_48",html:"48\u5c0f\u65f6\u8b66\u6212\u7ebf",iconSize:L.point(20,20)}),s=L.marker([33.959474,131.981361],{icon:l});e=L.layerGroup([a,i,r,s]).addTo(q)},clear:function(){e&&q.removeLayer(e),e=null}}}();window.Typhoon={init:function(){M.show(),t(function(e){e.length>0?h(e):y.html("<li>\u5f53\u524d\u65e0\u53f0\u98ce</li>")},!0),z.show()},clear:function(){M.hide(),w.hide();var e=u[v];if(e)for(var t=0,n=e.length;n>t;t++)l(e[t].code);z.clear()}}});