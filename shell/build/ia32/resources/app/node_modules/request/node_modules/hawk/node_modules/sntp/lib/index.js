var Dgram=require("dgram"),Dns=require("dns"),Hoek=require("hoek"),internals={};exports.time=function(e,t){2!==arguments.length&&(t=arguments[0],e={});var r=Hoek.clone(e);r.host=r.host||"pool.ntp.org",r.port=r.port||123,r.resolveReference=r.resolveReference||!1;var n=0,s=0,i=function(e,r){return n&&(clearTimeout(n),n=0),a.removeAllListeners(),a.once("error",internals.ignore),a.close(),t(e,r)};i=Hoek.once(i);var a=Dgram.createSocket("udp4");a.once("error",function(e){return i(e)}),a.on("message",function(e){var t=Date.now(),n=new internals.NtpMessage(e);if(!n.isValid)return i(new Error("Invalid server response"),n);if(n.originateTimestamp!==s)return i(new Error("Wrong originate timestamp"),n);var a=n.originateTimestamp,o=n.receiveTimestamp,c=n.transmitTimestamp,l=t;return n.d=l-a-(c-o),n.t=(o-a+(c-l))/2,n.receivedLocally=t,r.resolveReference&&"secondary"===n.stratum?void Dns.reverse(n.referenceId,function(e,t){return e||(n.referenceHost=t[0]),i(null,n)}):i(null,n)}),r.timeout&&(n=setTimeout(function(){return n=0,i(new Error("Timeout"))},r.timeout));for(var o=new Buffer(48),c=0;48>c;c++)o[c]=0;o[0]=35,s=Date.now(),internals.fromMsecs(s,o,40),a.send(o,0,o.length,r.port,r.host,function(e,t){return e||48!==t?i(e||new Error("Could not send entire message")):void 0})},internals.NtpMessage=function(e){if(this.isValid=!1,48===e.length){var t=e[0]>>6;switch(t){case 0:this.leapIndicator="no-warning";break;case 1:this.leapIndicator="last-minute-61";break;case 2:this.leapIndicator="last-minute-59";break;case 3:this.leapIndicator="alarm"}var r=(56&e[0])>>3;this.version=r;var n=7&e[0];switch(n){case 1:this.mode="symmetric-active";break;case 2:this.mode="symmetric-passive";break;case 3:this.mode="client";break;case 4:this.mode="server";break;case 5:this.mode="broadcast";break;case 0:case 6:case 7:this.mode="reserved"}var s=e[1];this.stratum=0===s?"death":1===s?"primary":15>=s?"secondary":"reserved",this.pollInterval=1e3*Math.round(Math.pow(2,e[2])),this.precision=1e3*Math.pow(2,e[3]);var i=256*(256*(256*e[4]+e[5])+e[6])+e[7];switch(this.rootDelay=1e3*(i/65536),this.rootDispersion=1e3*((e[8]<<8)+e[9]+((e[10]<<8)+e[11])/Math.pow(2,16)),this.referenceId="",this.stratum){case"death":case"primary":this.referenceId=String.fromCharCode(e[12])+String.fromCharCode(e[13])+String.fromCharCode(e[14])+String.fromCharCode(e[15]);break;case"secondary":this.referenceId=""+e[12]+"."+e[13]+"."+e[14]+"."+e[15]}return this.referenceTimestamp=internals.toMsecs(e,16),this.originateTimestamp=internals.toMsecs(e,24),this.receiveTimestamp=internals.toMsecs(e,32),this.transmitTimestamp=internals.toMsecs(e,40),4===this.version&&"reserved"!==this.stratum&&"server"===this.mode&&this.originateTimestamp&&this.receiveTimestamp&&this.transmitTimestamp&&(this.isValid=!0),this}},internals.toMsecs=function(e,t){for(var r=0,n=0,s=0;4>s;++s)r=256*r+e[t+s];for(s=4;8>s;++s)n=256*n+e[t+s];return 1e3*(r-2208988800+n/Math.pow(2,32))},internals.fromMsecs=function(e,t,r){var n=Math.floor(e/1e3)+2208988800,s=Math.round(e%1e3/1e3*Math.pow(2,32));t[r+0]=(4278190080&n)>>24,t[r+1]=(16711680&n)>>16,t[r+2]=(65280&n)>>8,t[r+3]=255&n,t[r+4]=(4278190080&s)>>24,t[r+5]=(16711680&s)>>16,t[r+6]=(65280&s)>>8,t[r+7]=255&s},internals.last={offset:0,expires:0,host:"",port:0},exports.offset=function(e,t){2!==arguments.length&&(t=arguments[0],e={});var r=Date.now(),n=e.clockSyncRefresh||864e5;return internals.last.offset&&internals.last.host===e.host&&internals.last.port===e.port&&r<internals.last.expires?void process.nextTick(function(){t(null,internals.last.offset)}):void exports.time(e,function(s,i){return s?t(s,0):(internals.last={offset:Math.round(i.t),expires:r+n,host:e.host,port:e.port},t(null,internals.last.offset))})},internals.now={intervalId:0},exports.start=function(e,t){return 2!==arguments.length&&(t=arguments[0],e={}),internals.now.intervalId?void process.nextTick(function(){t()}):void exports.offset(e,function(){return internals.now.intervalId=setInterval(function(){exports.offset(e,function(){})},e.clockSyncRefresh||864e5),t()})},exports.stop=function(){internals.now.intervalId&&(clearInterval(internals.now.intervalId),internals.now.intervalId=0)},exports.isLive=function(){return!!internals.now.intervalId},exports.now=function(){var e=Date.now();return!exports.isLive()||e>=internals.last.expires?e:e+internals.last.offset},internals.ignore=function(){};