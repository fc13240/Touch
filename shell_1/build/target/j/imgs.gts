$(function(){function t(t,e,a){if(u[t])return a();var i=new Image;i.crossOrigin="anonymous";var r=n;i.onload=function(){var n=this;if(is_native&&1!=e){var o=document.createElement("canvas"),s=n.width,c=n.height,g=1400;if(s>c){var l=s/g;s=g,c/=l}else{var l=c/g;c=g,s/=l}s=parseInt(s),c=parseInt(c),o.width=s,o.height=c;var f=o.getContext("2d");f.drawImage(i,0,0,s,c);var h=f.getImageData(0,0,s,c);if(r)return r.onmessage=function(i){for(var n=i.data.data,r=0,s=n.length;s>r;r+=4)n[r+3]=Math.min(n[r+3]*e,255);f.putImageData(i.data,0,0),u[t]=o.toDataURL("image/png"),a()},void r.postMessage({imageData:h,width:s,height:c,radius:2});f.putImageData(h,0,0),u[t]=o.toDataURL("image/png")}else u[t]=t;a()},i.onerror=function(){u[t]="",a()},i.src=t}function e(e,a,i){function n(){c+=1,h.trigger("load_progress",c/s),c>=s?(p[o]=!0,i()):r()}function r(){var i=e.shift();i&&t(i[0],a,n)}var o=e.url;if(p[o])return i();e=e.slice();var s=e.length,c=0;h.trigger("load_progress",0),r()}function a(t,a,i){e(t,a,function(){if(c){for(var e=0,a=t.length;a>e;e++){var n=t[e],s=n[0],g=n[2],l=i||[[g[0],g[1]],[g[2],g[3]]],f=L.imageOverlay(u[s],l);f.addTo(r),f.setOpacity(0==e?1:0),f._time=n[1],o.push(f)}h.trigger("img_inited",{total:a})}})}function i(t){var e=o.length;0>t?t=0:t>=e&&(t=0);for(var a=0;e>a;a++)o[a].setOpacity(a==t?1:0);s=t;var i=o[s];i&&h.trigger("change_img",{url:i._url,time:i._time,index:s,total:e})}var n,r,o=[],s=0,c=!0,g=function(){var t="";is_native||(t="http://10.14.85.116/php/proxy.php?url=");var e={};return{get:function(a,i){a=t+a;var n=e[a];n?i&&i(n):$.get(a,function(t){try{var n=$.parseJSON(t)}catch(r){}n&&(t=n),e[a]=t,i&&i(t)})}}}();W.define("imgs",["blurWorker","maps"],function(t,e){n=t,r=e});var u={},l=function(){function t(){u?(n(),s.removeClass("playing")):(i(),s.addClass("playing")),u=!u}function e(e){r.show(),u=!1,t(),f=e,g&&this.play()}function a(t){0>t?t=0:t>f-1&&(t=f-1),h.trigger("player_changeindex",{index:t}),p=t,f>0&&o.css("width",p/(f-1)*100+"%")}function i(){clearTimeout(l);a(p);var t=p+1;0>t?t=0:t>f-1&&(t=0),p=t,l=setTimeout(i,d)}function n(){clearTimeout(l)}var r=$(".box_player"),o=$(".player_progressbar_progress"),s=$(".player_btn"),c=$(".player_progressbar");c.on("click",function(e){e.originalEvent&&(e=e.originalEvent);var i=e.layerX/c[0].offsetWidth,n=Math.floor(i*f);u=!0,t(),a(n)});var g=!0,u=g;s.bind("click",t);var l,f=0,p=0,d=300;return{init:e,setIndex:a,play:i,pause:n,clear:function(){f=0,p=0,n()},hide:function(){r.hide()},reset:function(){this.clear(),this.hide()}}}(),f=$(".load_progress_wrap"),h=$(document).on("load_progress",function(t,e){c&&(1>e?f.show():f.hide(),f.html((100*e).toFixed(1)+"%"))});h.on("change_img",function(t,e){if(c){var a=new Date(1e3*e.time);$(".box_title_container .time").show(),$("#time_top").html(a.format("yyyy\u5e74MM\u6708dd\u65e5")),$("#time_bottom").html(a.format("hh:mm"))}}),h.on("player_changeindex",function(t,e){c&&i(e.index)}),h.on("img_inited",function(t,e){c&&l.init(e.total)});var p={};window.Imgs={init:function(t){if(this.stop(),c=!0,"radar"==t){var e="http://api.tianqi.cn:8070/v1/img.py";g.get(e,function(t){var i=t.radar_img;i.url=e,a(i,4)})}else if("cloud"==t){var e="http://radar.tianqi.cn/radar/imgs.php?type=cloud_new";g.get(e,function(t){for(var i=[],n=t.l,r=n.length-1;r>=0;r--){var o=n[r];i.push([o.l2,new Date(o.l1).getTime()/1e3])}i.url=e,a(i,1.1,[[-4.98,50.02],[59.97,144.97]])})}},setIndex:i,stop:function(t){void 0!==t&&(o[s].setOpacity(0),o[t].setOpacity(1))},getOverlays:function(){return o},remove:function(){c=!1,l.reset();for(var t;t=o.shift();)r.removeLayer(t)}}});