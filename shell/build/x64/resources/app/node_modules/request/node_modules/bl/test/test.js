var tape=require("tape"),crypto=require("crypto"),fs=require("fs"),hash=require("hash_file"),BufferList=require("../"),encodings=("hex utf8 utf-8 ascii binary base64"+(process.browser?"":" ucs2 ucs-2 utf16le utf-16le")).split(" ");tape("single bytes from single buffer",function(e){var n=new BufferList;n.append(new Buffer("abcd")),e.equal(n.length,4),e.equal(n.get(0),97),e.equal(n.get(1),98),e.equal(n.get(2),99),e.equal(n.get(3),100),e.end()}),tape("single bytes from multiple buffers",function(e){var n=new BufferList;n.append(new Buffer("abcd")),n.append(new Buffer("efg")),n.append(new Buffer("hi")),n.append(new Buffer("j")),e.equal(n.length,10),e.equal(n.get(0),97),e.equal(n.get(1),98),e.equal(n.get(2),99),e.equal(n.get(3),100),e.equal(n.get(4),101),e.equal(n.get(5),102),e.equal(n.get(6),103),e.equal(n.get(7),104),e.equal(n.get(8),105),e.equal(n.get(9),106),e.end()}),tape("multi bytes from single buffer",function(e){var n=new BufferList;n.append(new Buffer("abcd")),e.equal(n.length,4),e.equal(n.slice(0,4).toString("ascii"),"abcd"),e.equal(n.slice(0,3).toString("ascii"),"abc"),e.equal(n.slice(1,4).toString("ascii"),"bcd"),e.end()}),tape("multiple bytes from multiple buffers",function(e){var n=new BufferList;n.append(new Buffer("abcd")),n.append(new Buffer("efg")),n.append(new Buffer("hi")),n.append(new Buffer("j")),e.equal(n.length,10),e.equal(n.slice(0,10).toString("ascii"),"abcdefghij"),e.equal(n.slice(3,10).toString("ascii"),"defghij"),e.equal(n.slice(3,6).toString("ascii"),"def"),e.equal(n.slice(3,8).toString("ascii"),"defgh"),e.equal(n.slice(5,10).toString("ascii"),"fghij"),e.end()}),tape("multiple bytes from multiple buffer lists",function(e){var n=new BufferList;n.append(new BufferList([new Buffer("abcd"),new Buffer("efg")])),n.append(new BufferList([new Buffer("hi"),new Buffer("j")])),e.equal(n.length,10),e.equal(n.slice(0,10).toString("ascii"),"abcdefghij"),e.equal(n.slice(3,10).toString("ascii"),"defghij"),e.equal(n.slice(3,6).toString("ascii"),"def"),e.equal(n.slice(3,8).toString("ascii"),"defgh"),e.equal(n.slice(5,10).toString("ascii"),"fghij"),e.end()}),tape("multiple bytes from crazy nested buffer lists",function(e){var n=new BufferList;n.append(new BufferList([new BufferList([new BufferList(new Buffer("abc")),new Buffer("d"),new BufferList(new Buffer("efg"))]),new BufferList([new Buffer("hi")]),new BufferList(new Buffer("j"))])),e.equal(n.length,10),e.equal(n.slice(0,10).toString("ascii"),"abcdefghij"),e.equal(n.slice(3,10).toString("ascii"),"defghij"),e.equal(n.slice(3,6).toString("ascii"),"def"),e.equal(n.slice(3,8).toString("ascii"),"defgh"),e.equal(n.slice(5,10).toString("ascii"),"fghij"),e.end()}),tape("append accepts arrays of Buffers",function(e){var n=new BufferList;n.append(new Buffer("abc")),n.append([new Buffer("def")]),n.append([new Buffer("ghi"),new Buffer("jkl")]),n.append([new Buffer("mnop"),new Buffer("qrstu"),new Buffer("vwxyz")]),e.equal(n.length,26),e.equal(n.slice().toString("ascii"),"abcdefghijklmnopqrstuvwxyz"),e.end()}),tape("append accepts arrays of BufferLists",function(e){var n=new BufferList;n.append(new Buffer("abc")),n.append([new BufferList("def")]),n.append(new BufferList([new Buffer("ghi"),new BufferList("jkl")])),n.append([new Buffer("mnop"),new BufferList([new Buffer("qrstu"),new Buffer("vwxyz")])]),e.equal(n.length,26),e.equal(n.slice().toString("ascii"),"abcdefghijklmnopqrstuvwxyz"),e.end()}),tape("append chainable",function(e){var n=new BufferList;e.ok(n.append(new Buffer("abcd"))===n),e.ok(n.append([new Buffer("abcd")])===n),e.ok(n.append(new BufferList(new Buffer("abcd")))===n),e.ok(n.append([new BufferList(new Buffer("abcd"))])===n),e.end()}),tape("append chainable (test results)",function(e){var n=new BufferList("abc").append([new BufferList("def")]).append(new BufferList([new Buffer("ghi"),new BufferList("jkl")])).append([new Buffer("mnop"),new BufferList([new Buffer("qrstu"),new Buffer("vwxyz")])]);e.equal(n.length,26),e.equal(n.slice().toString("ascii"),"abcdefghijklmnopqrstuvwxyz"),e.end()}),tape("consuming from multiple buffers",function(e){var n=new BufferList;n.append(new Buffer("abcd")),n.append(new Buffer("efg")),n.append(new Buffer("hi")),n.append(new Buffer("j")),e.equal(n.length,10),e.equal(n.slice(0,10).toString("ascii"),"abcdefghij"),n.consume(3),e.equal(n.length,7),e.equal(n.slice(0,7).toString("ascii"),"defghij"),n.consume(2),e.equal(n.length,5),e.equal(n.slice(0,5).toString("ascii"),"fghij"),n.consume(1),e.equal(n.length,4),e.equal(n.slice(0,4).toString("ascii"),"ghij"),n.consume(1),e.equal(n.length,3),e.equal(n.slice(0,3).toString("ascii"),"hij"),n.consume(2),e.equal(n.length,1),e.equal(n.slice(0,1).toString("ascii"),"j"),e.end()}),tape("complete consumption",function(e){var n=new BufferList;n.append(new Buffer("a")),n.append(new Buffer("b")),n.consume(2),e.equal(n.length,0),e.equal(n._bufs.length,0),e.end()}),tape("test readUInt8 / readInt8",function(e){var n=new Buffer(1),t=new Buffer(3),a=new Buffer(3),f=new BufferList;t[1]=3,t[2]=4,a[0]=35,a[1]=66,f.append(n),f.append(t),f.append(a),e.equal(f.readUInt8(2),3),e.equal(f.readInt8(2),3),e.equal(f.readUInt8(3),4),e.equal(f.readInt8(3),4),e.equal(f.readUInt8(4),35),e.equal(f.readInt8(4),35),e.equal(f.readUInt8(5),66),e.equal(f.readInt8(5),66),e.end()}),tape("test readUInt16LE / readUInt16BE / readInt16LE / readInt16BE",function(e){var n=new Buffer(1),t=new Buffer(3),a=new Buffer(3),f=new BufferList;t[1]=3,t[2]=4,a[0]=35,a[1]=66,f.append(n),f.append(t),f.append(a),e.equal(f.readUInt16BE(2),772),e.equal(f.readUInt16LE(2),1027),e.equal(f.readInt16BE(2),772),e.equal(f.readInt16LE(2),1027),e.equal(f.readUInt16BE(3),1059),e.equal(f.readUInt16LE(3),8964),e.equal(f.readInt16BE(3),1059),e.equal(f.readInt16LE(3),8964),e.equal(f.readUInt16BE(4),9026),e.equal(f.readUInt16LE(4),16931),e.equal(f.readInt16BE(4),9026),e.equal(f.readInt16LE(4),16931),e.end()}),tape("test readUInt32LE / readUInt32BE / readInt32LE / readInt32BE",function(e){var n=new Buffer(1),t=new Buffer(3),a=new Buffer(3),f=new BufferList;t[1]=3,t[2]=4,a[0]=35,a[1]=66,f.append(n),f.append(t),f.append(a),e.equal(f.readUInt32BE(2),50602818),e.equal(f.readUInt32LE(2),1109591043),e.equal(f.readInt32BE(2),50602818),e.equal(f.readInt32LE(2),1109591043),e.end()}),tape("test readFloatLE / readFloatBE",function(e){var n=new Buffer(1),t=new Buffer(3),a=new Buffer(3),f=new BufferList;t[1]=0,t[2]=0,a[0]=128,a[1]=63,f.append(n),f.append(t),f.append(a),e.equal(f.readFloatLE(2),1),e.end()}),tape("test readDoubleLE / readDoubleBE",function(e){var n=new Buffer(1),t=new Buffer(3),a=new Buffer(10),f=new BufferList;t[1]=85,t[2]=85,a[0]=85,a[1]=85,a[2]=85,a[3]=85,a[4]=213,a[5]=63,f.append(n),f.append(t),f.append(a),e.equal(f.readDoubleLE(2),.3333333333333333),e.end()}),tape("test toString",function(e){var n=new BufferList;n.append(new Buffer("abcd")),n.append(new Buffer("efg")),n.append(new Buffer("hi")),n.append(new Buffer("j")),e.equal(n.toString("ascii",0,10),"abcdefghij"),e.equal(n.toString("ascii",3,10),"defghij"),e.equal(n.toString("ascii",3,6),"def"),e.equal(n.toString("ascii",3,8),"defgh"),e.equal(n.toString("ascii",5,10),"fghij"),e.end()}),tape("test toString encoding",function(e){var n=new BufferList,t=new Buffer("abcdefghij\xff\x00");n.append(new Buffer("abcd")),n.append(new Buffer("efg")),n.append(new Buffer("hi")),n.append(new Buffer("j")),n.append(new Buffer("\xff\x00")),encodings.forEach(function(a){e.equal(n.toString(a),t.toString(a),a)}),e.end()}),!process.browser&&tape("test stream",function(e){var n=crypto.randomBytes(65534),t=hash(n,"md5"),a=crypto.createHash("md5"),f=new BufferList(function(n,r){e.ok(Buffer.isBuffer(r)),e.ok(null===n),e.equal(t,hash(f.slice(),"md5")),e.equal(t,hash(r,"md5")),f.pipe(fs.createWriteStream("/tmp/bl_test_rnd_out.dat")).on("close",function(){var n=fs.createReadStream("/tmp/bl_test_rnd_out.dat");n.on("data",a.update.bind(a)),n.on("end",function(){e.equal(t,a.digest("hex"),"woohoo! correct hash!"),e.end()})})});fs.writeFileSync("/tmp/bl_test_rnd.dat",n),fs.createReadStream("/tmp/bl_test_rnd.dat").pipe(f)}),tape("instantiation with Buffer",function(e){var n=crypto.randomBytes(1024),t=crypto.randomBytes(1024),a=BufferList(n);e.equal(n.toString("hex"),a.slice().toString("hex"),"same buffer"),a=BufferList([n,t]),e.equal(a.slice().toString("hex"),Buffer.concat([n,t]).toString("hex"),"same buffer"),e.end()}),tape("test String appendage",function(e){var n=new BufferList,t=new Buffer("abcdefghij\xff\x00");n.append("abcd"),n.append("efg"),n.append("hi"),n.append("j"),n.append("\xff\x00"),encodings.forEach(function(a){e.equal(n.toString(a),t.toString(a))}),e.end()}),tape("test Number appendage",function(e){var n=new BufferList,t=new Buffer("1234567890");n.append(1234),n.append(567),n.append(89),n.append(0),encodings.forEach(function(a){e.equal(n.toString(a),t.toString(a))}),e.end()}),tape("write nothing, should get empty buffer",function(e){e.plan(3),BufferList(function(n,t){e.notOk(n,"no error"),e.ok(Buffer.isBuffer(t),"got a buffer"),e.equal(0,t.length,"got a zero-length buffer"),e.end()}).end()}),tape("unicode string",function(e){e.plan(2);var n="\u2600",t="\u2603",a=n+" and "+t,f=BufferList();f.write(n),f.write(" and "),f.write(t),e.equal(a,f.toString()),e.equal(new Buffer(a).toString("hex"),f.toString("hex"))}),tape("should emit finish",function(e){var n=BufferList(),t=BufferList();n.write("hello"),n.pipe(t),t.on("finish",function(){e.equal(t.toString("utf8"),"hello"),e.end()})}),tape("basic copy",function(e){var n=crypto.randomBytes(1024),t=new Buffer(1024),a=BufferList(n);a.copy(t),e.equal(a.slice().toString("hex"),t.toString("hex"),"same buffer"),e.end()}),tape("copy after many appends",function(e){var n=crypto.randomBytes(512),t=new Buffer(1024),a=BufferList(n);a.append(n),a.copy(t),e.equal(a.slice().toString("hex"),t.toString("hex"),"same buffer"),e.end()}),tape("copy at a precise position",function(e){var n=crypto.randomBytes(1004),t=new Buffer(1024),a=BufferList(n);a.copy(t,20),e.equal(a.slice().toString("hex"),t.slice(20).toString("hex"),"same buffer"),e.end()}),tape("copy starting from a precise location",function(e){var n=crypto.randomBytes(10),t=new Buffer(5),a=BufferList(n);a.copy(t,0,5),e.equal(a.slice(5).toString("hex"),t.toString("hex"),"same buffer"),e.end()}),tape("copy in an interval",function(e){var n=crypto.randomBytes(10),t=BufferList(n),a=new Buffer(3),f=new Buffer(3);n.copy(f,0,5,8),t.copy(a,0,5,8),e.equal(a.toString("hex"),f.toString("hex"),"same buffer"),e.end()}),tape("copy an interval between two buffers",function(e){var n=crypto.randomBytes(10),t=new Buffer(10),a=BufferList(n);a.append(n),a.copy(t,0,5,15),e.equal(a.slice(5,15).toString("hex"),t.toString("hex"),"same buffer"),e.end()}),tape("duplicate",function(e){e.plan(2);var n=new BufferList("abcdefghij\xff\x00"),t=n.duplicate();e.equal(n.prototype,t.prototype),e.equal(n.toString("hex"),t.toString("hex"))}),tape("destroy no pipe",function(e){e.plan(2);var n=new BufferList("alsdkfja;lsdkfja;lsdk");n.destroy(),e.equal(n._bufs.length,0),e.equal(n.length,0)}),!process.browser&&tape("destroy with pipe before read end",function(e){e.plan(2);var n=new BufferList;fs.createReadStream(__dirname+"/test.js").pipe(n),n.destroy(),e.equal(n._bufs.length,0),e.equal(n.length,0)}),!process.browser&&tape("destroy with pipe before read end with race",function(e){e.plan(2);var n=new BufferList;fs.createReadStream(__dirname+"/test.js").pipe(n),setTimeout(function(){n.destroy(),setTimeout(function(){e.equal(n._bufs.length,0),e.equal(n.length,0)},500)},500)}),!process.browser&&tape("destroy with pipe after read end",function(e){function n(){t.destroy(),e.equal(t._bufs.length,0),e.equal(t.length,0)}e.plan(2);var t=new BufferList;fs.createReadStream(__dirname+"/test.js").on("end",n).pipe(t)}),!process.browser&&tape("destroy with pipe while writing to a destination",function(e){function n(){t.pipe(a),setTimeout(function(){t.destroy(),e.equals(t._bufs.length,0),e.equals(t.length,0),a.destroy(),e.equals(t._bufs.length,0),e.equals(t.length,0)},100)}e.plan(4);var t=new BufferList,a=new BufferList;fs.createReadStream(__dirname+"/test.js").on("end",n).pipe(t)}),!process.browser&&tape("handle error",function(e){e.plan(2),fs.createReadStream("/does/not/exist").pipe(BufferList(function(n,t){e.ok(n instanceof Error,"has error"),e.notOk(t,"no data")}))});