"use strict";var _typeof=function(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},Url=require("url"),Hoek=require("hoek"),Cryptiles=require("cryptiles"),Crypto=require("./crypto"),Utils=require("./utils"),internals={};exports.header=function(e,t,r){var a={field:"",artifacts:{}};if(!e||"string"!=typeof e&&"object"!==("undefined"==typeof e?"undefined":_typeof(e))||!t||"string"!=typeof t||!r||"object"!==("undefined"==typeof r?"undefined":_typeof(r)))return a.err="Invalid argument type",a;var o=r.timestamp||Utils.nowSecs(r.localtimeOffsetMsec),n=r.credentials;if(!(n&&n.id&&n.key&&n.algorithm))return a.err="Invalid credential object",a;if(-1===Crypto.algorithms.indexOf(n.algorithm))return a.err="Unknown algorithm",a;"string"==typeof e&&(e=Url.parse(e));var i={ts:o,nonce:r.nonce||Cryptiles.randomString(6),method:t,resource:e.pathname+(e.search||""),host:e.hostname,port:e.port||("http:"===e.protocol?80:443),hash:r.hash,ext:r.ext,app:r.app,dlg:r.dlg};a.artifacts=i,i.hash||!r.payload&&""!==r.payload||(i.hash=Crypto.calculatePayloadHash(r.payload,n.algorithm,r.contentType));var s=Crypto.calculateMac("header",n,i),l=null!==i.ext&&void 0!==i.ext&&""!==i.ext,c='Hawk id="'+n.id+'", ts="'+i.ts+'", nonce="'+i.nonce+(i.hash?'", hash="'+i.hash:"")+(l?'", ext="'+Hoek.escapeHeaderAttribute(i.ext):"")+'", mac="'+s+'"';return i.app&&(c=c+', app="'+i.app+(i.dlg?'", dlg="'+i.dlg:"")+'"'),a.field=c,a},exports.authenticate=function(e,t,r,a){if(r=Hoek.clone(r),a=a||{},e.headers["www-authenticate"]){var o=Utils.parseAuthorizationHeader(e.headers["www-authenticate"],["ts","tsm","error"]);if(o instanceof Error)return!1;if(o.ts){var n=Crypto.calculateTsMac(o.ts,t);if(n!==o.tsm)return!1}}if(!e.headers["server-authorization"]&&!a.required)return!0;var i=Utils.parseAuthorizationHeader(e.headers["server-authorization"],["mac","ext","hash"]);if(i instanceof Error)return!1;r.ext=i.ext,r.hash=i.hash;var s=Crypto.calculateMac("response",t,r);if(s!==i.mac)return!1;if(!a.payload&&""!==a.payload)return!0;if(!i.hash)return!1;var l=Crypto.calculatePayloadHash(a.payload,t.algorithm,e.headers["content-type"]);return l===i.hash},exports.getBewit=function(e,t){if(!e||"string"!=typeof e&&"object"!==("undefined"==typeof e?"undefined":_typeof(e))||!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))||!t.ttlSec)return"";t.ext=null===t.ext||void 0===t.ext?"":t.ext;var r=Utils.now(t.localtimeOffsetMsec),a=t.credentials;if(!(a&&a.id&&a.key&&a.algorithm))return"";if(-1===Crypto.algorithms.indexOf(a.algorithm))return"";"string"==typeof e&&(e=Url.parse(e));var o=Math.floor(r/1e3)+t.ttlSec,n=Crypto.calculateMac("bewit",a,{ts:o,nonce:"",method:"GET",resource:e.pathname+(e.search||""),host:e.hostname,port:e.port||("http:"===e.protocol?80:443),ext:t.ext}),i=a.id+"\\"+o+"\\"+n+"\\"+t.ext;return Hoek.base64urlEncode(i)},exports.message=function(e,t,r,a){if(!e||"string"!=typeof e||!t||"number"!=typeof t||null===r||void 0===r||"string"!=typeof r||!a||"object"!==("undefined"==typeof a?"undefined":_typeof(a)))return null;var o=a.timestamp||Utils.nowSecs(a.localtimeOffsetMsec),n=a.credentials;if(!(n&&n.id&&n.key&&n.algorithm))return null;if(-1===Crypto.algorithms.indexOf(n.algorithm))return null;var i={ts:o,nonce:a.nonce||Cryptiles.randomString(6),host:e,port:t,hash:Crypto.calculatePayloadHash(r,n.algorithm)},s={id:n.id,ts:i.ts,nonce:i.nonce,hash:i.hash,mac:Crypto.calculateMac("message",n,i)};return s};