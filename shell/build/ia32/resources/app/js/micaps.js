$(function(){function a(a,e){a&&a.length>0&&$.each(a,e)}function e(){for(var a;a=r.shift();)map.removeLayer(a)}function n(e){var n=e.areas;n&&a(n,function(e,n){var i=[];a(n.items,function(a,e){i.push([e.y,e.x])});var t=L.polygon(i,{stroke:!1,fill:!0,fillColor:n.c,fillOpacity:.6}).addTo(map);r.push(t)});var i=e.line_symbols;if(i){var t={2:"blue",3:"red",38:"red"};a(i,function(e,n){if(0!=n.code){var i=[],o=n.items;a(o,function(a,e){i.push([e.y,e.x])});var c=L.polyline(i,{stroke:!0,color:t[n.code],weight:2}).addTo(map);r.push(c)}})}var o=e.lines;o&&a(o,function(e,n){var i=[];a(n.items||n.point,function(a,e){i.push([e.y,e.x])});var t=L.polyline(i,{stroke:!0,color:"#1010FF",weight:2}).addTo(map);r.push(t)})}function i(){if(l){e();var n=map.getZoom(),i=l.level1.slice();n>6&&(i=i.concat(l.level2.slice())),n>9&&(i=i.concat(l.level3.slice()));var t=map.getBounds();a(i,function(e,n){var i=L.latLng(n.lat,n.lon);if(t.contains(i)){var o=L.divIcon({className:"station",html:"<p>"+n.name+"</p>",iconSize:L.point(80,90)}),c=L.marker(i,{icon:o,zIndexOffset:10}).addTo(map).on("click",function(){m.show();var e=m.find(".tongji_bar_container").html("");m.find(".tongji_title").html(n.name+" "+n.stationid),m.addClass("loading"),Util.req(Util.encryURL("http://scapi.weather.com.cn/weather/historycount?stationid="+n.stationid+"&areaid="+n.areaid),{loading:!1},function(n,i){m.removeClass("loading");var t=i.days,o=i.starttime,c=i.endtime,r={"\u96e8":"rgba(41, 193, 8, 1)","\u96ea":"rgba(141, 152, 179, 1)","\u6c99\u5c18":"rgba(253, 104, 1, 1)","\u96fe":"rgba(89, 255, 255, 1)","\u973e":"rgba(201, 155, 20, 1)","\u5176\u5b83":"rgba(204, 204, 204, 1)",_:"rgba(151, 181, 82, 1)"},l=i.tqxxcount.length;a(i.tqxxcount,function(a,n){var i=n.value/t,o=$('<div class="tongji_bar_wrap" style="width:'+1/l*100+'%"><div class="tongji_bar"></div><p>'+n.name+"<br/>"+n.value+"\u5929</p></div>").appendTo(e);new Util.UI.Ring({container:o.find(".tongji_bar"),circlePercent:{color:r[n.name]||r._},percent:i})});var s=i.count,d=s[0],f=s[5],p=s[1],u="\u81ea"+o+"\u81f3"+c+":<br/>\u65e5\u6700\u9ad8\u6c14\u6e29<em>"+d.max+"</em>\u2103, \u65e5\u6700\u4f4e\u6c14\u6e29<em>"+d.min+"</em>\u2103, \u65e5\u6700\u5927\u98ce\u901f<em>"+f.max+"</em>m/s, \u65e5\u6700\u5927\u964d\u6c34\u91cf<em>"+p.max+"</em>mm, \u8fde\u7eed\u65e0\u964d\u6c34\u65e5\u6570<em>"+i.no_rain_lx+"</em>\u5929, \u8fde\u7eed\u973e\u65e5\u6570<em>"+i.mai_lx+"</em>\u5929\u3002";m.find(".tongji_desc").html(u)})});r.push(c)}})}}function t(){if(s){e();var n=map.getZoom(),i=s.level1.slice();n>6&&(i=i.concat(s.level2.slice())),n>9&&(i=i.concat(s.level3.slice()));var t=map.getBounds();a(i,function(a,e){var n=L.latLng(e.lat,e.lon);if(t.contains(n)){var i=e.aqi,o={};i>=0&&50>=i?o={cname:"you",name:"\u4f18",color:"rgb(0, 228, 0)",desc:"\u7a7a\u6c14\u8d28\u91cf\u4ee4\u4eba\u6ee1\u610f\uff0c\u57fa\u672c\u65e0\u7a7a\u6c14\u6c61\u67d3\uff0c\u5404\u7c7b\u4eba\u7fa4\u53ef\u6b63\u5e38\u6d3b\u52a8\u3002"}:i>=51&&100>=i?o={cname:"liang",name:"\u826f",color:"rgb(255, 255, 0)",desc:"\u7a7a\u6c14\u8d28\u91cf\u53ef\u63a5\u53d7\uff0c\u4f46\u67d0\u4e9b\u6c61\u67d3\u7269\u53ef\u80fd\u5bf9\u6781\u5c11\u6570\u5f02\u5e38\u654f\u611f\u4eba\u7fa4\u5065\u5eb7\u6709\u8f83\u5f31\u5f71\u54cd\uff0c\u5efa\u8bae\u6781\u5c11\u6570\u5f02\u5e38\u654f\u611f\u4eba\u7fa4\u5e94\u51cf\u5c11\u6237\u5916\u6d3b\u52a8\u3002"}:i>=101&&150>=i?o={cname:"qingdu",name:"\u8f7b\u5ea6",color:"rgb(255, 126, 0)",desc:"\u6613\u611f\u4eba\u7fa4\u75c7\u72b6\u6709\u8f7b\u5ea6\u52a0\u5267\uff0c\u5065\u5eb7\u4eba\u7fa4\u51fa\u73b0\u523a\u6fc0\u75c7\u72b6\u3002\u5efa\u8bae\u513f\u7ae5\u3001\u8001\u5e74\u4eba\u53ca\u5fc3\u810f\u75c5\u3001\u547c\u5438\u7cfb\u7edf\u75be\u75c5\u60a3\u8005\u5e94\u51cf\u5c11\u957f\u65f6\u95f4\u3001\u9ad8\u5f3a\u5ea6\u7684\u6237\u5916\u953b\u70bc\u3002"}:i>=151&&200>=i?o={cname:"zhongdu",name:"\u4e2d\u5ea6",color:"rgb(255, 0, 0)",desc:"\u8fdb\u4e00\u6b65\u52a0\u5267\u6613\u611f\u4eba\u7fa4\u75c7\u72b6\uff0c\u53ef\u80fd\u5bf9\u5065\u5eb7\u4eba\u7fa4\u5fc3\u810f\u3001\u547c\u5438\u7cfb\u7edf\u6709\u5f71\u54cd\uff0c\u5efa\u8bae\u75be\u75c5\u60a3\u8005\u907f\u514d\u957f\u65f6\u95f4\u3001\u9ad8\u5f3a\u5ea6\u7684\u6237\u5916\u953b\u7ec3\uff0c\u4e00\u822c\u4eba\u7fa4\u9002\u91cf\u51cf\u5c11\u6237\u5916\u8fd0\u52a8\u3002"}:i>=201&&300>=i?o={cname:"zhongduwuran",name:"\u91cd\u5ea6",color:"rgb(153, 0, 76)",desc:"\u5fc3\u810f\u75c5\u548c\u80ba\u75c5\u60a3\u8005\u75c7\u72b6\u663e\u8457\u52a0\u5267\uff0c\u8fd0\u52a8\u8010\u53d7\u529b\u964d\u4f4e\uff0c\u5065\u5eb7\u4eba\u7fa4\u666e\u904d\u51fa\u73b0\u75c7\u72b6-\u5efa\u8bae\u513f\u7ae5\u3001\u8001\u5e74\u4eba\u548c\u5fc3\u810f\u75c5\u3001\u80ba\u75c5\u60a3\u8005\u5e94\u505c\u7559\u5728\u5ba4\u5185\uff0c\u505c\u6b62\u6237\u5916\u8fd0\u52a8\uff0c\u4e00\u822c\u4eba\u7fa4\u51cf\u5c11\u6237\u5916\u8fd0\u52a8\u3002"}:i>=301&&(o={cname:"yanzhong",name:"\u4e25\u91cd",color:"rgb(126, 0, 35)",desc:"\u5065\u5eb7\u4eba\u7fa4\u8fd0\u52a8\u8010\u53d7\u529b\u964d\u4f4e\uff0c\u6709\u660e\u663e\u5f3a\u70c8\u75c7\u72b6\uff0c\u63d0\u524d\u51fa\u73b0\u67d0\u4e9b\u75be\u75c5-\u5efa\u8bae\u513f\u7ae5\u3001\u8001\u5e74\u4eba\u548c\u75c5\u4eba\u5e94\u5f53\u7559\u5728\u5ba4\u5185\uff0c\u907f\u514d\u4f53\u529b\u6d88\u8017\uff0c\u4e00\u822c\u4eba\u7fa4\u5e94\u907f\u514d\u6237\u5916\u6d3b\u52a8\u3002"});var c=L.divIcon({className:"station_aqi aqi_"+o.cname,html:"<p>"+e.name+"</p>",iconSize:L.point(55,63)}),l=L.marker(n,{icon:c,zIndexOffset:10}).addTo(map).on("click",function(){d.find(".aqi_location").text(e.name),d.find(".aqi_val").text(e.aqi),d.find(".aqi_level").css("background-color",o.color).text(o.name),d.find(".aqi_desc").text("\u6e29\u99a8\u63d0\u793a\uff1a"+o.desc),d.find(".aqi_info div").css("border-color",o.color),d.find(".aqi_val_aqi").text(e.rank),d.find(".aqi_val_pm25").text(e.pm2_5),d.find(".aqi_val_pm10").text(e.pm10),d.show()});r.push(l)}})}}function o(){map.off("zoomend",i),map.off("dragend",i),l=null,s=null}var c={haze:{name:"\u5168\u56fd\u973e\u533a\u9884\u62a5",dataurl:"http://scapi.weather.com.cn/weather/micapsfile?fileMark=haze_fc&isChina=true",type:"micaps"},fog:{name:"\u5168\u56fd\u96fe\u533a\u9884\u62a5",dataurl:"http://scapi.weather.com.cn/weather/micapsfile?fileMark=fog_fc&isChina=true",type:"micaps"},aqi_wr:{name:"\u7a7a\u6c14\u6c61\u67d3\u6c14\u8c61\u6761\u4ef6\u9884\u62a5",dataurl:"http://scapi.weather.com.cn/weather/micapsfile?fileMark=kqzl_24,kqzl_48,kqzl_72&isChina=true",type:"3d"},aqi:{name:"\u7a7a\u6c14\u8d28\u91cf",dataurl:"http://scapi.weather.com.cn/weather/getaqiobserve",type:"aqi"},rain3d:{name:"\u672a\u6765\u4e09\u5929\u964d\u6c34\u91cf\u9884\u62a5",dataurl:"http://scapi.weather.com.cn/weather/micapsfile?fileMark=js_24_fc,js_48_fc,js_72_fc&isChina=true",type:"micaps"},xsc:{name:"\u4e9a\u6b27\u5730\u9762\u573a\u5206\u6790",dataurl:"./data/xsc.json",is_file:!0,type:"micaps"},xsc500:{name:"\u4e9a\u6b27\u9ad8\u7a7a\u573a500hPa",dataurl:"http://scapi.weather.com.cn/weather/micapsfile?fileMark=h500&isChina=false",type:"micaps"},tongji:{name:"\u5929\u6c14\u7edf\u8ba1",dataurl:"http://scapi.weather.com.cn/weather/stationinfo",type:"tongji"}};$(".box_btn_close").click(function(){$(this).closest(".box_dialog").hide()});var r=[];W.require.bind(null,["maps"],function(a){map=a})();var l,s,m=$("#tongji_panel"),d=$("#aqi_panel");d.find(".btn_close_aqi").click(function(){d.hide()});var f={micaps:function(e){e=e.slice(0,1),a(e,function(a,e){n(e)})},tongji:function(a){l=a,map.on("zoomend",i),map.on("dragend",i),i()},aqi:function(a){s=a.data,map.on("zoomend",t),map.on("dragend",t),t()}};window.Micaps={init:function(a){var n=c[a];if(n){var i=n.dataurl;n.is_file||(i=Util.encryURL(i)),Util.req(i,{dealError:!1},function(i,t){if(console.log(i,t),o(),i)alert(a+"\u6570\u636e\u8bf7\u6c42\u51fa\u73b0\u9519\u8bef\uff01");else{e();var c=f[n.type];c&&c(t)}})}},clear:function(){o(),e()},getConf:function(a){var e=c[a];return e?e:void 0}}});