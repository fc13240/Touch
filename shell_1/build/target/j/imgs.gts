$(function(){function t(t,e,i){if(g[t])return i();var n=new Image;n.crossOrigin="anonymous";var r=a;n.onload=function(){var a=this;if(is_native&&1!=e){var o=document.createElement("canvas"),s=a.width,c=a.height,u=1400;if(s>c){var l=s/u;s=u,c/=l}else{var l=c/u;c=u,s/=l}s=parseInt(s),c=parseInt(c),o.width=s,o.height=c;var f=o.getContext("2d");f.drawImage(n,0,0,s,c);var d=f.getImageData(0,0,s,c);if(r)return r.onmessage=function(n){for(var a=n.data.data,r=0,s=a.length;s>r;r+=4)a[r+3]=Math.min(a[r+3]*e,255);f.putImageData(n.data,0,0),g[t]=o.toDataURL("image/png"),i()},void r.postMessage({imageData:d,width:s,height:c,radius:2});f.putImageData(d,0,0),g[t]=o.toDataURL("image/png")}else g[t]=t;i()},n.onerror=function(){g[t]="",i()},n.src=t}function e(e,i,n){function a(){c+=1,d.trigger("load_progress",c/s),c>=s?(h[o]=!0,n()):r()}function r(){var n=e.shift();n&&t(n[0],i,a)}var o=e.url;if(h[o])return n();e=e.slice();var s=e.length,c=0;d.trigger("load_progress",0),r()}function i(t,i,n){e(t,i,function(){if(c){for(var e=0,i=t.length;i>e;e++){var a=t[e],s=a[0],u=a[2],l=n||[[u[0],u[1]],[u[2],u[3]]],f=L.imageOverlay(g[s],l);f.addTo(r),f.setOpacity(0==e?1:0),f._time=a[1],o.push(f)}d.trigger("img_inited",{total:i})}})}function n(t){var e=o.length;0>t?t=0:t>=e&&(t=0);for(var i=0;e>i;i++)o[i].setOpacity(i==t?1:0);s=t;var n=o[s];n&&d.trigger("change_img",{url:n._url,time:n._time,index:s,total:e})}var a,r,o=[],s=0,c=!0,u=function(){var t="";is_native||(t="http://10.14.85.116/php/proxy.php?url=");return{get:function(e,i){e=t+e,Util.req(e,i)}}}();W.require.bind(null,["blurWorker","maps"],function(t,e){a=t,r=e})();var g={},l=function(){function t(){g?(a(),s.removeClass("playing")):(n(),s.addClass("playing")),g=!g}function e(e){r.show(),g=!1,t(),f=e,u&&this.play()}function i(t){0>t?t=0:t>f-1&&(t=f-1),d.trigger("player_changeindex",{index:t}),h=t,f>0&&o.css("width",h/(f-1)*100+"%")}function n(){clearTimeout(l);i(h);var t=h+1;0>t?t=0:t>f-1&&(t=0),h=t,l=setTimeout(n,p)}function a(){clearTimeout(l)}var r=$(".box_player"),o=$(".player_progressbar_progress"),s=$(".player_btn"),c=$(".player_progressbar");c.on("click",function(e){e.originalEvent&&(e=e.originalEvent);var n=e.layerX/c[0].offsetWidth,a=Math.floor(n*f);g=!0,t(),i(a)});var u=!0,g=u;s.bind("click",t);var l,f=0,h=0,p=300;return{init:e,setIndex:i,play:n,pause:a,clear:function(){f=0,h=0,a()},hide:function(){r.hide()},reset:function(){this.clear(),this.hide()}}}(),f=$(".load_progress_wrap"),d=$(document).on("load_progress",function(t,e){c&&(1>e?f.show():f.hide(),f.html((100*e).toFixed(1)+"%"))});d.on("change_img",function(t,e){if(c){var i=new Date(1e3*e.time);$(".box_title_container .time").show(),$("#time_top").html(i.format("yyyy\u5e74MM\u6708dd\u65e5")),$("#time_bottom").html(i.format("hh:mm"))}}),d.on("player_changeindex",function(t,e){c&&n(e.index)}),d.on("img_inited",function(t,e){c&&l.init(e.total)});var h={};window.Imgs={init:function(t){if(this.stop(),c=!0,"radar"==t){var e="http://api.tianqi.cn:8070/v1/img.py";u.get(e,function(t,n){var a=n.radar_img;a.url=e,i(a,4)})}else if("cloud"==t){var e="http://radar.tianqi.cn/radar/imgs.php?type=cloud_new";u.get(e,function(t,n){for(var a=[],r=n.l,o=r.length-1;o>=0;o--){var s=r[o];a.push([s.l2,new Date(s.l1).getTime()/1e3])}a.url=e,i(a,1.1,[[-4.98,50.02],[59.97,144.97]])})}},setIndex:n,stop:function(t){void 0!==t&&(o[s].setOpacity(0),o[t].setOpacity(1))},getOverlays:function(){return o},clear:function(){c=!1,l.reset();for(var t;t=o.shift();)r.removeLayer(t)}}});