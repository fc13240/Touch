!function(){function t(t,e){function a(a){e&&(a=a.filter(function(t){return p||t.is_active?t:void 0}),p&&(a=a.slice(-6))),t(a)}var n=u[v];n?a(n):$.get(v,function(t){var e=[];$(t).find("typhoon").each(function(){var t=$(this),a=t.attr("chnName"),n=t.attr("enName");if("\u5185\u90e8\u7f16\u53f7"!=a&&"NAMELESS"!=n){var i=/(\d{2})$/.exec(t.attr("interCode"));e.push({is_active:!!t.attr("year"),index:i[1],code:t.attr("xuHao"),cnName:a,enName:n})}});var n={};$.each(e,function(t,e){var a=e.index,i=n[a];i?i.push(e):n[a]=[e]});var i=[];for(var o in n){var r=n[o];if(r.length>1){r.sort(function(t,e){return t.code.localeCompare(e.code)});var l=!1,s=[];$.each(r,function(t,e){e.is_active&&(l=!0),s.push(e.code)}),r[0].is_active=l,r[0].code_list=s,i.push(r[0])}else i.push(r[0])}i.sort(function(t,e){return t.code.localeCompare(e.code)}),u[v]=i,a(i)})}function e(t){var e=/^(\d{4})(\d{2})(\d{2})(\d{2})/.exec(t),a=new Date(e[1]+"-"+e[2]+"-"+e[3]+" "+e[4]+":00");return a.setHours(a.getHours()+8),a}function a(t,a){var n="typhoon_"+t,i=u[n];if(i)a(i);else{var o=[];try{t=t.split(",")}catch(r){t=[t]}$.each(t,function(t,e){o.push($.get(d+e+".xml?"+Math.random()))}),$.when.apply($,o).done(function(){function i(t,e){t=parseFloat(t),e=parseFloat(e),l>t&&(l=t),min_lat>e&&(min_lat=e),t>s&&(s=t),e>max_lat&&(max_lat=e)}for(var r=[],l=min_lat=Number.MAX_VALUE,s=max_lat=-Number.MAX_VALUE,c=0,h=1==o.length?[arguments]:arguments,d=h.length;d>c;c++){var v=h[c][0];$(v).find("key").each(function(){var t=$(this),a={time:e(t.attr("YMDHM")),lat:t.attr("V05"),lng:t.attr("V06"),level:t.attr("V07"),wind:t.attr("V08"),qy:t.attr("V09"),move_speed:t.attr("V11"),move_dir:t.attr("V12"),r7:t.attr("V21"),r10:t.attr("V22"),r7_en:t.attr("V71"),r7_es:t.attr("V72"),r7_wn:t.attr("V73"),r7_ws:t.attr("V74"),r10_en:t.attr("V101"),r10_es:t.attr("V102"),r10_wn:t.attr("V103"),r10_ws:t.attr("V104"),r12_en:t.attr("V121"),r12_es:t.attr("V122"),r12_wn:t.attr("V123"),r12_ws:t.attr("V124")};i(a.lng,a.lat);var n=[];t.find("ele").each(function(){var t=$(this);n.push({aging:parseInt(t.attr("V04")),lat:t.attr("V05"),lng:t.attr("V06"),level:t.attr("V07"),wind:t.attr("V08"),qy:t.attr("V09")})}),a.forecast=n,r.push(a)})}var p=r[r.length-1];$.each(p.forecast,function(t,e){i(e.lng,e.lat)}),u["bound_"+t]=[[max_lat,l],[min_lat,s]],u[n]=r,a(r)})}}function n(t,e){var a=E.getZoom(),n=N[a];if(n)var i=n/67,o=e["r"+t+"_en"]/i,r=e["r"+t+"_es"]/i,l=e["r"+t+"_ws"]/i,s=e["r"+t+"_wn"]/i,c=Math.abs(o-s),h=Math.abs(r-l),d=Math.abs(s-l),v=Math.abs(o-r),u='<div class="wind_radiu level'+t+'"><div class="radiu radiu_en" style="width:'+o+"px;height:"+o+'px;"></div><div class="radiu radiu_es" style="width:'+r+"px;height:"+r+'px;"></div><div class="radiu radiu_wn" style="width:'+s+"px;height:"+s+'px;"></div><div class="radiu radiu_ws" style="width:'+l+"px;height:"+l+'px;"></div><div class="line line_up" style="height:'+c+"px;margin-top:"+(-Math.max(o,s)+2)+'px"></div><div class="line line_down" style="height:'+h+"px;margin-top:"+(Math.max(r,l)-h)+'px"></div><div class="line line_left" style="width:'+d+"px;margin-right:"+(Math.max(s,l)-d-2)+'px"></div><div class="line line_right" style="width:'+v+"px;margin-left:"+(Math.max(o,r)-v)+'px"></div></div>';return u}function i(t,e){e=e||"";var a=t.level,i=1;7>=a?i=1:a>7&&9>=a?i=2:a>9&&1>=a?i=3:a>11&&13>=a?i=4:a>13&&15>=a?i=5:a>15&&17>=a&&(i=6);var o="wind_level wl_"+i,r=L.divIcon({className:o,html:e,iconSize:L.point(20,20)}),l=L.marker([t.lat,t.lng],{icon:r}).addTo(E).on("click",function(){if(g){var a=g.options.icon.options;a.html=e,g.setIcon(L.divIcon(a)),g.setZIndexOffset(99999)}if(g=l,!t.aging){var a=l.options.icon.options;a.html=e+n(7,t)+n(10,t);var i=L.divIcon(a);l.setIcon(i),l.setZIndexOffset(-99999)}});return l}function o(t){return'<div class="popup"><span></span>'+t+"</div>"}function r(t){a(t,function(e){function a(t){t&&s.push(t)}function n(){var l=x&&0==h?y:e[h-1],s=e[h];if(s){var c={color:"white",weight:2,opacity:1};x&&(c.dashArray=[10,8]);var d=L.latLng(l.lat,l.lng),u=L.latLng(s.lat,s.lng),p=L.polyline([d,u],c).addTo(E);if(a(p),a(i(s)),!x){_.setLatLng(u);var m=_.options.icon.options;m.html='<div class="rotate"></div>'+o(s.time.format((r.cnName||r.enName)+"(MM\u6708dd\u65e5hh\u65f6)")),_.setIcon(L.divIcon(m)),y=u}var f=!1;v>h?(h++,f=!0):(e=s.forecast,e&&(h=0,v=e.length-1,x=!0,f=!0)),f&&(I[t]=setTimeout(n,g))}}var r=u[t],l=u["bound_"+t];E.fitBounds(l);var s=S[t]||(S[t]=[]),h=0,d=e.length,v=d-1,p=e[h++],m=d,f=e[v].forecast;f&&(m+=f.length);var g=Math.min(A,Math.ceil(k/m)),_=L.marker([p.lat,p.lng],{icon:L.divIcon({className:"typhoon_icon",html:'<div class="rotate"></div>',iconSize:[30,30]})});_.__items=e,_.__typhoon_info=r,_.on("click",function(){var t=_.__typhoon_info;c(_.__items,t.cnName+"(\u7b2c"+t.index+"\u53f7\u53f0\u98ce"+t.enName+")")}).addTo(E),a(_),a(i(p,o(r.cnName||r.enName)));var y,x=!1;I[t]=setTimeout(n,g)})}function l(t){var e=S[t];e&&(clearTimeout(I[t]),$.each(e,function(t,e){E.removeLayer(e)}))}function s(){var t="";y.find(".btn_typhoon.on").each(function(){var e=$(this).data("code"),a=u[e];t+="<li>"+a.cnName+"(\u7b2c"+a.index+"\u53f7\u53f0\u98ce"+a.enName+")</li>"}),t?x.show():x.hide(),x.html(t)}function c(t,e){if(ecObj){_&&_.dispose();var a=[],n=[],i=t.length-1,o=[];$.each(t,function(t,e){var r=e.time.format("MM\u6708dd\u65e5hh\u65f6");o.push(r),a.push(0===t||t===i?r:" "),n.push(e.wind)});var r=a.length-1,l=(a[r],n[n.length-1]),s=t[t.length-1],c=s.forecast;if(c){var h=s.time,i=c.length-1;$.each(c,function(t,e){var r=new Date(h.getTime());r.setHours(r.getHours()+e.aging);var l=r.format("MM\u6708dd\u65e5hh\u65f6");o.push(l),a.push(i===t?l:"  "),n.push(e.wind)})}for(var d=(Math.min.apply(Math,n),Math.max.apply(Math,n)),v=[{val:[10.8,17.1],name:"\u70ed\u5e26\u4f4e\u538b",color:"rgba(110,196,186, 0.8)"},{val:[17.2,24.4],name:"\u70ed\u5e26\u98ce\u66b4",color:"rgba(239,234,58, 0.8)"},{val:[24.5,32.6],name:"\u5f3a\u70ed\u5e26\u98ce\u66b4",color:"rgba(239,124,27, 0.8)"},{val:[32.7,41.4],name:"\u53f0\u98ce",color:"rgba(231,31,30, 0.8)"},{val:[41.5,50.9],name:"\u5f3a\u53f0\u98ce",color:"rgba(230,38,135, 0.8)"},{val:[51,Math.max(55,d)],name:"\u8d85\u5f3a\u53f0\u98ce",color:"rgba(126,64,149, 0.8)"}],u=[],p=0,m=0,f=v.length;f>m;m++){var g=v[m],y=g.val,x=y[1]-y[0];p+=x,u.push({d:x,c:g.color})}for(var V=[],L=0,m=0,f=u.length;f>m;m++){var g=u[m];L+=g.d/p,V.push([L,g.c])}b.show().css({left:"100%"}).animate({left:"15%"},{easing:"swing"}),w.text(e),_=ecObj.init(M.get(0));var N=10,S=Math.max(55,d),I=5,A=S%I;A>0&&(S=S-A+I),_.setOption({color:["white"],grid:{borderColor:"rgba(0, 0, 0, 0)"},tooltip:{trigger:"axis",formatter:function(t){console.log(arguments);var e=t[0];return o[e.dataIndex]+"<br/>"+e.seriesName+":"+e.value+"m/s"}},legend:{show:!1,data:[""]},calculable:!0,xAxis:{show:1,boundaryGap:!1,data:a,axisLabel:{textStyle:{color:"white",fontSize:16}},splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.3)"}},axisLine:{show:!1}},yAxis:{show:1,min:N,max:S,splitNumber:Math.floor((S-N)/5),axisLabel:{textStyle:{color:"white",fontSize:16}},splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.3)"}},axisLine:{show:!1}},series:[{name:"\u98ce\u901f",type:"line",smooth:1,symbolSize:2,clickable:!1,draggable:!1,itemStyle:{normal:{areaStyle:{type:"default",color:function(){var t=require_web("zrender/tool/color");return t.getLinearGradient(0,M.height(),0,0,V)}()},lineStyle:{color:"rgba(0, 0, 0, 0)"}}},data:n,markLine:{itemStyle:{normal:{lineStyle:{type:"solid",color:"#1d6fb8"}}},data:[[{xAxis:r,yAxis:0},{xAxis:r,yAxis:l-1}]]}}]})}}function h(t){var e="";$.each(t,function(t,a){u[a.code_list||a.code]=a,e+='<div class="box btn_typhoon" data-code="'+(a.code_list||a.code)+'">'+(a.cnName||a.enName)+"</div>"}),y.html(e)}Date.prototype.format=function(t,e){t||(t="yyyy-MM-dd hh:mm:ss");var a={"M{2}":this.getMonth()+1,"d{2}":this.getDate(),"h{2}":this.getHours(),"m{2}":this.getMinutes(),"q{2}":Math.floor((this.getMonth()+3)/3)};e||(a["s{2}"]=this.getSeconds(),a["S{2}"]=this.getMilliseconds()),/(y{4}|y{2})/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var n in a)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[n]:("00"+a[n]).substr((""+a[n]).length)));return t};var d="http://typhoon.weather.gov.cn/Typhoon/data/",v=d+"typhoonList.xml?"+Math.random(),u={},p=!0;try{var m=require("nw.gui").App.manifest;p=!!m.release}catch(f){}var g,_,y,x,w,b,M,V,N={19:.02,18:.05,17:.1,16:.2,15:.5,14:1,13:2,12:4,11:10,10:20,9:25,8:50,7:100,6:200,5:500,4:1e3,3:2e3},S={},I={},A=200,k=5e3;$(function(){V=$("#wrap_typhoon"),b=$(".wrap_typhoon_chart"),M=$("#typhoon_chart"),w=b.find(".typhoon_name"),y=$(".btn_typhoon_list").delegate(".btn_typhoon","click",function(e){e.stopPropagation();var a=$(this),n=a.data("code");a.hasClass("on")?(a.removeClass("on"),l(n)):(a.addClass("on"),r(n)),s(),t.click()}),x=$(".typhoon_list").html("");var t=$("#btn_close_typhoon_chart").click(function(){$(this).parent().hide()});require_web.config({paths:{echarts:"./js/"}}),require_web(["echarts","echarts/chart/line"],function(t){ecObj=t});var e=function(t){t.preventDefault?t.preventDefault():window.event.returnValue=!1};b.bind("touchmove",e)});var E;W.define("typhoon",["maps"],function(t){E=t,E.on("zoomstart",function(){if(g){var t=g.options.icon.options;t.html="",g.setIcon(L.divIcon(t))}})}),window.Typhoon={init:function(){V.show(),t(function(t){t.length>0?h(t):x.html("<li>\u5f53\u524d\u65e0\u53f0\u98ce</li>")},!0)},clear:function(){V.hide(),b.hide();var t=u[v];if(t)for(var e=0,a=t.length;a>e;e++)l(t[e].code)}}}();