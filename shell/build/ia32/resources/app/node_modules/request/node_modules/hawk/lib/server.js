var Boom=require("boom"),Hoek=require("hoek"),Cryptiles=require("cryptiles"),Crypto=require("./crypto"),Utils=require("./utils"),internals={};exports.authenticate=function(e,t,a,o){o=Hoek.nextTick(o),a.nonceFunc=a.nonceFunc||internals.nonceFunc,a.timestampSkewSec=a.timestampSkewSec||60;var n=Utils.now(a.localtimeOffsetMsec),r=Utils.parseRequest(e,a);if(r instanceof Error)return o(Boom.badRequest(r.message));var i=Utils.parseAuthorizationHeader(r.authorization);if(i instanceof Error)return o(i);var s={method:r.method,host:r.host,port:r.port,resource:r.url,ts:i.ts,nonce:i.nonce,hash:i.hash,ext:i.ext,app:i.app,dlg:i.dlg,mac:i.mac,id:i.id};return i.id&&i.ts&&i.nonce&&i.mac?void t(i.id,function(e,t){if(e)return o(e,t||null,s);if(!t)return o(Boom.unauthorized("Unknown credentials","Hawk"),null,s);if(!t.key||!t.algorithm)return o(Boom.internal("Invalid credentials"),t,s);if(-1===Crypto.algorithms.indexOf(t.algorithm))return o(Boom.internal("Unknown algorithm"),t,s);var u=Crypto.calculateMac("header",t,s);if(!Cryptiles.fixedTimeComparison(u,i.mac))return o(Boom.unauthorized("Bad mac","Hawk"),t,s);if(a.payload||""===a.payload){if(!i.hash)return o(Boom.unauthorized("Missing required payload hash","Hawk"),t,s);var l=Crypto.calculatePayloadHash(a.payload,t.algorithm,r.contentType);if(!Cryptiles.fixedTimeComparison(l,i.hash))return o(Boom.unauthorized("Bad payload hash","Hawk"),t,s)}a.nonceFunc(t.key,i.nonce,i.ts,function(e){if(e)return o(Boom.unauthorized("Invalid nonce","Hawk"),t,s);if(Math.abs(1e3*i.ts-n)>1e3*a.timestampSkewSec){var r=Crypto.timestampMessage(t,a.localtimeOffsetMsec);return o(Boom.unauthorized("Stale timestamp","Hawk",r),t,s)}return o(null,t,s)})}):o(Boom.badRequest("Missing attributes"),null,s)},exports.authenticatePayload=function(e,t,a,o){var n=Crypto.calculatePayloadHash(e,t.algorithm,o);return Cryptiles.fixedTimeComparison(n,a.hash)},exports.authenticatePayloadHash=function(e,t){return Cryptiles.fixedTimeComparison(e,t.hash)},exports.header=function(e,t,a){if(a=a||{},!t||"object"!=typeof t||"object"!=typeof a)return"";if(t=Hoek.clone(t),delete t.mac,t.hash=a.hash,t.ext=a.ext,!e||!e.key||!e.algorithm)return"";if(-1===Crypto.algorithms.indexOf(e.algorithm))return"";t.hash||!a.payload&&""!==a.payload||(t.hash=Crypto.calculatePayloadHash(a.payload,e.algorithm,a.contentType));var o=Crypto.calculateMac("response",e,t),n='Hawk mac="'+o+'"'+(t.hash?', hash="'+t.hash+'"':"");return null!==t.ext&&void 0!==t.ext&&""!==t.ext&&(n+=', ext="'+Hoek.escapeHeaderAttribute(t.ext)+'"'),n},internals.bewitRegex=/^(\/.*)([\?&])bewit\=([^&$]*)(?:&(.+))?$/,exports.authenticateBewit=function(e,t,a,o){o=Hoek.nextTick(o);var n=Utils.now(a.localtimeOffsetMsec),r=Utils.parseRequest(e,a);if(r instanceof Error)return o(Boom.badRequest(r.message));if(r.url.length>Utils.limits.maxMatchLength)return o(Boom.badRequest("Resource path exceeds max length"));var i=r.url.match(internals.bewitRegex);if(!i)return o(Boom.unauthorized(null,"Hawk"));if(!i[3])return o(Boom.unauthorized("Empty bewit","Hawk"));if("GET"!==r.method&&"HEAD"!==r.method)return o(Boom.unauthorized("Invalid method","Hawk"));if(r.authorization)return o(Boom.badRequest("Multiple authentications"));var s=Hoek.base64urlDecode(i[3]);if(s instanceof Error)return o(Boom.badRequest("Invalid bewit encoding"));var u=s.split("\\");if(4!==u.length)return o(Boom.badRequest("Invalid bewit structure"));var l={id:u[0],exp:parseInt(u[1],10),mac:u[2],ext:u[3]||""};if(!l.id||!l.exp||!l.mac)return o(Boom.badRequest("Missing bewit attributes"));var c=i[1];return i[4]&&(c+=i[2]+i[4]),1e3*l.exp<=n?o(Boom.unauthorized("Access expired","Hawk"),null,l):void t(l.id,function(e,t){if(e)return o(e,t||null,l.ext);if(!t)return o(Boom.unauthorized("Unknown credentials","Hawk"),null,l);if(!t.key||!t.algorithm)return o(Boom.internal("Invalid credentials"),t,l);if(-1===Crypto.algorithms.indexOf(t.algorithm))return o(Boom.internal("Unknown algorithm"),t,l);var a=Crypto.calculateMac("bewit",t,{ts:l.exp,nonce:"",method:"GET",resource:c,host:r.host,port:r.port,ext:l.ext});return Cryptiles.fixedTimeComparison(a,l.mac)?o(null,t,l):o(Boom.unauthorized("Bad mac","Hawk"),t,l)})},exports.authenticateMessage=function(e,t,a,o,n,r,i){i=Hoek.nextTick(i),r.nonceFunc=r.nonceFunc||internals.nonceFunc,r.timestampSkewSec=r.timestampSkewSec||60;var s=Utils.now(r.localtimeOffsetMsec);return o.id&&o.ts&&o.nonce&&o.hash&&o.mac?void n(o.id,function(n,u){if(n)return i(n,u||null);if(!u)return i(Boom.unauthorized("Unknown credentials","Hawk"));if(!u.key||!u.algorithm)return i(Boom.internal("Invalid credentials"),u);if(-1===Crypto.algorithms.indexOf(u.algorithm))return i(Boom.internal("Unknown algorithm"),u);var l={ts:o.ts,nonce:o.nonce,host:e,port:t,hash:o.hash},c=Crypto.calculateMac("message",u,l);if(!Cryptiles.fixedTimeComparison(c,o.mac))return i(Boom.unauthorized("Bad mac","Hawk"),u);var m=Crypto.calculatePayloadHash(a,u.algorithm);return Cryptiles.fixedTimeComparison(m,o.hash)?void r.nonceFunc(u.key,o.nonce,o.ts,function(e){return e?i(Boom.unauthorized("Invalid nonce","Hawk"),u):Math.abs(1e3*o.ts-s)>1e3*r.timestampSkewSec?i(Boom.unauthorized("Stale timestamp"),u):i(null,u)}):i(Boom.unauthorized("Bad message hash","Hawk"),u)}):i(Boom.badRequest("Invalid authorization"))},internals.nonceFunc=function(e,t,a,o){return o()};