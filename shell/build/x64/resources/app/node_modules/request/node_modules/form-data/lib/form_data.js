function FormData(){if(!(this instanceof FormData))throw new TypeError("Failed to construct FormData: Please use the _new_ operator, this object constructor cannot be called as a function.");this._overheadLength=0,this._valueLength=0,this._lengthRetrievers=[],CombinedStream.call(this)}var CombinedStream=require("combined-stream"),util=require("util"),path=require("path"),http=require("http"),https=require("https"),parseUrl=require("url").parse,fs=require("fs"),mime=require("mime-types"),async=require("async"),populate=require("./populate.js");module.exports=FormData,util.inherits(FormData,CombinedStream),FormData.LINE_BREAK="\r\n",FormData.DEFAULT_CONTENT_TYPE="application/octet-stream",FormData.prototype.append=function(t,e,r){r=r||{},"string"==typeof r&&(r={filename:r});var n=CombinedStream.prototype.append.bind(this);if("number"==typeof e&&(e=""+e),util.isArray(e))return void this._error(new Error("Arrays are not supported."));var o=this._multiPartHeader(t,e,r),a=this._multiPartFooter();n(o),n(e),n(a),this._trackLength(o,e,r)},FormData.prototype._trackLength=function(t,e,r){var n=0;null!=r.knownLength?n+=+r.knownLength:Buffer.isBuffer(e)?n=e.length:"string"==typeof e&&(n=Buffer.byteLength(e)),this._valueLength+=n,this._overheadLength+=Buffer.byteLength(t)+FormData.LINE_BREAK.length,e&&(e.path||e.readable&&e.hasOwnProperty("httpVersion"))&&(r.knownLength||this._lengthRetrievers.push(function(t){e.hasOwnProperty("fd")?void 0!=e.end&&1/0!=e.end&&void 0!=e.start?t(null,e.end+1-(e.start?e.start:0)):fs.stat(e.path,function(r,n){var o;return r?void t(r):(o=n.size-(e.start?e.start:0),void t(null,o))}):e.hasOwnProperty("httpVersion")?t(null,+e.headers["content-length"]):e.hasOwnProperty("httpModule")?(e.on("response",function(r){e.pause(),t(null,+r.headers["content-length"])}),e.resume()):t("Unknown stream")}))},FormData.prototype._multiPartHeader=function(t,e,r){if(r.header)return r.header;var n=this._getContentDisposition(e,r),o=this._getContentType(e,r),a="",i={"Content-Disposition":["form-data",'name="'+t+'"'].concat(n||[]),"Content-Type":[].concat(o||[])};for(var s in i)i[s].length&&(a+=s+": "+i[s].join("; ")+FormData.LINE_BREAK);return"--"+this.getBoundary()+FormData.LINE_BREAK+a+FormData.LINE_BREAK},FormData.prototype._getContentDisposition=function(t,e){var r,n=e.filename||t.path;return!n&&t.readable&&t.hasOwnProperty("httpVersion")&&(n=t.client._httpMessage.path),n&&(r='filename="'+path.basename(n)+'"'),r},FormData.prototype._getContentType=function(t,e){var r=e.contentType;return!r&&t.path&&(r=mime.lookup(t.path)),!r&&t.readable&&t.hasOwnProperty("httpVersion")&&(r=t.headers["content-type"]),!r&&e.filename&&(r=mime.lookup(e.filename)),r||"object"!=typeof t||(r=FormData.DEFAULT_CONTENT_TYPE),r},FormData.prototype._multiPartFooter=function(){return function(t){var e=FormData.LINE_BREAK,r=0===this._streams.length;r&&(e+=this._lastBoundary()),t(e)}.bind(this)},FormData.prototype._lastBoundary=function(){return"--"+this.getBoundary()+"--"+FormData.LINE_BREAK},FormData.prototype.getHeaders=function(t){var e,r={"content-type":"multipart/form-data; boundary="+this.getBoundary()};for(e in t)t.hasOwnProperty(e)&&(r[e.toLowerCase()]=t[e]);return r},FormData.prototype.getCustomHeaders=function(t){t=t?t:"multipart/form-data";var e={"content-type":t+"; boundary="+this.getBoundary(),"content-length":this.getLengthSync()};return e},FormData.prototype.getBoundary=function(){return this._boundary||this._generateBoundary(),this._boundary},FormData.prototype._generateBoundary=function(){for(var t="--------------------------",e=0;24>e;e++)t+=Math.floor(10*Math.random()).toString(16);this._boundary=t},FormData.prototype.getLengthSync=function(){var t=this._overheadLength+this._valueLength;return this._streams.length&&(t+=this._lastBoundary().length),this._lengthRetrievers.length&&this._error(new Error("Cannot calculate proper length in synchronous way.")),t},FormData.prototype.getLength=function(t){var e=this._overheadLength+this._valueLength;return this._streams.length&&(e+=this._lastBoundary().length),this._lengthRetrievers.length?void async.parallel(this._lengthRetrievers,function(r,n){return r?void t(r):(n.forEach(function(t){e+=t}),void t(null,e))}):void process.nextTick(t.bind(this,null,e))},FormData.prototype.submit=function(t,e){var r,n,o={method:"post"};return"string"==typeof t?(t=parseUrl(t),n=populate({port:t.port,path:t.pathname,host:t.hostname},o)):(n=populate(t,o),n.port||(n.port="https:"==n.protocol?443:80)),n.headers=this.getHeaders(t.headers),r="https:"==n.protocol?https.request(n):http.request(n),this.getLength(function(t,n){return t?void this._error(t):(r.setHeader("Content-Length",n),this.pipe(r),void(e&&(r.on("error",e),r.on("response",e.bind(this,null)))))}.bind(this)),r},FormData.prototype._error=function(t){this.error||(this.error=t,this.pause(),this.emit("error",t))};