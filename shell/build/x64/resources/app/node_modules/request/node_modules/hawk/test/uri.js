var Http=require("http"),Url=require("url"),Code=require("code"),Hawk=require("../lib"),Hoek=require("hoek"),Lab=require("lab"),internals={},lab=exports.lab=Lab.script(),describe=lab.experiment,it=lab.test,expect=Code.expect;describe("Uri",function(){var e=function(e,t){var a={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"};return t(null,a)};it("should generate a bewit then successfully authenticate it",function(t){var a={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(o,i){var s=Hawk.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:i,ttlSec:31536e5,ext:"some-app-data"});a.url+="&bewit="+s,Hawk.uri.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),t()})})}),it("should generate a bewit then successfully authenticate it (no ext)",function(t){var a={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(o,i){var s=Hawk.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:i,ttlSec:31536e5});a.url+="&bewit="+s,Hawk.uri.authenticate(a,e,{},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})})}),it("should successfully authenticate a request (last param)",function(t){var a={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),t()})}),it("should successfully authenticate a request (first param)",function(t){var a={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ&a=1&b=2",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),t()})}),it("should successfully authenticate a request (only param)",function(t){var a={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),t()})}),it("should fail on multiple authentication",function(t){var a={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Multiple authentications"),t()})}),it("should fail on method other than GET",function(t){e("123456",function(a,o){var i={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080},s=Math.floor(Hawk.utils.now()/1e3)+60,c="some-app-data",n=Hawk.crypto.calculateMac("bewit",o,{timestamp:s,nonce:"",method:i.method,resource:i.url,host:i.host,port:i.port,ext:c}),r=o.id+"\\"+s+"\\"+n+"\\"+c;i.url+="&bewit="+Hoek.base64urlEncode(r),Hawk.uri.authenticate(i,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid method"),t()})})}),it("should fail on invalid host header",function(t){var a={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",headers:{host:"example.com:something"}};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid Host header"),t()})}),it("should fail on empty bewit",function(t){var a={method:"GET",url:"/resource/4?bewit=",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Empty bewit"),expect(e.isMissing).to.not.exist(),t()})}),it("should fail on invalid bewit",function(t){var a={method:"GET",url:"/resource/4?bewit=*",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid bewit encoding"),expect(e.isMissing).to.not.exist(),t()})}),it("should fail on missing bewit",function(t){var a={method:"GET",url:"/resource/4",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.not.exist(),expect(e.isMissing).to.equal(!0),t()})}),it("should fail on invalid bewit structure",function(t){var a={method:"GET",url:"/resource/4?bewit=abc",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Invalid bewit structure"),t()})}),it("should fail on empty bewit attribute",function(t){var a={method:"GET",url:"/resource/4?bewit=YVxcY1xk",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Missing bewit attributes"),t()})}),it("should fail on missing bewit id attribute",function(t){var a={method:"GET",url:"/resource/4?bewit=XDQ1NTIxNDc2MjJcK0JFbFhQMXhuWjcvd1Nrbm1ldGhlZm5vUTNHVjZNSlFVRHk4NWpTZVJ4VT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Missing bewit attributes"),t()})}),it("should fail on expired access",function(t){var a={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDEzNTY0MTg1ODNcWk1wZlMwWU5KNHV0WHpOMmRucTRydEk3NXNXTjFjeWVITTcrL0tNZFdVQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(a,e,{},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Access expired"),t()})}),it("should fail on credentials function error",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(Hawk.error.badRequest("Boom"))},{},function(t){expect(t).to.exist(),expect(t.output.payload.message).to.equal("Boom"),e()})}),it("should fail on credentials function error with credentials",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(Hawk.error.badRequest("Boom"),{some:"value"})},{},function(t,a){expect(t).to.exist(),expect(t.output.payload.message).to.equal("Boom"),expect(a.some).to.equal("value"),e()})}),it("should fail on null credentials function response",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(null,null)},{},function(t){expect(t).to.exist(),expect(t.output.payload.message).to.equal("Unknown credentials"),e()})}),it("should fail on invalid credentials function response",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(null,{})},{},function(t){expect(t).to.exist(),expect(t.message).to.equal("Invalid credentials"),e()})}),it("should fail on invalid credentials function response (unknown algorithm)",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(null,{key:"xxx",algorithm:"xxx"})},{},function(t){expect(t).to.exist(),expect(t.message).to.equal("Unknown algorithm"),e()})}),it("should fail on expired access",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(null,{key:"xxx",algorithm:"sha256"})},{},function(t){expect(t).to.exist(),expect(t.output.payload.message).to.equal("Bad mac"),e()})}),describe("getBewit()",function(){it("returns a valid bewit value",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal("MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6"),e()}),it("returns a valid bewit value (explicit port)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Hawk.uri.getBewit("https://example.com:8080/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal("MTIzNDU2XDEzNTY0MjA3MDdcaFpiSjNQMmNLRW80a3kwQzhqa1pBa1J5Q1p1ZWc0V1NOYnhWN3ZxM3hIVT1ceGFuZHlhbmR6"),e()}),it("returns a valid bewit value (null ext)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:null});expect(a).to.equal("MTIzNDU2XDEzNTY0MjA3MDdcSUdZbUxnSXFMckNlOEN4dktQczRKbFdJQStValdKSm91d2dBUmlWaENBZz1c"),e()}),it("returns a valid bewit value (parsed uri)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Hawk.uri.getBewit(Url.parse("https://example.com/somewhere/over/the/rainbow"),{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal("MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6"),e()}),it("errors on invalid options",function(e){var t=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",4);expect(t).to.equal(""),e()}),it("errors on missing uri",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Hawk.uri.getBewit("",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on invalid uri",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Hawk.uri.getBewit(5,{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on invalid credentials (id)",function(e){var t={key:"2983d45yun89q",algorithm:"sha256"},a=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:3e3,ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on missing credentials",function(e){var t=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{ttlSec:3e3,ext:"xandyandz"});expect(t).to.equal(""),e()}),it("errors on invalid credentials (key)",function(e){var t={id:"123456",algorithm:"sha256"},a=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:3e3,ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on invalid algorithm",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"},a=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on missing options",function(e){var t=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow");expect(t).to.equal(""),e()})}),describe("authenticateMessage()",function(){it("should generate an authorization then successfully parse it",function(t){e("123456",function(a,o){var i=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(i).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})})}),it("should fail authorization on mismatching host",function(t){e("123456",function(a,o){var i=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(i).to.exist(),Hawk.server.authenticateMessage("example1.com",8080,"some message",i,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Bad mac"),t()})})}),it("should fail authorization on stale timestamp",function(t){e("123456",function(a,o){var i=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(i).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{localtimeOffsetMsec:1e5},function(e){expect(e).to.exist(),expect(e.message).to.equal("Stale timestamp"),t()})})}),it("overrides timestampSkewSec",function(t){e("123456",function(a,o){var i=Hawk.client.message("example.com",8080,"some message",{credentials:o,localtimeOffsetMsec:1e5});expect(i).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{timestampSkewSec:500},function(e){expect(e).to.not.exist(),t()})})}),it("should fail authorization on invalid authorization",function(t){e("123456",function(a,o){var i=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(i).to.exist(),delete i.id,Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid authorization"),t()})})}),it("should fail authorization on bad hash",function(t){e("123456",function(a,o){var i=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(i).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message1",i,e,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Bad message hash"),t()})})}),it("should fail authorization on nonce error",function(t){e("123456",function(a,o){var i=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(i).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{nonceFunc:function(e,t,a,o){o(new Error("kaboom"))}},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid nonce"),t()})})}),it("should fail authorization on credentials error",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});expect(o).to.exist();var i=function(e,t){t(new Error("kablooey"))};Hawk.server.authenticateMessage("example.com",8080,"some message",o,i,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("kablooey"),t()})})}),it("should fail authorization on missing credentials",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});expect(o).to.exist();var i=function(e,t){t()};Hawk.server.authenticateMessage("example.com",8080,"some message",o,i,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Unknown credentials"),t()})})}),it("should fail authorization on invalid credentials",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});expect(o).to.exist();var i=function(e,t){t(null,{})};Hawk.server.authenticateMessage("example.com",8080,"some message",o,i,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Invalid credentials"),t()})})}),it("should fail authorization on invalid credentials algorithm",function(t){e("123456",function(e,a){var o=Hawk.client.message("example.com",8080,"some message",{credentials:a});expect(o).to.exist();var i=function(e,t){t(null,{key:"123",algorithm:"456"})};Hawk.server.authenticateMessage("example.com",8080,"some message",o,i,{},function(e){expect(e).to.exist(),expect(e.message).to.equal("Unknown algorithm"),t()})})}),it("should fail on missing host",function(t){e("123456",function(e,a){var o=Hawk.client.message(null,8080,"some message",{credentials:a});expect(o).to.not.exist(),t()})}),it("should fail on missing credentials",function(e){var t=Hawk.client.message("example.com",8080,"some message",{});expect(t).to.not.exist(),e()}),it("should fail on invalid algorithm",function(t){e("123456",function(e,a){var o=Hoek.clone(a);o.algorithm="blah";var i=Hawk.client.message("example.com",8080,"some message",{credentials:o});expect(i).to.not.exist(),t()})})})});