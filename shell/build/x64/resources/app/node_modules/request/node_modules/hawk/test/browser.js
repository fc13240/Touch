var Url=require("url"),Code=require("code"),Hawk=require("../lib"),Hoek=require("hoek"),Lab=require("lab"),Browser=require("../lib/browser"),internals={},lab=exports.lab=Lab.script(),describe=lab.experiment,it=lab.test,expect=Code.expect;describe("Browser",function(){var e=function(e,t){var a={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"};return t(null,a)};it("should generate a bewit then successfully authenticate it",function(t){var a={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(r,o){var n=Browser.client.bewit("http://example.com/resource/4?a=1&b=2",{credentials:o,ttlSec:31536e5,ext:"some-app-data"});a.url+="&bewit="+n,Hawk.uri.authenticate(a,e,{},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),t()})})}),it("should generate a bewit then successfully authenticate it (no ext)",function(t){var a={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(r,o){var n=Browser.client.bewit("http://example.com/resource/4?a=1&b=2",{credentials:o,ttlSec:31536e5});a.url+="&bewit="+n,Hawk.uri.authenticate(a,e,{},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})})}),describe("bewit()",function(){it("returns a valid bewit value",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.bewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal("MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6"),e()}),it("returns a valid bewit value (explicit HTTP port)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.bewit("http://example.com:8080/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal("MTIzNDU2XDEzNTY0MjA3MDdcaFpiSjNQMmNLRW80a3kwQzhqa1pBa1J5Q1p1ZWc0V1NOYnhWN3ZxM3hIVT1ceGFuZHlhbmR6"),e()}),it("returns a valid bewit value (explicit HTTPS port)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.bewit("https://example.com:8043/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal("MTIzNDU2XDEzNTY0MjA3MDdcL2t4UjhwK0xSaTdvQTRnUXc3cWlxa3BiVHRKYkR4OEtRMC9HRUwvVytTUT1ceGFuZHlhbmR6"),e()}),it("returns a valid bewit value (null ext)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.bewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:null});expect(a).to.equal("MTIzNDU2XDEzNTY0MjA3MDdcSUdZbUxnSXFMckNlOEN4dktQczRKbFdJQStValdKSm91d2dBUmlWaENBZz1c"),e()}),it("errors on invalid options",function(e){var t=Browser.client.bewit("https://example.com/somewhere/over/the/rainbow",4);expect(t).to.equal(""),e()}),it("errors on missing uri",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.bewit("",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on invalid uri",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.bewit(5,{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on invalid credentials (id)",function(e){var t={key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.bewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:3e3,ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on missing credentials",function(e){var t=Browser.client.bewit("https://example.com/somewhere/over/the/rainbow",{ttlSec:3e3,ext:"xandyandz"});expect(t).to.equal(""),e()}),it("errors on invalid credentials (key)",function(e){var t={id:"123456",algorithm:"sha256"},a=Browser.client.bewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:3e3,ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on invalid algorithm",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"},a=Browser.client.bewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,ext:"xandyandz"});expect(a).to.equal(""),e()}),it("errors on missing options",function(e){var t=Browser.client.bewit("https://example.com/somewhere/over/the/rainbow");expect(t).to.equal(""),e()})}),it("generates a header then successfully parse it (configuration)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data"}).field,expect(a.authorization).to.exist(),Hawk.server.authenticate(a,e,{},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),t()})})}),it("generates a header then successfully parse it (node request)",function(t){var a={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(o,n){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:n,ext:"some-app-data",payload:r,contentType:a.headers["content-type"]});a.headers.authorization=s.field,Hawk.server.authenticate(a,e,{},function(e,o,n){expect(e).to.not.exist(),expect(o.user).to.equal("steve"),expect(n.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,o,n,a.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};s.headers["server-authorization"]=Hawk.server.header(o,n,{payload:"some reply",contentType:"text/plain",ext:"response-specific"}),expect(s.headers["server-authorization"]).to.exist(),expect(Browser.client.authenticate(s,o,n,{payload:"some reply"})).to.equal(!0),t()})})}),it("generates a header then successfully parse it (browserify)",function(t){var a={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(o,n){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:n,ext:"some-app-data",payload:r,contentType:a.headers["content-type"]});a.headers.authorization=s.field,Hawk.server.authenticate(a,e,{},function(e,o,n){expect(e).to.not.exist(),expect(o.user).to.equal("steve"),expect(n.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,o,n,a.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getHeader:function(e){return s.headers[e.toLowerCase()]}};s.headers["server-authorization"]=Hawk.server.header(o,n,{payload:"some reply",contentType:"text/plain",ext:"response-specific"}),expect(s.headers["server-authorization"]).to.exist(),expect(Browser.client.authenticate(s,o,n,{payload:"some reply"})).to.equal(!0),t()})})}),it("generates a header then successfully parse it (time offset)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data",localtimeOffsetMsec:1e5}).field,expect(a.authorization).to.exist(),Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1e5},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),t()})})}),it("generates a header then successfully parse it (no server header options)",function(t){var a={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(o,n){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:n,ext:"some-app-data",payload:r,contentType:a.headers["content-type"]});a.headers.authorization=s.field,Hawk.server.authenticate(a,e,{},function(e,o,n){expect(e).to.not.exist(),expect(o.user).to.equal("steve"),expect(n.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,o,n,a.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};s.headers["server-authorization"]=Hawk.server.header(o,n),expect(s.headers["server-authorization"]).to.exist(),expect(Browser.client.authenticate(s,o,n)).to.equal(!0),t()})})}),it("generates a header then successfully parse it (no server header)",function(t){var a={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(o,n){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:n,ext:"some-app-data",payload:r,contentType:a.headers["content-type"]});a.headers.authorization=s.field,Hawk.server.authenticate(a,e,{},function(e,o,n){expect(e).to.not.exist(),expect(o.user).to.equal("steve"),expect(n.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,o,n,a.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};expect(Browser.client.authenticate(s,o,n)).to.equal(!0),t()})})}),it("generates a header with stale ts and successfully authenticate on second call",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){Browser.utils.setNtpOffset(36e5);var n=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data"});a.authorization=n.field,expect(a.authorization).to.exist(),Hawk.server.authenticate(a,e,{},function(r,o){expect(r).to.exist(),expect(r.message).to.equal("Stale timestamp");var s={headers:{"www-authenticate":r.output.headers["WWW-Authenticate"]},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};expect(Browser.utils.getNtpOffset()).to.equal(36e5),expect(Browser.client.authenticate(s,o,n.artifacts)).to.equal(!0),expect(Browser.utils.getNtpOffset()).to.equal(0),a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data"}).field,expect(a.authorization).to.exist(),Hawk.server.authenticate(a,e,{},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),t()})})})}),it("generates a header with stale ts and successfully authenticate on second call (manual localStorage)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){var n=new Browser.internals.LocalStorage;Browser.utils.setStorage(n),Browser.utils.setNtpOffset(36e5);var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data"});a.authorization=s.field,expect(a.authorization).to.exist(),Hawk.server.authenticate(a,e,{},function(r,o){expect(r).to.exist(),expect(r.message).to.equal("Stale timestamp");var i={headers:{"www-authenticate":r.output.headers["WWW-Authenticate"]},getResponseHeader:function(e){return i.headers[e.toLowerCase()]}};expect(parseInt(n.getItem("hawk_ntp_offset"))).to.equal(36e5),expect(Browser.utils.getNtpOffset()).to.equal(36e5),expect(Browser.client.authenticate(i,o,s.artifacts)).to.equal(!0),expect(Browser.utils.getNtpOffset()).to.equal(0),expect(parseInt(n.getItem("hawk_ntp_offset"))).to.equal(0),a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data"}).field,expect(a.authorization).to.exist(),Hawk.server.authenticate(a,e,{},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),t()})})})}),it("generates a header then fails to parse it (missing server header hash)",function(t){var a={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(o,n){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:n,ext:"some-app-data",payload:r,contentType:a.headers["content-type"]});a.headers.authorization=s.field,Hawk.server.authenticate(a,e,{},function(e,o,n){expect(e).to.not.exist(),expect(o.user).to.equal("steve"),expect(n.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,o,n,a.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};s.headers["server-authorization"]=Hawk.server.header(o,n),expect(s.headers["server-authorization"]).to.exist(),expect(Browser.client.authenticate(s,o,n,{payload:"some reply"})).to.equal(!1),t()})})}),it("generates a header then successfully parse it (with hash)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(a,e,{},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),t()})})}),it("generates a header then successfully parse it then validate payload",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(a,e,{},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload("hola!",a,r)).to.be.true(),expect(Hawk.server.authenticatePayload("hello!",a,r)).to.be.false(),t()})})}),it("generates a header then successfully parse it (app)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data",app:"asd23ased"}).field,Hawk.server.authenticate(a,e,{},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),expect(r.app).to.equal("asd23ased"),t()})})}),it("generates a header then successfully parse it (app, dlg)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data",app:"asd23ased",dlg:"23434szr3q4d"}).field,Hawk.server.authenticate(a,e,{},function(e,a,r){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),expect(r.app).to.equal("asd23ased"),expect(r.dlg).to.equal("23434szr3q4d"),t()})})}),it("generates a header then fail authentication due to bad hash",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(a,e,{payload:"byebye!"},function(e){expect(e).to.exist(),expect(e.output.payload.message).to.equal("Bad payload hash"),t()})})}),it("generates a header for one resource then fail to authenticate another",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,o){a.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:o,ext:"some-app-data"}).field,a.url="/something/else",Hawk.server.authenticate(a,e,{},function(e,a){expect(e).to.exist(),expect(a).to.exist(),t()})})}),describe("client",function(){describe("header()",function(){it("returns a valid authorization header (sha1)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha1"},a=Browser.client.header("http://example.net/somewhere/over/the/rainbow","POST",{credentials:t,ext:"Bazinga!",timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about"}).field;expect(a).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="bsvY3IfUllw6V5rvk4tStEvpBhE=", ext="Bazinga!", mac="qbf1ZPG/r/e06F4ht+T77LXi5vw="'),e()}),it("returns a valid authorization header (sha256)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:t,ext:"Bazinga!",timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"}).field;expect(a).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", ext="Bazinga!", mac="q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8="'),e()}),it("returns a valid authorization header (empty payload)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha1"},a=Browser.client.header("http://example.net/somewhere/over/the/rainbow","POST",{credentials:t,ext:"Bazinga!",timestamp:1353809207,nonce:"Ygvqdz",payload:""}).field;expect(a).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="404ghL7K+hfyhByKKejFBRGgTjU=", ext="Bazinga!", mac="Bh1sj1DOfFRWOdi3ww52nLCJdBE="'),e()}),it("returns a valid authorization header (no ext)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:t,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"}).field;expect(a).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="'),e()}),it("returns a valid authorization header (null ext)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:t,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain",ext:null}).field;expect(a).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="'),e()}),it("returns a valid authorization header (uri object)",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.utils.parseUri("https://example.net/somewhere/over/the/rainbow"),r=Browser.client.header(a,"POST",{credentials:t,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"}).field;expect(r).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="'),e()}),it("errors on missing options",function(e){var t=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST");expect(t.field).to.equal(""),expect(t.err).to.equal("Invalid argument type"),e()}),it("errors on empty uri",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.header("","POST",{credentials:t,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"});expect(a.field).to.equal(""),expect(a.err).to.equal("Invalid argument type"),e()}),it("errors on invalid uri",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.header(4,"POST",{credentials:t,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"});expect(a.field).to.equal(""),expect(a.err).to.equal("Invalid argument type"),e()}),it("errors on missing method",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.header("https://example.net/somewhere/over/the/rainbow","",{credentials:t,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"});expect(a.field).to.equal(""),expect(a.err).to.equal("Invalid argument type"),e()}),it("errors on invalid method",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.header("https://example.net/somewhere/over/the/rainbow",5,{credentials:t,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"});expect(a.field).to.equal(""),expect(a.err).to.equal("Invalid argument type"),e()}),it("errors on missing credentials",function(e){var t=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{ext:"Bazinga!",timestamp:1353809207});expect(t.field).to.equal(""),expect(t.err).to.equal("Invalid credentials object"),e()}),it("errors on invalid credentials (id)",function(e){var t={key:"2983d45yun89q",algorithm:"sha256"},a=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:t,ext:"Bazinga!",timestamp:1353809207});expect(a.field).to.equal(""),expect(a.err).to.equal("Invalid credentials object"),e()}),it("errors on invalid credentials (key)",function(e){var t={id:"123456",algorithm:"sha256"},a=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:t,ext:"Bazinga!",timestamp:1353809207});expect(a.field).to.equal(""),expect(a.err).to.equal("Invalid credentials object"),e()}),it("errors on invalid algorithm",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"},a=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:t,payload:"something, anything!",ext:"Bazinga!",timestamp:1353809207});expect(a.field).to.equal(""),expect(a.err).to.equal("Unknown algorithm"),e()}),it("uses a pre-calculated payload hash",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},a={credentials:t,ext:"Bazinga!",timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"};a.hash=Browser.crypto.calculatePayloadHash(a.payload,t.algorithm,a.contentType);var r=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",a).field;expect(r).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", ext="Bazinga!", mac="q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8="'),e()})}),describe("authenticate()",function(){it("skips tsm validation when missing ts",function(e){var t={headers:{"www-authenticate":'Hawk error="Stale timestamp"'},getResponseHeader:function(e){return t.headers[e.toLowerCase()]}},a={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},r={ts:1402135580,nonce:"iBRB6t",method:"GET",resource:"/resource/4?filter=a",host:"example.com",port:"8080",ext:"some-app-data"};expect(Browser.client.authenticate(t,a,r)).to.equal(!0),e()}),it("returns false on invalid header",function(e){var t={headers:{"server-authorization":'Hawk mac="abc", bad="xyz"'},getResponseHeader:function(e){return t.headers[e.toLowerCase()]}};expect(Browser.client.authenticate(t,{})).to.equal(!1),e()}),it("returns false on invalid mac",function(e){var t={headers:{"content-type":"text/plain","server-authorization":'Hawk mac="_IJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'},getResponseHeader:function(e){return t.headers[e.toLowerCase()]}},a={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1362336900",nonce:"eb5S_L",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",app:void 0,dlg:void 0,mac:"BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=",id:"123456"},r={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};expect(Browser.client.authenticate(t,r,a)).to.equal(!1),e()}),it("returns true on ignoring hash",function(e){var t={headers:{"content-type":"text/plain","server-authorization":'Hawk mac="XIJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'},getResponseHeader:function(e){return t.headers[e.toLowerCase()]}},a={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1362336900",nonce:"eb5S_L",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",app:void 0,dlg:void 0,mac:"BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=",id:"123456"},r={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};expect(Browser.client.authenticate(t,r,a)).to.equal(!0),e()}),it("errors on invalid WWW-Authenticate header format",function(e){var t={headers:{"www-authenticate":'Hawk ts="1362346425875", tsm="PhwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", x="Stale timestamp"'},getResponseHeader:function(e){return t.headers[e.toLowerCase()]}};expect(Browser.client.authenticate(t,{})).to.equal(!1),e()}),it("errors on invalid WWW-Authenticate header format",function(e){var t={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},a={headers:{"www-authenticate":'Hawk ts="1362346425875", tsm="hwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", error="Stale timestamp"'},getResponseHeader:function(e){return a.headers[e.toLowerCase()]}};expect(Browser.client.authenticate(a,t)).to.equal(!1),e()})}),describe("message()",function(){it("generates an authorization then successfully parse it",function(t){e("123456",function(a,r){var o=Browser.client.message("example.com",8080,"some message",{credentials:r});expect(o).to.exist(),Hawk.server.authenticateMessage("example.com",8080,"some message",o,e,{},function(e,a){expect(e).to.not.exist(),expect(a.user).to.equal("steve"),t()})})}),it("generates an authorization using custom nonce/timestamp",function(t){e("123456",function(e,a){var r=Browser.client.message("example.com",8080,"some message",{credentials:a,nonce:"abc123",timestamp:1398536270957});expect(r).to.exist(),expect(r.nonce).to.equal("abc123"),expect(r.ts).to.equal(1398536270957),t()})}),it("errors on missing host",function(t){e("123456",function(e,a){var r=Browser.client.message(null,8080,"some message",{credentials:a});expect(r).to.not.exist(),t()})}),it("errors on invalid host",function(t){e("123456",function(e,a){var r=Browser.client.message(5,8080,"some message",{credentials:a});expect(r).to.not.exist(),t()})}),it("errors on missing port",function(t){e("123456",function(e,a){var r=Browser.client.message("example.com",0,"some message",{credentials:a});expect(r).to.not.exist(),t()})}),it("errors on invalid port",function(t){e("123456",function(e,a){var r=Browser.client.message("example.com","a","some message",{credentials:a});expect(r).to.not.exist(),t()})}),it("errors on missing message",function(t){e("123456",function(e,a){var r=Browser.client.message("example.com",8080,void 0,{credentials:a});expect(r).to.not.exist(),t()})}),it("errors on null message",function(t){e("123456",function(e,a){var r=Browser.client.message("example.com",8080,null,{credentials:a});expect(r).to.not.exist(),t()})}),it("errors on invalid message",function(t){e("123456",function(e,a){var r=Browser.client.message("example.com",8080,5,{credentials:a});expect(r).to.not.exist(),t()})}),it("errors on missing credentials",function(e){var t=Browser.client.message("example.com",8080,"some message",{});expect(t).to.not.exist(),e()}),it("errors on missing options",function(e){var t=Browser.client.message("example.com",8080,"some message");expect(t).to.not.exist(),e()}),it("errors on invalid credentials (id)",function(t){e("123456",function(e,a){var r=Hoek.clone(a);delete r.id;var o=Browser.client.message("example.com",8080,"some message",{credentials:r});expect(o).to.not.exist(),t()})}),it("errors on invalid credentials (key)",function(t){e("123456",function(e,a){var r=Hoek.clone(a);delete r.key;var o=Browser.client.message("example.com",8080,"some message",{credentials:r});expect(o).to.not.exist(),t()})}),it("errors on invalid algorithm",function(t){e("123456",function(e,a){var r=Hoek.clone(a);r.algorithm="blah";var o=Browser.client.message("example.com",8080,"some message",{credentials:r});expect(o).to.not.exist(),t()})})}),describe("authenticateTimestamp()",function(){it("validates a timestamp",function(t){e("123456",function(e,a){var r=Hawk.crypto.timestampMessage(a);expect(Browser.client.authenticateTimestamp(r,a)).to.equal(!0),t()})}),it("validates a timestamp without updating local time",function(t){e("123456",function(e,a){var r=Browser.utils.getNtpOffset(),o=Hawk.crypto.timestampMessage(a,1e4);expect(Browser.client.authenticateTimestamp(o,a,!1)).to.equal(!0),expect(r).to.equal(Browser.utils.getNtpOffset()),t()})}),it("detects a bad timestamp",function(t){e("123456",function(e,a){var r=Hawk.crypto.timestampMessage(a);r.ts=4,expect(Browser.client.authenticateTimestamp(r,a)).to.equal(!1),t()})})})}),describe("internals",function(){describe("LocalStorage",function(){it("goes through the full lifecycle",function(e){var t=new Browser.internals.LocalStorage;expect(t.length).to.equal(0),expect(t.getItem("a")).to.equal(null),t.setItem("a",5),expect(t.length).to.equal(1),expect(t.key()).to.equal("a"),expect(t.key(0)).to.equal("a"),expect(t.getItem("a")).to.equal("5"),t.setItem("b","test"),expect(t.key()).to.equal("a"),expect(t.key(0)).to.equal("a"),expect(t.key(1)).to.equal("b"),expect(t.length).to.equal(2),expect(t.getItem("b")).to.equal("test"),t.removeItem("a"),expect(t.length).to.equal(1),expect(t.getItem("a")).to.equal(null),expect(t.getItem("b")).to.equal("test"),t.clear(),expect(t.length).to.equal(0),expect(t.getItem("a")).to.equal(null),expect(t.getItem("b")).to.equal(null),e()})})}),describe("utils",function(){describe("setStorage()",function(){it("sets storage for the first time",function(e){Browser.utils.storage=new Browser.internals.LocalStorage,expect(Browser.utils.storage.getItem("hawk_ntp_offset")).to.not.exist(),Browser.utils.storage.setItem("test","1"),Browser.utils.setStorage(new Browser.internals.LocalStorage),expect(Browser.utils.storage.getItem("test")).to.not.exist(),Browser.utils.storage.setItem("test","2"),expect(Browser.utils.storage.getItem("test")).to.equal("2"),e()})}),describe("setNtpOffset()",function(){it("catches localStorage errors",{parallel:!1},function(e){var t=Browser.utils.storage.setItem,a=console.error,r=0;console.error=function(){2===r++&&(console.error=a)},Browser.utils.storage.setItem=function(){throw Browser.utils.storage.setItem=t,new Error},expect(function(){Browser.utils.setNtpOffset(100)}).not.to.throw(),e()})}),describe("parseAuthorizationHeader()",function(){it("returns null on missing header",function(e){expect(Browser.utils.parseAuthorizationHeader()).to.equal(null),e()}),it("returns null on bad header syntax (structure)",function(e){expect(Browser.utils.parseAuthorizationHeader("Hawk")).to.equal(null),e()}),it("returns null on bad header syntax (parts)",function(e){expect(Browser.utils.parseAuthorizationHeader(" ")).to.equal(null),e()}),it("returns null on bad scheme name",function(e){expect(Browser.utils.parseAuthorizationHeader("Basic asdasd")).to.equal(null),e()}),it("returns null on bad attribute value",function(e){expect(Browser.utils.parseAuthorizationHeader('Hawk test="	"',["test"])).to.equal(null),e()}),it("returns null on duplicated attribute",function(e){expect(Browser.utils.parseAuthorizationHeader('Hawk test="a", test="b"',["test"])).to.equal(null),e()})}),describe("parseUri()",function(){it("returns empty object on invalid",function(e){var t=Browser.utils.parseUri("ftp");
expect(t).to.deep.equal({host:"",port:"",resource:""}),e()}),it("returns empty port when unknown scheme",function(e){var t=Browser.utils.parseUri("ftp://example.com");expect(t.port).to.equal(""),e()}),it("returns default port when missing",function(e){var t=Browser.utils.parseUri("http://example.com");expect(t.port).to.equal("80"),e()}),it("handles unusual characters correctly",function(e){var t={protocol:"http+vnd.my-extension",user:"user!$&'()*+,;=%40my-domain.com",password:"pass!$&'()*+,;=%40:word",hostname:"foo-bar.com",port:"99",pathname:"/path/%40/!$&'()*+,;=:@/",query:"query%40/!$&'()*+,;=:@/?",fragment:"fragm%40/!$&'()*+,;=:@/?"};t.userInfo=t.user+":"+t.password,t.authority=t.userInfo+"@"+t.hostname+":"+t.port,t.relative=t.pathname+"?"+t.query,t.resource=t.relative+"#"+t.fragment,t.source=t.protocol+"://"+t.authority+t.resource;var a=Browser.utils.parseUri(t.source);expect(a.host).to.equal("foo-bar.com"),expect(a.port).to.equal("99"),expect(a.resource).to.equal(t.pathname+"?"+t.query),e()})});var e="https://www.google.ca/webhp?sourceid=chrome-instant&ion=1&espv=2&ie=UTF-8#q=url",t="aHR0cHM6Ly93d3cuZ29vZ2xlLmNhL3dlYmhwP3NvdXJjZWlkPWNocm9tZS1pbnN0YW50Jmlvbj0xJmVzcHY9MiZpZT1VVEYtOCNxPXVybA";describe("base64urlEncode()",function(){it("should base64 URL-safe decode a string",function(a){expect(Browser.utils.base64urlEncode(e)).to.equal(t),a()})})})});