function hmac(e,t,s){return crypto.createHmac("sha256",e).update(t,"utf8").digest(s)}function hash(e,t){return crypto.createHash("sha256").update(e,"utf8").digest(t)}function encodeRfc3986(e){return e.replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}function RequestSigner(e,t){"string"==typeof e&&(e=url.parse(e));var s=e.headers=e.headers||{},r=this.matchHost(e.hostname||e.host||s.Host||s.host);this.request=e,this.credentials=t||this.defaultCredentials(),this.service=e.service||r[0]||"",this.region=e.region||r[1]||"us-east-1","email"===this.service&&(this.service="ses"),!e.method&&e.body&&(e.method="POST"),s.Host||s.host||(s.Host=e.hostname||e.host||this.createHost(),e.port&&(s.Host+=":"+e.port)),e.hostname||e.host||(e.hostname=s.Host||s.host)}var aws4=exports,url=require("url"),querystring=require("querystring"),crypto=require("crypto"),lru=require("lru-cache"),credentialsCache=lru(1e3);RequestSigner.prototype.matchHost=function(e){var t=(e||"").match(/([^\.]+)\.(?:([^\.]*)\.)?amazonaws\.com$/),s=(t||[]).slice(1,3);return"es"===s[1]&&(s=s.reverse()),s},RequestSigner.prototype.isSingleRegion=function(){return["s3","sdb"].indexOf(this.service)>=0&&"us-east-1"===this.region?!0:["cloudfront","ls","route53","iam","importexport","sts"].indexOf(this.service)>=0},RequestSigner.prototype.createHost=function(){var e=this.isSingleRegion()?"":("s3"===this.service&&"us-east-1"!==this.region?"-":".")+this.region,t="ses"===this.service?"email":this.service;return t+e+".amazonaws.com"},RequestSigner.prototype.prepareRequest=function(){this.parsePath();var e,t=this.request,s=t.headers;t.signQuery?(this.parsedPath.query=e=this.parsedPath.query||{},this.credentials.sessionToken&&(e["X-Amz-Security-Token"]=this.credentials.sessionToken),"s3"!==this.service||e["X-Amz-Expires"]||(e["X-Amz-Expires"]=86400),e["X-Amz-Date"]?this.datetime=e["X-Amz-Date"]:e["X-Amz-Date"]=this.getDateTime(),e["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",e["X-Amz-Credential"]=this.credentials.accessKeyId+"/"+this.credentialString(),e["X-Amz-SignedHeaders"]=this.signedHeaders()):(t.doNotModifyHeaders||(!t.body||s["Content-Type"]||s["content-type"]||(s["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8"),!t.body||s["Content-Length"]||s["content-length"]||(s["Content-Length"]=Buffer.byteLength(t.body)),this.credentials.sessionToken&&(s["X-Amz-Security-Token"]=this.credentials.sessionToken),"s3"===this.service&&(s["X-Amz-Content-Sha256"]=hash(this.request.body||"","hex")),s["X-Amz-Date"]?this.datetime=s["X-Amz-Date"]:s["X-Amz-Date"]=this.getDateTime()),delete s.Authorization,delete s.authorization)},RequestSigner.prototype.sign=function(){return this.parsedPath||this.prepareRequest(),this.request.signQuery?this.parsedPath.query["X-Amz-Signature"]=this.signature():this.request.headers.Authorization=this.authHeader(),this.request.path=this.formatPath(),this.request},RequestSigner.prototype.getDateTime=function(){if(!this.datetime){var e=this.request.headers,t=new Date(e.Date||e.date||new Date);this.datetime=t.toISOString().replace(/[:\-]|\.\d{3}/g,"")}return this.datetime},RequestSigner.prototype.getDate=function(){return this.getDateTime().substr(0,8)},RequestSigner.prototype.authHeader=function(){return["AWS4-HMAC-SHA256 Credential="+this.credentials.accessKeyId+"/"+this.credentialString(),"SignedHeaders="+this.signedHeaders(),"Signature="+this.signature()].join(", ")},RequestSigner.prototype.signature=function(){var e,t,s,r=this.getDate(),i=[this.credentials.secretAccessKey,r,this.region,this.service].join(),n=credentialsCache.get(i);return n||(e=hmac("AWS4"+this.credentials.secretAccessKey,r),t=hmac(e,this.region),s=hmac(t,this.service),n=hmac(s,"aws4_request"),credentialsCache.set(i,n)),hmac(n,this.stringToSign(),"hex")},RequestSigner.prototype.stringToSign=function(){return["AWS4-HMAC-SHA256",this.getDateTime(),this.credentialString(),hash(this.canonicalString(),"hex")].join("\n")},RequestSigner.prototype.canonicalString=function(){this.parsedPath||this.prepareRequest();var e=this.parsedPath.path,t=this.parsedPath.query,s="",r="s3"!==this.service,i="s3"===this.service||this.request.doNotEncodePath,n="s3"===this.service,a="s3"===this.service,o="s3"===this.service&&this.request.signQuery?"UNSIGNED-PAYLOAD":hash(this.request.body||"","hex");return t&&(s=encodeRfc3986(querystring.stringify(Object.keys(t).sort().reduce(function(e,s){return s?(e[s]=Array.isArray(t[s])?a?t[s][0]:t[s].slice().sort():t[s],e):e},{})))),"/"!==e&&(r&&(e=e.replace(/\/{2,}/g,"/")),e=e.split("/").reduce(function(e,t){return r&&".."===t?e.pop():r&&"."===t||(i&&(t=querystring.unescape(t)),e.push(encodeRfc3986(querystring.escape(t)))),e},[]).join("/"),"/"!==e[0]&&(e="/"+e),n&&(e=e.replace(/%2F/g,"/"))),[this.request.method||"GET",e,s,this.canonicalHeaders()+"\n",this.signedHeaders(),o].join("\n")},RequestSigner.prototype.canonicalHeaders=function(){function e(e){return e.toString().trim().replace(/\s+/g," ")}var t=this.request.headers;return Object.keys(t).sort(function(e,t){return e.toLowerCase()<t.toLowerCase()?-1:1}).map(function(s){return s.toLowerCase()+":"+e(t[s])}).join("\n")},RequestSigner.prototype.signedHeaders=function(){return Object.keys(this.request.headers).map(function(e){return e.toLowerCase()}).sort().join(";")},RequestSigner.prototype.credentialString=function(){return[this.getDate(),this.region,this.service,"aws4_request"].join("/")},RequestSigner.prototype.defaultCredentials=function(){var e=process.env;return{accessKeyId:e.AWS_ACCESS_KEY_ID||e.AWS_ACCESS_KEY,secretAccessKey:e.AWS_SECRET_ACCESS_KEY||e.AWS_SECRET_KEY,sessionToken:e.AWS_SESSION_TOKEN}},RequestSigner.prototype.parsePath=function(){var e=this.request.path||"/",t=e.indexOf("?"),s=null;t>=0&&(s=querystring.parse(e.slice(t+1)),e=e.slice(0,t)),/[^0-9A-Za-z!'()*\-._~%\/]/.test(e)&&(e=e.split("/").map(function(e){return querystring.escape(querystring.unescape(e))}).join("/")),this.parsedPath={path:e,query:s}},RequestSigner.prototype.formatPath=function(){var e=this.parsedPath.path,t=this.parsedPath.query;return t?(null!=t[""]&&delete t[""],e+"?"+encodeRfc3986(querystring.stringify(t))):e},aws4.RequestSigner=RequestSigner,aws4.sign=function(e,t){return new RequestSigner(e,t).sign()};