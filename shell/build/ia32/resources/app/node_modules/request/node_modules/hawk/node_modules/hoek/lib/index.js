var Crypto=require("crypto"),Path=require("path"),Util=require("util"),Escape=require("./escape"),internals={};exports.clone=function(e,r){if("object"!=typeof e||null===e)return e;r=r||{orig:[],copy:[]};var t=r.orig.indexOf(e);if(-1!==t)return r.copy[t];var n,o=!1;if(Array.isArray(e))n=[],o=!0;else if(Buffer.isBuffer(e))n=new Buffer(e);else if(e instanceof Date)n=new Date(e.getTime());else if(e instanceof RegExp)n=new RegExp(e);else{var a=Object.getPrototypeOf(e);a&&a.isImmutable?n=e:(n=Object.create(a),o=!0)}if(r.orig.push(e),r.copy.push(n),o)for(var s=Object.getOwnPropertyNames(e),i=0,p=s.length;p>i;++i){var u=s[i],f=Object.getOwnPropertyDescriptor(e,u);f&&(f.get||f.set)?Object.defineProperty(n,u,f):n[u]=exports.clone(e[u],r)}return n},exports.merge=function(e,r,t,n){if(exports.assert(e&&"object"==typeof e,"Invalid target value: must be an object"),exports.assert(null===r||void 0===r||"object"==typeof r,"Invalid source value: must be null, undefined, or an object"),!r)return e;if(Array.isArray(r)){exports.assert(Array.isArray(e),"Cannot merge array onto an object"),n===!1&&(e.length=0);for(var o=0,a=r.length;a>o;++o)e.push(exports.clone(r[o]));return e}for(var s=Object.keys(r),i=0,p=s.length;p>i;++i){var u=s[i],f=r[u];f&&"object"==typeof f?!e[u]||"object"!=typeof e[u]||Array.isArray(e[u])^Array.isArray(f)||f instanceof Date||Buffer.isBuffer(f)||f instanceof RegExp?e[u]=exports.clone(f):exports.merge(e[u],f,t,n):null!==f&&void 0!==f?e[u]=f:t!==!1&&(e[u]=f)}return e},exports.applyToDefaults=function(e,r,t){if(exports.assert(e&&"object"==typeof e,"Invalid defaults value: must be an object"),exports.assert(!r||r===!0||"object"==typeof r,"Invalid options value: must be true, falsy or an object"),!r)return null;var n=exports.clone(e);return r===!0?n:exports.merge(n,r,t===!0,!1)},exports.cloneWithShallow=function(e,r){if(!e||"object"!=typeof e)return e;var t=internals.store(e,r),n=exports.clone(e);return internals.restore(n,e,t),n},internals.store=function(e,r){for(var t={},n=0,o=r.length;o>n;++n){var a=r[n],s=exports.reach(e,a);void 0!==s&&(t[a]=s,internals.reachSet(e,a,void 0))}return t},internals.restore=function(e,r,t){for(var n=Object.keys(t),o=0,a=n.length;a>o;++o){var s=n[o];internals.reachSet(e,s,t[s]),internals.reachSet(r,s,t[s])}},internals.reachSet=function(e,r,t){for(var n=r.split("."),o=e,a=0,s=n.length;s>a;++a){var i=n[a];a+1===s&&(o[i]=t),o=o[i]}},exports.applyToDefaultsWithShallow=function(e,r,t){if(exports.assert(e&&"object"==typeof e,"Invalid defaults value: must be an object"),exports.assert(!r||r===!0||"object"==typeof r,"Invalid options value: must be true, falsy or an object"),exports.assert(t&&Array.isArray(t),"Invalid keys"),!r)return null;var n=exports.cloneWithShallow(e,t);if(r===!0)return n;var o=internals.store(r,t);return exports.merge(n,r,!1,!1),internals.restore(n,r,o),n},exports.deepEqual=function(e,r,t,n){t=t||{prototype:!0};var o=typeof e;if(o!==typeof r)return!1;if("object"!==o||null===e||null===r)return e===r?0!==e||1/e===1/r:e!==e&&r!==r;if(n=n||[],-1!==n.indexOf(e))return!0;if(n.push(e),Array.isArray(e)){if(!Array.isArray(r))return!1;if(!t.part&&e.length!==r.length)return!1;for(var a=0,s=e.length;s>a;++a){if(t.part){for(var i=!1,p=0,u=r.length;u>p;++p)if(exports.deepEqual(e[a],r[p],t,n)){i=!0;break}return i}if(!exports.deepEqual(e[a],r[a],t,n))return!1}return!0}if(Buffer.isBuffer(e)){if(!Buffer.isBuffer(r))return!1;if(e.length!==r.length)return!1;for(var f=0,c=e.length;c>f;++f)if(e[f]!==r[f])return!1;return!0}if(e instanceof Date)return r instanceof Date&&e.getTime()===r.getTime();if(e instanceof RegExp)return r instanceof RegExp&&e.toString()===r.toString();if(t.prototype&&Object.getPrototypeOf(e)!==Object.getPrototypeOf(r))return!1;var l=Object.getOwnPropertyNames(e);if(!t.part&&l.length!==Object.getOwnPropertyNames(r).length)return!1;for(var g=0,y=l.length;y>g;++g){var h=l[g],x=Object.getOwnPropertyDescriptor(e,h);if(x.get){if(!exports.deepEqual(x,Object.getOwnPropertyDescriptor(r,h),t,n))return!1}else if(!exports.deepEqual(e[h],r[h],t,n))return!1}return!0},exports.unique=function(e,r){for(var t={},n=[],o=0,a=e.length;a>o;++o){var s=r?e[o][r]:e[o];t[s]!==!0&&(n.push(e[o]),t[s]=!0)}return n},exports.mapToObject=function(e,r){if(!e)return null;for(var t={},n=0,o=e.length;o>n;++n)r?e[n][r]&&(t[e[n][r]]=!0):t[e[n]]=!0;return t},exports.intersect=function(e,r,t){if(!e||!r)return[];for(var n=[],o=Array.isArray(e)?exports.mapToObject(e):e,a={},s=0,i=r.length;i>s;++s)if(o[r[s]]&&!a[r[s]]){if(t)return r[s];n.push(r[s]),a[r[s]]=!0}return t?null:n},exports.contain=function(e,r,t){var n=null;"object"!=typeof e||"object"!=typeof r||Array.isArray(e)||Array.isArray(r)?r=[].concat(r):(n=r,r=Object.keys(r)),t=t||{},exports.assert(arguments.length>=2,"Insufficient arguments"),exports.assert("string"==typeof e||"object"==typeof e,"Reference must be string or an object"),exports.assert(r.length,"Values array cannot be empty");var o,a;if(t.deep){o=exports.deepEqual;var s=t.hasOwnProperty("only"),i=t.hasOwnProperty("part");a={prototype:s?t.only:i?!t.part:!1,part:s?!t.only:i?t.part:!0}}else o=function(e,r){return e===r};for(var p=!1,u=new Array(r.length),f=0,c=u.length;c>f;++f)u[f]=0;if("string"==typeof e){var l="(";for(f=0,c=r.length;c>f;++f){var g=r[f];exports.assert("string"==typeof g,"Cannot compare string reference to non-string value"),l+=(f?"|":"")+exports.escapeRegex(g)}var y=new RegExp(l+")","g"),h=e.replace(y,function(e,t){var n=r.indexOf(t);return++u[n],""});p=!!h}else if(Array.isArray(e))for(f=0,c=e.length;c>f;++f){for(var x=0,v=r.length,b=!1;v>x&&b===!1;++x)b=o(r[x],e[f],a)&&x;b!==!1?++u[b]:p=!0}else{var m=Object.keys(e);for(f=0,c=m.length;c>f;++f){var d=m[f],j=r.indexOf(d);if(-1!==j){if(n&&!o(n[d],e[d],a))return!1;++u[j]}else p=!0}}var w=!1;for(f=0,c=u.length;c>f;++f)if(w=w||!!u[f],t.once&&u[f]>1||!t.part&&!u[f])return!1;return t.only&&p?!1:w},exports.flatten=function(e,r){for(var t=r||[],n=0,o=e.length;o>n;++n)Array.isArray(e[n])?exports.flatten(e[n],t):t.push(e[n]);return t},exports.reach=function(e,r,t){if(r===!1||null===r||"undefined"==typeof r)return e;t=t||{},"string"==typeof t&&(t={separator:t});for(var n=r.split(t.separator||"."),o=e,a=0,s=n.length;s>a;++a){var i=n[a];if("-"===i[0]&&Array.isArray(o)&&(i=i.slice(1,i.length),i=o.length-i),!o||!o.hasOwnProperty(i)||"object"!=typeof o&&t.functions===!1){exports.assert(!t.strict||a+1===s,"Missing segment",i,"in reach path ",r),exports.assert("object"==typeof o||t.functions===!0||"function"!=typeof o,"Invalid segment",i,"in reach path ",r),o=t.default;break}o=o[i]}return o},exports.reachTemplate=function(e,r,t){return r.replace(/{([^}]+)}/g,function(r,n){var o=exports.reach(e,n,t);return void 0===o||null===o?"":o})},exports.formatStack=function(e){for(var r=[],t=0,n=e.length;n>t;++t){var o=e[t];r.push([o.getFileName(),o.getLineNumber(),o.getColumnNumber(),o.getFunctionName(),o.isConstructor()])}return r},exports.formatTrace=function(e){for(var r=[],t=0,n=e.length;n>t;++t){var o=e[t];r.push((o[4]?"new ":"")+o[3]+" ("+o[0]+":"+o[1]+":"+o[2]+")")}return r},exports.callStack=function(e){var r=Error.prepareStackTrace;Error.prepareStackTrace=function(e,r){return r};var t={};Error.captureStackTrace(t,arguments.callee);var n=t.stack;Error.prepareStackTrace=r;var o=exports.formatStack(n);return e?o.slice(e):o},exports.displayStack=function(e){var r=exports.callStack(void 0===e?1:e+1);return exports.formatTrace(r)},exports.abortThrow=!1,exports.abort=function(e,r){if("test"===process.env.NODE_ENV||exports.abortThrow===!0)throw new Error(e||"Unknown error");var t="";r||(t=exports.displayStack(1).join("\n	")),console.log("ABORT: "+e+"\n	"+t),process.exit(1)},exports.assert=function(e){if(!e){if(2===arguments.length&&arguments[1]instanceof Error)throw arguments[1];for(var r=[],t=1,n=arguments.length;n>t;++t)""!==arguments[t]&&r.push(arguments[t]);throw r=r.map(function(e){return"string"==typeof e?e:e instanceof Error?e.message:exports.stringify(e)}),new Error(r.join(" ")||"Unknown error")}},exports.Timer=function(){this.ts=0,this.reset()},exports.Timer.prototype.reset=function(){this.ts=Date.now()},exports.Timer.prototype.elapsed=function(){return Date.now()-this.ts},exports.Bench=function(){this.ts=0,this.reset()},exports.Bench.prototype.reset=function(){this.ts=exports.Bench.now()},exports.Bench.prototype.elapsed=function(){return exports.Bench.now()-this.ts},exports.Bench.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6},exports.escapeRegex=function(e){return e.replace(/[\^\$\.\*\+\-\?\=\!\:\|\\\/\(\)\[\]\{\}\,]/g,"\\$&")},exports.base64urlEncode=function(e,r){var t=Buffer.isBuffer(e)?e:new Buffer(e,r||"binary");return t.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")},exports.base64urlDecode=function(e,r){if(e&&!/^[\w\-]*$/.test(e))return new Error("Invalid character");try{var t=new Buffer(e,"base64");return"buffer"===r?t:t.toString(r||"binary")}catch(n){return n}},exports.escapeHeaderAttribute=function(e){return exports.assert(/^[ \w\!#\$%&'\(\)\*\+,\-\.\/\:;<\=>\?@\[\]\^`\{\|\}~\"\\]*$/.test(e),"Bad attribute value ("+e+")"),e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')},exports.escapeHtml=function(e){return Escape.escapeHtml(e)},exports.escapeJavaScript=function(e){return Escape.escapeJavaScript(e)},exports.nextTick=function(e){return function(){var r=arguments;process.nextTick(function(){e.apply(null,r)})}},exports.once=function(e){if(e._hoekOnce)return e;var r=!1,t=function(){r||(r=!0,e.apply(null,arguments))};return t._hoekOnce=!0,t},exports.isAbsolutePath=function(e,r){return e?Path.isAbsolute?Path.isAbsolute(e):(r=r||process.platform,"win32"!==r?"/"===e[0]:!!/^(?:[a-zA-Z]:[\\\/])|(?:[\\\/]{2}[^\\\/]+[\\\/]+[^\\\/])/.test(e)):!1},exports.isInteger=function(e){return"number"==typeof e&&parseFloat(e)===parseInt(e,10)&&!isNaN(e)},exports.ignore=function(){},exports.inherits=Util.inherits,exports.format=Util.format,exports.transform=function(e,r,t){if(exports.assert(null===e||void 0===e||"object"==typeof e||Array.isArray(e),"Invalid source object: must be null, undefined, an object, or an array"),Array.isArray(e)){for(var n=[],o=0,a=e.length;a>o;++o)n.push(exports.transform(e[o],r,t));return n}for(var s={},i=Object.keys(r),p=0,u=i.length;u>p;++p){var f=i[p],c=f.split("."),l=r[f];exports.assert("string"==typeof l,'All mappings must be "." delineated strings');for(var g,y=s;c.length>1;)g=c.shift(),y[g]||(y[g]={}),y=y[g];g=c.shift(),y[g]=exports.reach(e,l,t)}return s},exports.uniqueFilename=function(e,r){r=r?"."!==r[0]?"."+r:r:"",e=Path.resolve(e);var t=[Date.now(),process.pid,Crypto.randomBytes(8).toString("hex")].join("-")+r;return Path.join(e,t)},exports.stringify=function(){try{return JSON.stringify.apply(null,arguments)}catch(e){return"[Cannot display object: "+e.message+"]"}},exports.shallow=function(e){for(var r={},t=Object.keys(e),n=0,o=t.length;o>n;++n){var a=t[n];r[a]=e[a]}return r};